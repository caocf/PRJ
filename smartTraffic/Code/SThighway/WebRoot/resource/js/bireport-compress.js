if($==undefined){$=jQuery}function crtChart(e){var a=false;var d=false;var b=false;var f=false;if(curTmpInfo.charttype){a=curTmpInfo.charttype=="pie"||curTmpInfo.charttype=="gauge";d=curTmpInfo.charttype=="bubble"||curTmpInfo.charttype=="scatter";b=curTmpInfo.charttype=="bubble";f=curTmpInfo.charttype=="map"}else{var c=findCompById(e);a=c.chartJson.type=="pie"||c.chartJson.type=="gauge";d=c.chartJson.type=="bubble"||c.chartJson.type=="scatter";b=c.chartJson.type=="bubble";f=c.chartJson.type=="map"}if(f){return'<div class="'+(curTmpInfo.chartpos=="left"?"tsbd":"tsbd2")+'"><div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">地域：<div class="h_ctx" id="xcol"><span class="charttip">将地域拖到这里</span></div></div><div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">指标：<div id="ycol" class="h_ctx"><span class="charttip">将指标拖到这里</span></div></div></div><div class="chartctx" style="'+(curTmpInfo.chartpos=="top"?"margin-left:auto":"")+'">图形预览区域</div>'}else{return'<div class="'+(curTmpInfo.chartpos=="left"?"tsbd":"tsbd2")+'">'+(d?'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">'+(a?"观察维度":"横轴")+'：<div id="y2col" class="h_ctx"><span class="charttip">将指标拖到这里</span></div></div>':'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">'+(a?"观察维度":"横轴")+'：<div id="xcol" class="h_ctx"><span class="charttip">将维度拖到这里</span></div></div>')+'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">'+(a?"指标":"纵轴")+'：<div id="ycol" class="h_ctx"><span class="charttip">将指标拖到这里</span></div></div>'+(b?'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">气泡大小：<div id="y3col" class="h_ctx"><span class="charttip">将指标拖到这里</span></div></div>':"")+(d?'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'">观察维度：<div id="xcol" class="h_ctx"><span class="charttip">将维度拖到这里</span></div></div>':"")+(b?"":'<div class="'+(curTmpInfo.chartpos=="left"?"ts_h":"ts_h2")+'" '+(a?'style="display:none"':"")+'>图例：<div id="scol" class="h_ctx"><span class="charttip">将维度拖到这里</span></div></div>')+"</div>"+(a||d||curTmpInfo.chartpos=="top"?"":"<div class=\"exchangexs\"><img src='../resource/img/exchangexs1.gif'><a title='交换维度' href='javascript:exchangexs("+e+", true);'><img src='../resource/img/reload.png' border='0'></a><img src='../resource/img/exchangexs2.gif'></div>")+'<div class="chartctx" style="'+(curTmpInfo.chartpos=="top"?"margin-left:auto;":"")+(d?"height:220px;":"")+'">图形预览区域</div>'}}function addChart(d){curTmpInfo.charttype=d;var c=getMaxCompId();var a="图形组件-";if(d=="line"){a=a+"曲线图"}else{if(d=="column"){a=a+"柱状图"}else{if(d=="pie"){a=a+"饼图"}else{if(d=="gauge"){a=a+"仪表盘"}else{if(d=="radar"){a=a+"雷达图"}else{if(d=="scatter"){a=a+"散点图"}else{if(d=="bubble"){a=a+"气泡图"}else{if(d=="map"){a=a+"地图"}}}}}}}}addComp(c,a,null,true,"chart");var b=findCompById(c);b.chartJson={type:d,xcol:{},ycol:{},scol:{},params:[]}}function insertChart(){$("#pdailog").dialog({title:"插入图形",width:380,height:320,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(curTmpInfo.selectChart==undefined){msginfo("您还未选择图形，请点击图形示意图片，再点确认按钮。")}else{addChart(curTmpInfo.selectChart);delete curTmpInfo.selectChart;$("#pdailog").dialog("close")}}},{text:"取消",iconCls:"icon-cancel",handler:function(){delete curTmpInfo.selectChart;$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","Panel!insertChart.action")}function chartcss(){curTmpInfo.selectChart="line";$(".chartselect .selleft ul li").bind("click",function(){var b=$(this).attr("cid");$(".chartselect .selleft ul li").removeClass("select");$(this).addClass("select");$(".chartselect .selright .one").css("display","none");$("#schart"+b).css("display","block");var a=$("#schart"+b).attr("tp");curTmpInfo.selectChart=a})}function chartview(l,h){if(l.kpiJson==undefined||l.kpiJson.length==0){return}showloading();var b=l.ttype;var c="[]";if(pageInfo.params&&pageInfo.params.length>0){c=JSON.stringify(pageInfo.params)}if(curTmpInfo.face){for(i=0;i<l.kpiJson.length;i++){var n=l.kpiJson[i];delete n.col_name;delete n.unit;delete n.alias;delete n.kpi_name}var g=l.chartJson.xcol;if(g&&!$.isEmptyObject(g)){delete g.dimdesc;delete g.tableName;delete g.tableColKey;delete g.tableColName}var a=l.chartJson.scol;if(a&&!$.isEmptyObject(a)){delete a.dimdesc;delete a.tableName;delete a.tableColKey;delete a.tableColName}var d=l.chartJson.params;if(d&&d.length>0){for(i=0;i<d.length;i++){delete d[i].dimdesc;delete d[i].tableName;delete d[i].tableColKey;delete d[i].tableColName;if(d[i].type=="month"||d[i].type=="day"){}else{delete d[i].valDesc}}}var f=JSON.stringify(l.chartJson);var e=JSON.stringify(l.kpiJson);$.ajax({type:"get",jsonp:"jsonpcallback",url:curTmpInfo.cvUrl?curTmpInfo.cvUrl:"ChartView.action",dataType:"jsonp",data:{chartJson:f,kpiJson:e,kpiType:b,compId:h,params:c,dsource:(l.dsource==null?"":l.dsource)},success:function(o){hideLoading();$("#T"+h+" div.ctx").html(o.ctx);l.chartJson=o.chartJson;l.kpiJson=o.kpiJson},error:function(o){hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}else{var f=JSON.stringify(l.chartJson);var e=JSON.stringify(l.kpiJson);$.ajax({type:"POST",url:"ChartView.action",dataType:"html",data:{chartJson:f,kpiJson:e,kpiType:b,compId:h,params:c,dsource:(l.dsource==null?"":l.dsource)},success:function(o){hideLoading();$("#T"+h+" div.chartctx").css("height","auto");$("#T"+h+" div.chartctx").html(o)},error:function(o){hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}}function initChartKpiDrop(a){$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #scol").droppable({accept:"#datasettree .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);var f=b.attributes.col_type;if(f==1&&($(this).attr("id")=="xcol"||$(this).attr("id")=="scol")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000")}if(f==2&&$(this).attr("id")=="ycol"){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #ycol").css("border-color","#ff0000")}d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,g){var l=$(this).parents(".comp_table").attr("id").replace("T","");var d=findCompById(Number(l));$("#T"+l+" #"+$(this).attr("id")).css("border-color","#7F9DB9");var f=$("#datasettree").tree("getNode",g);h.cancelBubble=true;h.stopPropagation();if(d.tid!=undefined){if(d.tid!=f.attributes.tid){msginfo("您拖入的"+(f.attributes.col_type==2?"指标":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}if(f.attributes.calc_kpi==1){if(!isExistDateDim(d,"chart")){msginfo("您拖入的指标需要图形中有时间类型的维度(年/季度/月/日)。");return}}d.tid=f.attributes.tid;d.tname=f.attributes.tname;d.ttype=f.attributes.ttype;d.dsource=f.attributes.dsource;if(d.kpiJson==undefined){d.kpiJson=[]}if(f.attributes.col_type==1){var c=f.attributes.col_id;if(findDimById(c,d.chartJson.params)!=null){msginfo("您拖放的维度已存在于钻取维中，不能拖放。");return}}if(f.attributes.col_type==2&&$(this).attr("id")=="ycol"){d.kpiJson=[];d.kpiJson.push({kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate});d.chartJson.ycol={type:"kpi"};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycol','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}if(f.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(d.chartJson.scol!=undefined&&d.chartJson.scol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.scol!=undefined&&d.chartJson.scol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分组相同，不能拖放。");return}}d.chartJson.xcol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'xcol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}if(f.attributes.col_type==1&&$(this).attr("id")=="scol"){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分组相同，不能拖放。");return}}d.chartJson.scol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+f.attributes.col_id+", 'scol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}}})}function initChartByScatter(a){$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #y2col, #T"+a+" #y3col, #T"+a+" #scol").droppable({accept:"#datasettree .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);var f=b.attributes.col_type;if(f==1&&($(this).attr("id")=="scol"||$(this).attr("id")=="xcol")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000")}if(f==2&&($(this).attr("id")=="ycol"||$(this).attr("id")=="y2col"||$(this).attr("id")=="y3col")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000")}d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,g){var n=$(this).parents(".comp_table").attr("id").replace("T","");var d=findCompById(Number(n));$("#T"+n+" #"+$(this).attr("id")).css("border-color","#7F9DB9");var f=$("#datasettree").tree("getNode",g);h.cancelBubble=true;h.stopPropagation();if(d.tid!=undefined){if(d.tid!=f.attributes.tid){msginfo("您拖入的"+(f.attributes.col_type==2?"指标":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}if(f.attributes.calc_kpi==1){if(!isExistDateDim(d,"chart")){msginfo("您拖入的指标需要图形中有时间类型的维度(年/季度/月/日)。");return}}d.tid=f.attributes.tid;d.tname=f.attributes.tname;d.ttype=f.attributes.ttype;d.dsource=f.attributes.dsource;if(d.kpiJson==undefined){d.kpiJson=[]}if(f.attributes.col_type==1){var c=f.attributes.col_id;if(findDimById(c,d.chartJson.params)!=null){msginfo("您拖放的维度已存在于钻取维中，不能拖放。");return}}if(f.attributes.col_type==2&&$(this).attr("id")=="ycol"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[1]!=null&&d.kpiJson[1].kpi_id==f.attributes.col_id)||(d.kpiJson[2]!=null&&d.kpiJson[2].kpi_id==f.attributes.col_id)){msginfo("您拖放的指标已存在当前图形中。");return}d.kpiJson[0]={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate};d.chartJson.ycol={type:"kpi"};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycol','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==2&&$(this).attr("id")=="y2col"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[0]!=null&&d.kpiJson[0].kpi_id==f.attributes.col_id)||(d.kpiJson[2]!=null&&d.kpiJson[2].kpi_id==f.attributes.col_id)){msginfo("您拖放的指标已存在当前图形中。");return}var l={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate};d.kpiJson[1]=l;$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'y2col','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==2&&$(this).attr("id")=="y3col"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[0]!=null&&d.kpiJson[0].kpi_id==f.attributes.col_id)||(d.kpiJson[1]!=null&&d.kpiJson[1].kpi_id==f.attributes.col_id)){msginfo("您拖放的指标已存在当前图形中。");return}var l={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate};d.kpiJson[2]=l;$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'y3col','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(d.chartJson.scol!=undefined&&d.chartJson.scol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.scol!=undefined&&d.chartJson.scol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分组相同，不能拖放。");return}}d.chartJson.xcol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'xcol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==1&&$(this).attr("id")=="scol"){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分组相同，不能拖放。");return}}d.chartJson.scol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType};$(this).html('<span title="'+f.text+'" class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+f.attributes.col_id+", 'scol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}}})}function backChartData(a){var c=a.id;if(!$.isEmptyObject(a.chartJson.xcol)){var b=a.chartJson.xcol;$("#T"+c+" #xcol").html('<span title="'+b.dimdesc+'" class="charttxt">'+b.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.id+",'xcol', '"+b.dimdesc+"')\"></span>")}if(!$.isEmptyObject(a.chartJson.ycol)){var b=a.kpiJson[0];$("#T"+c+" #ycol").html('<span title="'+b.kpi_name+'" class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'ycol','"+b.kpi_name+"')\"></span>")}if(a.kpiJson&&(a.chartJson.type=="scatter"||a.chartJson.type=="bubble")){var b=a.kpiJson[1];if(b!=null){$("#T"+c+" #y2col").html('<span title="'+b.kpi_name+'" class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'y2col','"+b.kpi_name+"')\"></span>")}b=a.kpiJson[2];if(b!=null){$("#T"+c+" #y3col").html('<span title="'+b.kpi_name+'" class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'y3col','"+b.kpi_name+"')\"></span>")}}if(!$.isEmptyObject(a.chartJson.scol)){if(a.chartJson.type!="pie"&&a.chartJson.type!="gauge"){var b=a.chartJson.scol;$("#T"+c+" #scol").html('<span title="'+b.dimdesc+'" class="charttxt">'+b.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+b.id+", 'scol', '"+b.dimdesc+"')\"></span>")}}}function chartmenu(b,e,d,a){var c=$(b).offset();curTmpInfo.ckid=e;curTmpInfo.tp=d;curTmpInfo.compId=$(b).parents(".comp_table").attr("id").replace("T","");curTmpInfo.dimname=a;if(d=="ycol"||d=="y2col"||d=="y3col"){$("#chartoptmenu").menu("enableItem",$("#m_set"))}else{$("#chartoptmenu").menu("disableItem",$("#m_set"))}$("#chartoptmenu").menu("show",{left:c.left,top:c.top+20})}function chartsort(d){var c=curTmpInfo.tp;var b=curTmpInfo.compId;var e=curTmpInfo.ckid;var a=findCompById(b);if(c=="xcol"){delete a.kpiJson[0].sort;a.chartJson.xcol.dimord=d}if(c=="ycol"){a.kpiJson[0].sort=d}if(c=="scol"){delete a.kpiJson[0].sort;a.chartJson.scol.dimord=d}curTmpInfo.isupdate=true;chartview(a,b)}function delChartKpiOrDim(){var c=curTmpInfo.tp;var b=curTmpInfo.compId;var d=curTmpInfo.ckid;var a=findCompById(b);if(c=="xcol"){a.chartJson.xcol={};$("#T"+b+" #xcol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(a,b)}if(c=="ycol"){a.chartJson.ycol={};if(a.kpiJson.length>1){a.kpiJson[0]=null}else{a.kpiJson=[]}$("#T"+b+" #ycol").html('<span class="charttip">将指标拖到这里</span>')}if(c=="y2col"){if(a.kpiJson.length>1){a.kpiJson[1]=null}else{a.kpiJson=[]}$("#T"+b+" #y2col").html('<span class="charttip">将指标拖到这里</span>')}if(c=="y3col"){a.kpiJson[2]=null;$("#T"+b+" #y3col").html('<span class="charttip">将指标拖到这里</span>')}if(c=="scol"){a.chartJson.scol={};$("#T"+b+" #scol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(a,b)}}function setChartKpi(){var g=curTmpInfo.tp;if(g=="xcol"||g=="scol"){return}var c=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var d=curTmpInfo.dimname;var b=findCompById(e);var f=null;if(g=="ycol"){f=b.kpiJson[0]}else{if(g=="y2col"){f=b.kpiJson[1]}else{if(g=="y3col"){f=b.kpiJson[2]}}}var a="<div style='line-height:25px; margin:5px;'>指标名称："+f.kpi_name+"<br>所 属 表： "+b.tname+"<br>指标单位：<select id=\"kpiunit\" name=\"kpiunit\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+f.unit+'<br>格 式 化：<select id="fmt" name="fmt"><option value="###,##0">整数</option><option value="###,##0.0">小数</option><option value="0.00%">百分比</option></select></div>';$("#pdailog").dialog({title:"指标属性",width:280,height:260,closed:false,cache:false,modal:true,content:a,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){f.fmt=$("#pdailog #fmt").val();f.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;chartview(b,e)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+f.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+f.rate+"']").attr("selected",true)}function chartfilterDims(){var n=curTmpInfo.tp;var l=curTmpInfo.ckid;var o=curTmpInfo.compId.replace("T","");var b=curTmpInfo.dimname;var g=findCompById(o);var e=null;if(n=="xcol"){e=g.chartJson.xcol}else{if(n=="scol"){e=g.chartJson.scol}else{return kpiFilter("chart")}}$("#pdailog").dialog({title:b+" - 维度筛选",width:280,height:300,closed:false,cache:false,modal:true,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var u=$("#dimfiltertab").tabs("getSelected");var t=$("#dimfiltertab").tabs("getTabIndex",u);if("day"==e.type&&t==0){var s=$("#dimfiltertab #dft2").val();var r=$("#dimfiltertab #dft1").val();if(Number(s.replace(/-/g,""))>Number(r.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}e.startdt=s;e.enddt=r;e.filtertype=1;delete e.vals}else{if("month"==e.type&&t==0){var s=$("#dimfiltertab #dfm2").val();var r=$("#dimfiltertab #dfm1").val();if(Number(s)>Number(r)){msginfo("您选择的开始月份不能大于结束月份。");return}e.startmt=s;e.endmt=r;e.filtertype=1;delete e.vals}else{var v="";var w=$("#pdailog input[name='dimval']:checkbox:checked");w.each(function(y,x){v=v+$(this).val();if(y!=w.size()-1){v=v+","}});e.vals=v;e.filtertype=2;delete e.startmt;delete e.endmt;delete e.startdt;delete e.enddt}}curTmpInfo.isupdate=true;chartview(g,o);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var d=e.type;var c=$("#T"+o+" #datemodbtn");var p=c.attr("st");var f=c.attr("ed");var q=e;var h=e.filtertype==undefined?"":e.filtertype;var a="DimFilter.action?dimType="+d+"&filtertype="+h+"&min="+p+"&max="+f+"&dimId="+l+"&vals="+e.vals;if(d=="month"){a=a+"&dfm2="+(q.startmt==undefined?"":q.startmt);a=a+"&dfm1="+(q.endmt==undefined?"":q.endmt)}if(d=="day"){a=a+"&dft2="+(q.startdt==undefined?"":q.startdt);a=a+"&dft1="+(q.enddt==undefined?"":q.enddt)}$("#pdailog").dialog("refresh",a)}function exchangexs(d,f){var b=findCompById(d);if(b.chartJson==undefined||(b.chartJson.xcol==undefined&&b.chartJson.scol==undefined)){msginfo("您还未选择维度。")}var c=b.chartJson.xcol;b.chartJson.xcol=b.chartJson.scol;b.chartJson.scol=c;if(b.chartJson.xcol&&b.chartJson.xcol.id){var e=b.chartJson.xcol;$("#T"+d+" #xcol").html('<span title="'+(e.dimdesc?e.dimdesc:"")+'" class="charttxt">'+(e.dimdesc?e.dimdesc:"")+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+e.id+",'xcol', '"+e.dimdesc+"')\"></span>")}else{$("#T"+d+" #xcol").html('<span class="charttip">将维度拖到这里</span>')}if(b.chartJson.scol&&b.chartJson.scol.id){var e=b.chartJson.scol;$("#T"+d+" #scol").html('<span title="'+(e.dimdesc?e.dimdesc:"")+'" class="charttxt">'+(e.dimdesc?e.dimdesc:"")+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+e.id+",'scol', '"+e.dimdesc+"')\"></span>")}else{$("#T"+d+" #scol").html('<span class="charttip">将维度拖到这里</span>')}curTmpInfo.isupdate=true;chartview(b,d);if(b.complink&&f){var a=findCompById(b.complink);if(a!=null&&isSameDimsInDrill(a,b)){curTmpInfo.compId="T"+a.id;changecolrow(false)}}}function formatNumber(h,p){if(p.indexOf("%")>0){h=h*100}var b=p?p.split("."):[""];var o="";var t=0;if(b.length>1){t=b[1].length}var d=1;for(g=0;g<t;g++){d=d*10}h=h*d;h=Math.round(h);h=h/d;var s=h?h.toString().split("."):["0"];var q=s[0];var c=b[0];var g=q.length-1;var u=false;for(var n=c.length-1;n>=0;n--){switch(c.substr(n,1)){case"#":if(g>=0){o=q.substr(g--,1)+o}break;case"0":if(g>=0){o=q.substr(g--,1)+o}else{o="0"+o}break;case",":u=true;o=","+o;break}}if(g>=0){if(u){var e=q.length;for(;g>=0;g--){o=q.substr(g,1)+o;if(g>0&&((e-g)%3)==0){o=","+o}}}else{o=q.substr(0,g+1)+o}}o=o+".";q=s.length>1?s[1]:"";c=b.length>1?b[1]:"";g=0;for(var n=0;n<c.length;n++){switch(c.substr(n,1)){case"#":if(g<q.length){o+=q.substr(g++,1)}break;case"0":if(g<q.length){o+=q.substr(g++,1)}else{o+="0"}break}}var a=o.replace(/^,+/,"").replace(/\.$/,"");if(p.indexOf("%")>0){a=a+"%"}return a}function crtChartfromTab(){var compId=curTmpInfo.compId.replace("T","");var comp=findCompById(compId);var rows="";for(i=0;i<comp.tableJson.rows.length;i++){var selected="";if(i==comp.tableJson.rows.length-1){selected="selected"}rows=rows+"<option value='"+comp.tableJson.rows[i].id+"' "+selected+">"+comp.tableJson.rows[i].dimdesc+"</option>"}var cols="";for(i=0;i<comp.tableJson.cols.length;i++){var selected="";if(i==comp.tableJson.cols.length-1){selected="selected"}cols=cols+"<option value='"+comp.tableJson.cols[i].id+"' "+selected+">"+comp.tableJson.cols[i].dimdesc+"</option>"}var ctx="<div style='line-height:25px; margin:5px;'>类型：<select id='charttype'><option value='line'>曲线图</option><option value='column'>柱状图</option><option value='pie'>饼图</option><option value='radar'>雷达图</option></select><br>横轴：<select id='hz'>"+rows+"</select><br/>图例：<select id='zz'>"+cols+"</select></div>";$("#pdailog").dialog({title:"通过表格数据生成图形",width:220,height:200,closed:false,cache:false,modal:true,content:ctx,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var tp=$("#charttype").val();var xcol=$("#hz").val();var scol=$("#zz").val();var kpi=curTmpInfo.ckid;$("#pdailog").dialog("close");var chart={id:getMaxCompId(),name:"图形组件",type:"chart",chartJson:{type:tp,ycol:{type:"kpi"},params:[]},tid:comp.tid,tname:comp.tname,ttype:comp.ttype,kpiJson:[],dsource:comp.dsource,complink:comp.id};comp.complink=chart.id;var k=eval("("+JSON.stringify(findKpiById(kpi,comp.kpiJson))+")");chart.kpiJson.push(k);if(xcol!=null&&xcol!=""){chart.chartJson.xcol=eval("("+JSON.stringify(findDimById(xcol,comp.tableJson.rows))+")")}if(scol!=null&&scol!=""){chart.chartJson.scol=eval("("+JSON.stringify(findDimById(scol,comp.tableJson.cols))+")")}for(k=0;k<comp.tableJson.rows.length;k++){if(comp.tableJson.rows[k].id==xcol||comp.tableJson.rows[k].id==scol){}else{chart.chartJson.params.push(comp.tableJson.rows[k])}}for(k=0;k<comp.tableJson.cols.length;k++){if(comp.tableJson.cols[k].id==xcol||comp.tableJson.cols[k].id==scol){}else{chart.chartJson.params.push(comp.tableJson.cols[k])}}curTmpInfo.isupdate=true;curTmpInfo.charttype=tp;addComp(chart.id,chart.name,null,false,chart.type,chart);pageInfo.comps.push(chart);var p=$("#T"+chart.id).offset();$("#optarea").scrollTop(p.top)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}if($==undefined){$=jQuery}function drill(g,h,f,b,c,a,l){var e=findCompById(h);var d=function(){var s=null;if(f=="row"){s=e.tableJson.rows}else{s=e.tableJson.cols}if(e.complink&&l){var p=findCompById(e.complink);if(p!=null&&isSameDimsInDrill(e,p)){drillingChart(g,p.id,f,b,c,a,false)}}var n=null;var o=0;for(i=0;i<s.length;i++){if(s[i].id==a){o=i;if(pageInfo.drillset=="2"){}else{s[i].vals=b;if(s[i].type=="month"){s[i].filtertype=1;s[i].startmt=b;s[i].endmt=b;delete s[i].vals;n=s[i]}if(s[i].type=="day"){s[i].filtertype=1;s[i].startdt=b.substring(0,4)+"-"+b.substring(4,6)+"-"+b.substring(6,8);s[i].enddt=s[i].startdt;delete s[i].vals;n=s[i]}}}}var q=null;for(j=0;j<e.dims.length;j++){if(e.dims[j].dim_id==g){q=e.dims[j];break}}var r={id:q.dim_id,dimdesc:q.dim_desc,type:q.dim_type,colname:q.col_name,tid:q.tid,iscas:"",tableName:(q.dim_tname==null?"":q.dim_tname),tableColKey:(q.tableColKey==null?"":q.tableColKey),tableColName:(q.tableColName==null?"":q.tableColName),dimord:q.dim_ord,dim_name:q.dim_name,iscas:(q.iscas==null?"":q.iscas),grouptype:q.grouptype,valType:q.valType,endlvl:q.endlvl};s.splice(o+1,0,r);curTmpInfo.isupdate=true;tableView(e,e.id)};if(!e.dims){if(curTmpInfo.face){$.ajax({async:false,type:"get",jsonp:"jsonpcallback",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDimsByFace.action",data:{tableId:e.tid},dataType:"jsonp",success:function(n){e.dims=n;d()}})}else{$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDims.action",data:{tableId:e.tid},dataType:"json",success:function(n){e.dims=n;d()}})}}else{d()}}function openTheDim(e,h,g,d,a){var c=findCompById(e);var b=findDimById(a,h=="row"?c.tableJson.rows:c.tableJson.cols);if(b.grouptype==null){msginfo("维度无下级层次。");return}var f=function(o){var n=0;for(i=0;i<o.length;i++){if(o[i].dim_id==a){if(i<o.length-1&&o[i+1].grouptype==o[i].grouptype){var l=o[i+1];if(dimExist(l.dim_id,c.tableJson.cols)||dimExist(l.dim_id,c.tableJson.rows)){n=2;break}drill(l.dim_id,e,h,g,d,a,true);n=1;break}}}if(n==0){msginfo("维度无下级层次。")}else{if(n==2){msginfo("维度下级层次已经展开。")}}};if(!c.dims){if(curTmpInfo.face){$.ajax({async:false,type:"get",jsonp:"jsonpcallback",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDimsByFace.action",data:{tableId:c.tid},dataType:"jsonp",success:function(l){c.dims=l;f(c.dims)}})}else{$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDims.action",data:{tableId:c.tid},dataType:"json",success:function(l){c.dims=l;f(c.dims)}})}}else{f(c.dims)}}function drillDim(n,h,l,d,e,c){var g=findCompById(n);var f=$(h).offset();var b=findDimById(c,l=="row"?g.tableJson.rows:g.tableJson.cols);var a=function(v){$("#drillmenu").remove();var u="<div id=\"drillmenu\"><div class='menu-line'></div>";var r=0;var t="";var q=[];var s=function(w,y){var x=false;for(k=0;k<w.length;k++){if(w[k]==y){x=true}}return x};for(i=0;i<v.length;i++){if(dimExist(v[i].dim_id,g.tableJson.cols)||dimExist(v[i].dim_id,g.tableJson.rows)){if(v[i].grouptype!=null){q.push(v[i].grouptype)}}}for(i=0;i<v.length;i++){if(dimExist(v[i].dim_id,g.tableJson.cols)||dimExist(v[i].dim_id,g.tableJson.rows)){continue}var p=v[i].grouptype;if(s(q,p)){continue}if(v[i].grouptype!=null&&v[i].grouptype==b.grouptype){continue}if(t==""){t=v[i].grouptype}else{if(v[i].grouptype!=t){u=u+'<div class="menu-sep"></div>';t=v[i].grouptype}}var o=v[i].dim_id;u=u+'<div id="'+o+'" onclick="drill('+o+", "+g.id+", '"+l+"', '"+d+"', '"+e+"', '"+c+'\', true)"><span style="color:#ccc">下钻</span>'+v[i].dim_desc+"</div>";r=r+1}u=u+"</div>";if(r==0){msginfo("数据已钻透。");return}$(u).appendTo("body");$("#drillmenu").menu();$("#drillmenu").menu("show",{left:f.left,top:f.top+20})};if(g.dims){a(g.dims)}else{if(curTmpInfo.face){$.ajax({async:false,type:"get",jsonp:"jsonpcallback",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDimsByFace.action",data:{tableId:g.tid},dataType:"jsonp",success:function(o){g.dims=o;a(g.dims)}})}else{$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDims.action",data:{tableId:g.tid},dataType:"json",success:function(o){g.dims=o;a(g.dims)}})}}}function goupDim(l,d,e,h,n){var g=null;var c=findCompById(l);if(e=="row"){g=c.tableJson.rows}else{g=c.tableJson.cols}if(c.complink&&n){var b=findCompById(c.complink);if(b!=null&&isSameDimsInDrill(c,b)){chartGoupDim(b.id,h,e,false)}}var f=0;for(i=0;i<g.length;i++){if(g[i].id==h){g[i].vals="";if(g[i].type=="day"){delete g[i].startdt;delete g[i].enddt}if(g[i].type=="month"){delete g[i].startmt;delete g[i].endmt}f=i;break}}g.splice(f+1,g.length-1);if(!isExistDateDim(c,"table")){for(var a=0;c.kpiJson&&a<c.kpiJson.length;a++){delete c.kpiJson[a].compute}}if(!paramsamedimdate(c)){for(var a=0;c.kpiJson&&a<c.kpiJson.length;a++){delete c.kpiJson[a].compute}}curTmpInfo.isupdate=true;tableView(c,c.id)}function drillChart(h,f,n,b,l,o,c){var g=findCompById(o);var e=l;var d=function(s){var p=g.chartJson.xcol;if(p.grouptype==null){msginfo("维度无下级层次。");return}var r=0;for(i=0;i<s.length;i++){if(s[i].dim_id==c){if(i<s.length-1&&s[i+1].grouptype==s[i].grouptype){var q=s[i+1];drillingChart(q.dim_id,o,"row",h,f,c,true);r=1;break}}}if(r==0){msginfo("维度无下级层次。")}else{if(r==2){msginfo("维度下级层次已经展开。")}}};var a=function(w){$("#drillmenu").remove();var v="<div id=\"drillmenu\"><div class='menu-line'></div>";var s=0;var u="";var r=[];var t=function(x,z){var y=false;for(k=0;k<x.length;k++){if(x[k]==z){y=true}}return y};for(i=0;i<w.length;i++){if(dimExist(w[i].dim_id,g.chartJson.params)||(g.chartJson.xcol&&w[i].dim_id==g.chartJson.xcol.id)||(g.chartJson.scol&&w[i].dim_id==g.chartJson.scol.id)){if(w[i].grouptype!=null){r.push(w[i].grouptype)}}}for(i=0;i<w.length;i++){if(dimExist(w[i].dim_id,g.chartJson.params)||(g.chartJson.xcol&&w[i].dim_id==g.chartJson.xcol.id)||(g.chartJson.scol&&w[i].dim_id==g.chartJson.scol.id)){continue}var q=w[i].grouptype;if(t(r,q)){continue}if(u==""){u=w[i].grouptype}else{if(w[i].grouptype!=u){v=v+'<div class="menu-sep"></div>';u=w[i].grouptype}}var p=w[i].dim_id;v=v+'<div id="'+p+'" onclick="drillingChart('+p+", "+g.id+", 'row', '"+h+"', '"+f+"', '"+c+'\', true)"><span style="color:#ccc">下钻</span>'+w[i].dim_desc+"</div>";s=s+1}if(s==0){msginfo("数据已钻透。");return}$(v).appendTo("body");$("#drillmenu").menu();$("#drillmenu").menu("show",{left:e.left,top:e.top+10})};if(g.dims){a(g.dims)}else{if(curTmpInfo.face){$.ajax({async:false,type:"get",jsonp:"jsonpcallback",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDimsByFace.action",data:{tableId:g.tid},dataType:"jsonp",success:function(p){g.dims=p;a(g.dims)}})}else{$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDims.action",data:{tableId:g.tid},dataType:"json",success:function(p){g.dims=p;a(g.dims)}})}}}function drillingChart(b,o,n,l,g,a,q){var h=findCompById(o);if(!h.dims){$.ajax({async:false,type:"POST",url:curTmpInfo.qdimUrl?curTmpInfo.qdimUrl:"Dim!queryDims.action",data:{tableId:h.tid},dataType:"json",success:function(r){h.dims=r}})}if(n=="row"){h.chartJson.xcol.vals=l+"";h.chartJson.xcol.valDesc=g;h.chartJson.xcol.pos="row"}else{h.chartJson.scol.vals=l+"";h.chartJson.scol.valDesc=g;h.chartJson.scol.pos="col"}if(h.complink&&q){var d=findCompById(h.complink);if(d!=null&&isSameDimsInDrill(d,h)){drill(b,d.id,"row",l,g,a,false)}}var f=n=="row"?h.chartJson.xcol:h.chartJson.scol;f.filtertype=2;if(f.type=="month"){delete f.startmt;delete f.endmt}if(f.type=="day"){delete f.startdt;delete f.enddt}if(l=="合计"&&g=="合计"){}else{h.chartJson.params.push(n=="row"?h.chartJson.xcol:h.chartJson.scol)}var p=null;for(j=0;j<h.dims.length;j++){if(h.dims[j].dim_id==b){p=h.dims[j];break}}var e={id:p.dim_id,dimdesc:p.dim_desc,type:p.dim_type,colname:p.col_name,tid:p.tid,iscas:"",tableName:(p.dim_tname==null?"":p.dim_tname),tableColKey:(p.tableColKey==null?"":p.tableColKey),tableColName:(p.tableColName==null?"":p.tableColName),dimord:p.dim_ord,dim_name:p.dim_name,iscas:(p.iscas==null?"":p.iscas),grouptype:p.grouptype,valType:p.valType};if(n=="row"){h.chartJson.xcol=e}else{h.chartJson.scol=e}var c=e;$("#T"+h.id+(n=="row"?" #xcol":" #scol")).html('<span class="charttxt">'+c.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+c.id+","+(n=="row"?"'xcol'":"'scol'")+", '"+c.dimdesc+"')\"></span>");curTmpInfo.isupdate=true;chartview(h,h.id)}function chartGoupDim(l,g,d,n){var c=findCompById(l);var e=c.chartJson.params;if(c.complink&&n){var b=findCompById(c.complink);if(b!=null&&isSameDimsInDrill(b,c)){goupDim(b.id,null,d,g,false)}}var f=0;var h=null;for(i=0;i<e.length;i++){if(e[i].id==g){e[i].vals="";e[i].valDesc="";delete e[i].filtertype;f=i;h=e[i];break}}if(d=="row"){c.chartJson.xcol=h}else{c.chartJson.scol=h}e.splice(f,e.length);var a=h;$("#T"+c.id+(d=="row"?" #xcol":" #scol")).html('<span class="charttxt">'+a.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+a.id+","+(d=="row"?"'xcol'":"'scol'")+", '"+a.dimdesc+"')\"></span>");curTmpInfo.isupdate=true;chartview(c,c.id)}function isSameDimsInDrill(f,e){var d=f.tableJson;var b=e.chartJson;var g=d.cols.length+d.rows.length;var c=(b.params?b.params.length:0)+($.isEmptyObject(b.xcol)?0:1)+($.isEmptyObject(b.scol)?0:1);if(g!=c){return false}var a=true;for(i=0;b.params&&i<b.params.length;i++){if(!dimExist(b.params[i].id,d.cols)&&!dimExist(b.params[i].id,d.rows)){return false}}if(!$.isEmptyObject(b.xcol)){if(!dimExist(b.xcol.id,d.cols)&&!dimExist(b.xcol.id,d.rows)){return false}}if(!$.isEmptyObject(b.scol)){if(!dimExist(b.scol.id,d.cols)&&!dimExist(b.scol.id,d.rows)){return false}}return a}if($==undefined){$=jQuery}var customComp=customComp||window.customComp||{};function reloadDatasetTree(){$("#datasettreediv ul").remove();$("#datasettreediv").append('<ul id="datasettree"></ul>');if(pageInfo.selectDs==null||pageInfo.selectDs=="null"){$("#datasettree").tree({dnd:false,data:[{id:"err",text:"数据还未创建立方体。",iconCls:"icon-no"}]});return}else{if(pageInfo.selectDs==""){$("#datasettree").tree({dnd:false,data:[{id:"err",text:"还未选择数据。",iconCls:"icon-no"}]});return}else{$("#datasettree").tree({url:"DataSet!tree.action?selectDsIds="+pageInfo.selectDs,dnd:true,lines:true,onBeforeDrag:function(a){if(!a.attributes||a.attributes.tp=="root"){return false}return true},onDragEnter:function(b,a){return false}})}}}function newpage(){var a="ReportDesign.action?menus="+curTmpInfo.menus+"&showtit="+showtit;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(true,function(){location.href=a})}else{location.href=a}}else{location.href=a}}function initparam(){if(pageInfo.params&&pageInfo.params.length>0){$("#optarea #p_param div.ptabhelpr").remove();$("#optarea #p_param").append("");for(i=0;i<pageInfo.params.length;i++){var a=$("#optarea #p_param");var b='<span class="pppp" id="pa_'+pageInfo.params[i].id+'"><span title="筛选" onclick="paramFilter(\''+pageInfo.params[i].id+"', '"+pageInfo.params[i].type+"', '"+pageInfo.params[i].name+'\')" class="text">'+pageInfo.params[i].name+"(";if(pageInfo.params[i].type=="frd"||pageInfo.params[i].type=="year"||pageInfo.params[i].type=="quarter"){b=b+(!pageInfo.params[i].valStrs||pageInfo.params[i].valStrs==""?"无":pageInfo.params[i].valStrs)}else{b=b+pageInfo.params[i].st+" 至 "+pageInfo.params[i].end}b=b+')</span><a class="one_p" title="删除" onclick="deleteParam(\''+pageInfo.params[i].id+'\')" href="javascript:;" style="opacity: 0.6;"> &nbsp; </a></span>';a.append(b)}}$("#optarea #p_param").droppable({accept:"#datasettree .tree-node",onDragEnter:function(f,d){var c=$("#datasettree").tree("getNode",d);var g=c.attributes.col_type;if(g==1){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000")}f.cancelBubble=true;f.stopPropagation()},onDragLeave:function(d,c){$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","1px dotted #999999");d.cancelBubble=true;d.stopPropagation()},onDrop:function(h,d){h.cancelBubble=true;h.stopPropagation();$(this).css("border","1px dotted #999999");var c=$("#datasettree").tree("getNode",d);var l=c.attributes.col_type;if(l==1){if(!pageInfo.params){pageInfo.params=[]}if(findParamById(c.attributes.col_id)!=null){msginfo("您已经添加了该参数！");return}var n=c.attributes.col_id;var g={id:n,name:c.text,type:c.attributes.dim_type,colname:c.attributes.alias,tid:c.attributes.tid,valType:c.attributes.valType,tableName:c.attributes.tableName,tableColKey:c.attributes.tableColKey,tableColName:c.attributes.tableColName,dimord:c.attributes.dimord,grouptype:c.attributes.grouptype};pageInfo.params.push(g);var f=$(this);f.find("div.ptabhelpr").remove();if(f.find("b").size()==0){f.append("")}f.append('<span class="pppp" id="pa_'+n+'"><span title="筛选" onclick="paramFilter(\''+n+"', '"+c.attributes.dim_type+"','"+c.text+'\')" class="text">'+c.text+'(无)</span><a class="one_p" title="删除" onclick="deleteParam(\''+n+'\')" href="javascript:;" style="opacity: 0.6;"> &nbsp; </a></span>');initviewTree();paramFilter(n,g.type,g.name)}}})}function paramFilter(e,c,b){var d=findParamById(e);$("#pdailog").dialog({title:b+" - 参数值筛选",width:240,height:240,closed:false,cache:false,modal:true,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var g="";var f="";if(d.type=="frd"||d.type=="year"||d.type=="quarter"){var h=$("#pdailog input[name='dimval']:checkbox:checked");h.each(function(n,l){g=g+$(this).val();if(n!=h.size()-1){g=g+","}f=f+$(this).attr("desc");if(n!=h.size()-1){f=f+","}});$("#optarea #p_param #pa_"+e+" span.text").text(b+"("+(f==""?"无":f)+")");d.vals=g;d.valStrs=f}else{if(d.type=="month"){d.st=$("#pdailog #dfm2").val();d.end=$("#pdailog #dfm1").val();if(Number(d.st)>Number(d.end)){msginfo("您选择的开始月份不能大于结束月份。");return}$("#optarea #p_param #pa_"+e+" span.text").text(b+"("+d.st+" 至 "+d.end+")")}else{if(d.type=="day"){d.st=$("#pdailog #dft2").val();d.end=$("#pdailog #dft1").val();if(Number(d.st.replace(/-/g,""))>Number(d.end.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}$("#optarea #p_param #pa_"+e+" span.text").text(b+"("+d.st+" 至 "+d.end+")")}}}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;flushPage()}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var a=(curTmpInfo.filterUrl?curTmpInfo.filterUrl:"DimFilter!paramFilter.action")+"?dimType="+c+"&dfm2="+(d.st?d.st:"")+"&dfm1="+(d.end?d.end:"")+"&dft2="+(d.st?d.st:"")+"&dft1="+(d.end?d.end:"")+"&tid="+(d.tid)+"&dimId="+e+"&vals="+(!d.vals||d.vals==""?"":d.vals);$("#pdailog").dialog("refresh",a)}function flushPage(){for(var b=0;pageInfo.comps&&b<pageInfo.comps.length;b++){var c=pageInfo.comps[b].type;if(c=="table"){var a=pageInfo.comps[b];if(!paramsamedimdate(a)){for(i=0;a.kpiJson&&i<a.kpiJson.length;i++){delete a.kpiJson[i].compute}}tableView(pageInfo.comps[b],pageInfo.comps[b].id)}else{if(c=="chart"){chartview(pageInfo.comps[b],pageInfo.comps[b].id)}}}}function deleteParam(c){$("#optarea #p_param #pa_"+c).remove();var a=-1;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var b=pageInfo.params[i];if(b.id==c){a=i;break}}pageInfo.params.splice(a,1);if(pageInfo.params.length==0){$("#optarea #p_param").html('<div class="ptabhelpr">拖拽维度到此处作为页面参数</div>')}initviewTree();flushPage()}function initviewTree(){var e=[{text:"页面参数",id:"param",state:"open",iconCls:"icon-param"},{text:"页面组件",id:"comp",state:"open"}];if(pageInfo.params){e[0].children=[];for(var c=0;c<pageInfo.params.length;c++){var f=pageInfo.params[c];e[0].children.push({text:f.name,id:f.id,iconCls:"icon-param",attributes:{showmenu:false,type:"param"}})}}if(pageInfo.comps){e[1].children=[];for(var b=0;b<pageInfo.comps.length;b++){var a=pageInfo.comps[b];var f={text:a.name,id:a.id,attributes:{showmenu:true,type:"compview"}};var d=a.type;if(d=="chart"){f.iconCls="icon-chart"}else{if(d=="table"){f.iconCls="icon-cross"}else{if(d=="text"){f.iconCls="icon-label"}}}e[1].children.push(f)}}$("#viewtree").tree({data:e,onContextMenu:function(h,g){h.preventDefault();if(!g.attributes||g.attributes.showmenu!=true||g.attributes.type=="compview"){return}curTmpInfo.tp=g.attributes.type;curTmpInfo.id=g.id;$("#viewtree").tree("select",g.target);$("#mydatasetmenu").menu("show",{left:h.pageX,top:h.pageY})},onClick:function(g){if(g.attributes.type=="compview"){compBorderSet($("#"+g.id));setProp($("#"+g.id).parent().attr("id").split("_")[1],g.id)}}})}function openreport(){var a='<div class="openlistbody"><div style="margin:5px 5px 5px 1px;">报表目录： <input id="cataSelect" style="width:200px;"></div><div class="openlist"></div></div>';$("#pdailog").dialog({title:"打开报表",width:620,height:400,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var c=$('input[name="reportId"]:checked').val();if(!c||c==null){msginfo("请至少选择一个报表！");return}$("#pdailog").dialog("close");$(this).attr("href","#");var b="ReportDesign.action?pageId="+c+"&showtit="+showtit+"&menus="+curTmpInfo.menus;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(true,function(){location.href=b})}else{location.href=b}}else{location.href=b}}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#cataSelect").combotree({url:"../report/ReportCatalog!tree.action?type=1",onClick:function(b){$("#pdailog .openlist").load("MyReport!list.action?cataId="+b.id+"&t="+Math.random())}});$("#pdailog .openlist").load("MyReport!list.action?t="+Math.random())}function delComp(c){var a=-1;for(i=0;i<pageInfo.comps.length;i++){var b=pageInfo.comps[i];if(b.id==c){a=i;break}}pageInfo.comps.splice(a,1);$("#T"+c).remove();if(pageInfo.comps.length==0){$("#optarea").append("<div class='tabhelpr'>请先添加组件再进行多维分析(点击<strong>插入</strong>按钮)。</div>")}initviewTree()}function addComp(d,a,q,o,n,h,l,e){var f=[];if(pageInfo.comps.length==0){$("#optarea .tabhelpr").remove()}if(q==null||q==undefined){if(n=="table"){if(h==null||h==undefined){q=crtCrossTable()}else{if(h.tableJson==undefined||h.kpiJson==undefined){q=crtCrossTable()}else{q=""}}}else{if(n=="chart"){q=crtChart(d)}}}if(o==true){pageInfo.comps.push({id:d,name:a,type:n,customCompType:e});curTmpInfo.isupdate=true;initviewTree()}var c='<div class="comp_table" tp="'+n+'" id="T'+d+'"><div class="title"><div title="双击改名" class="tname">'+a+'</div><div title="移动组件" class="mvcomp"><table border-spacing="0" style="width:100%"><tr><td align="right"><a href="#" pid='+d+' class="easyui-linkbutton moveComponent" data-options="width:16,height:16,plain:true" iconCls="icon-moveComponent" title="移动组件"></a><a href="#" onclick="delComp('+d+')" pid='+d+' class="easyui-linkbutton" data-options="width:16,height:16,plain:true" iconCls="icon-removeComponent"  title="移除组件"></a></td></tr></table></div></div><div class="ctx"'+(n=="text"?'title="双击修改文本内容"':"")+">"+(q==null?"":q)+"</div></div>";$(c).appendTo("#optarea");if(n=="table"){f=[];if(h!=null&&h!=undefined){if(h.tableJson==undefined||h.kpiJson==undefined){initDropDiv(d)}else{tableView(h,d)}}else{initDropDiv(d)}}if(n=="chart"){if(h!=null&&h!=undefined){chartview(h,d);backChartData(h);if(h.chartJson.type=="bubble"||h.chartJson.type=="scatter"){initChartByScatter(d)}else{initChartKpiDrop(d)}}else{if(curTmpInfo.charttype=="bubble"||curTmpInfo.charttype=="scatter"){initChartByScatter(d)}else{initChartKpiDrop(d)}}}if(n=="customComp"){var r=customComp[e].renderCmpName;var g=customComp[e].tools||[];$.each(g,function(t,v){var s={text:v.text,iconCls:v.iconCls,plain:true};var u=JSON.stringify(s);u=u.replace(/\"/g,'"');var p='<a href="#" class="easyui-linkbutton componet-" data-options="'+s+'">{}</a>';f.push(p)});jd.ModuleMgr.require([r],function(){$("#T"+d+" div.ctx")[r](h).css({height:""})})}if(f.length>0){f=f.join("");$("#T"+d+" .title .moveComponent").before(f)}$.parser.parse($("#T"+d+" .title"));if(n=="text"){$("#T"+d+" div.ctx").bind("dblclick",function(){insertText("update",d)})}liveCompMoveEvent(d);if(h==null||h==undefined){var b=$("#T"+d).offset();$("#optarea").scrollTop(b.top)}}function getMaxCompId(){var a=1;for(i=0;i<pageInfo.comps.length;i++){var b=pageInfo.comps[i];if(b.id>a){a=b.id}}return a+1}function insertText(c,b){$("#pdailog").dialog({title:"请输入文本内容 - 文本组件",width:490,height:226,closed:false,cache:false,modal:true,toolbar:null,content:'<div class="txtctxdiv"><textarea name="txtctx" id="txtctx" cols="84" rows="8"></textarea></div>',buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(c=="insert"){var d=$("#txtctx").val().replace(/\n/g,"<br>");var e=getMaxCompId();addComp(e,"文本组件",d,true,"text");findCompById(e).text=$("#txtctx").val()}if(c=="update"){var f=findCompById(b);f.text=$("#txtctx").val();$("#T"+b+" div.ctx").html($("#txtctx").val().replace(/\n/g,"<br>"));curTmpInfo.isupdate=true}$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});if(b){var a=findCompById(b);$("#txtctx").val(a.text)}$("#txtctx").focus()}function selectdataset(){$("#pdailog").dialog({title:"选择分析主题",width:620,height:400,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px;float:left;">主题分类： <input id="subjectCubeSelect" style="width:200px;"></div><div align="right" style="margin:5px;"><input id="subSearchBox" style="width:160px"></input></div><table id="subjectlist" title="" style="width:610px;height:300px;" ><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:160">名称</th><th data-options="field:\'fl\',width:100">分类</th><th data-options="field:\'note\',width:300">说明</th></tr></thead></table>',buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var a=$("#subjectlist").datagrid("getChecked");if(a==null||a.length==0){msginfo("请勾选数据。");return}pageInfo.selectDs=a[0].defTid;$("#pdailog").dialog("close");curTmpInfo.isupdate=true;reloadDatasetTree()}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#subjectCubeSelect").combotree({url:"../report/SubjectManager!tree.action",onClick:function(a){$("#subjectlist").datagrid("load",{id:a.id,t:Math.random()})}});$("#subSearchBox").searchbox({searcher:function(b,a){$("#subjectlist").datagrid("load",{id:"0",key:b,t:Math.random()})},prompt:"请输入查询关键字."});$("#subjectlist").datagrid({singleSelect:true,collapsible:false,pagination:true,pageSize:20,border:true,url:"../report/SubjectManager!listSubject.action",method:"post",queryParams:{id:"0",t:Math.random()}})}function resortComp(){var a=pageInfo.comps;pageInfo.comps=[];$("#optarea").children().each(function(b,c){if($(this).hasClass("comp_table")){var d=Number($(this).attr("id").replace("T",""));for(i=0;i<a.length;i++){if(a[i].id==d){pageInfo.comps.push(a[i]);delete a[i].dims;break}}}})}function saveas(){resortComp();for(k=0;k<pageInfo.comps.length;k++){var c=pageInfo.comps[k];var e=c.type,f=c.id,d=c.customCompType}var a=JSON.stringify(pageInfo);var b='<div style="margin:10px 20px 5px 20px;"><span style="display:inline-block;width:60px;"> 名 称： </span><input type="text" style="width:187px;" id="pageName"><div style="margin-top:5px;"><table cellspacing="0" cellpadding="0"><tr><td valign="top"><span style="display:inline-block;width:60px;"> 目 录：</span></td><td><ul id="reportcatalist"></ul></td></tr></table></div></div>';$("#pdailog").dialog({title:"另存报表",width:330,height:260,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var g=$("#pdailog #pageName").val();if(g==""){msginfo("您还未录入文件名称。");$("#pdailog #pageName").focus();return}var h=$("#reportcatalist").tree("getSelected");if(h==null||h.id=="0"){msginfo("您还未选择报表目录。");return}$.post("../report/Report!newSave.action",{pageInfo:a,pageId:"",pageName:g,cataId:h.id},function(l){if(l=="no"){msginfo("另存失败，名称存在重复。");return}msginfo("报表另存成功！","suc");$("#pdailog").dialog("close")})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #reportcatalist").tree({url:"../report/ReportCatalog!tree.action?type=1",dnd:false,data:[{id:"0",text:"报表目录",state:"closed"}],onBeforeLoad:function(g){if(!g||g==null){return false}}});$("#reportcatalist").tree("expand",$("#reportcatalist").tree("getRoot").target)}function savepage(h,e){resortComp();for(k=0;k<pageInfo.comps.length;k++){var l=pageInfo.comps[k];var n=l.type,a=l.id,f=l.customCompType;if(n=="customComp"){var p=customComp[f].renderCmpName;var d=customComp[f].cfgGetter||"getCmpCfg";var g=$("#T"+a+" div.ctx")[p](d);pageInfo.comps[k].json=g}}var b=JSON.stringify(pageInfo);var c=pageInfo.id;if(c==undefined||c==null){c=""}if(c==""){var o='<div style="margin:10px 20px 5px 20px;"><span style="display:inline-block;width:60px;"> 名 称： </span><input type="text" style="width:187px;" id="pageName"><div style="margin-top:5px;"><table cellspacing="0" cellpadding="0"><tr><td valign="top"><span style="display:inline-block;width:60px;"> 目 录：</span></td><td><ul id="reportcatalist"></ul></td></tr></table></div></div>';$("#pdailog").dialog({title:"保存报表",width:330,height:260,closed:false,cache:false,modal:true,toolbar:null,content:o,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var q=$("#pdailog #pageName").val();if(q==""){msginfo("您还未录入文件名称。");$("#pdailog #pageName").focus();return}var r=$("#reportcatalist").tree("getSelected");if(r==null||r.id=="0"){msginfo("您还未选择报表目录。");return}$.post("../report/Report!newSave.action",{pageInfo:b,pageId:"",pageName:q,cataId:r.id},function(s){if(s=="no"){msginfo("保存失败，名称存在重复。");return}pageInfo.id=Number(s);if(e!=undefined){e()}else{}msginfo("保存成功！","suc");curTmpInfo.isupdate=false;$("#pdailog").dialog("close")})}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #reportcatalist").tree({url:"../report/ReportCatalog!tree.action?type=1",dnd:false,data:[{id:"0",text:"报表目录",state:"closed"}],onBeforeLoad:function(q){if(!q||q==null){return false}}});$("#reportcatalist").tree("expand",$("#reportcatalist").tree("getRoot").target)}else{$.post("ReportDesign!save.action",{pageInfo:b,pageId:c},function(q){pageInfo.id=Number(q);if(e!=undefined){e()}else{}if(h){msginfo("保存成功！","suc")}curTmpInfo.isupdate=false})}}function liveCompMoveEvent(b){var a=findCompById(b);$("#T"+b+" .title .tname").bind("dblclick",function(){var c=this;$.messager.prompt("提示信息","请输入新的组件名称：",function(d){if(d!=undefined){a.name=d;$(c).html(d)}});$(".messager-input").val(a.name);$(".messager-input").select()});$("#T"+b).draggable({revert:true,handle:$("#T"+b+" a.moveComponent"),proxy:function(e){var d=$(e).width();var c=$(e).height();var f=$('<div style="border:1px solid #999999;background-color:#cccccc; opacity:0.5; filter:alpha(opacity=50); width:'+d+"px; height:"+c+'px;"></div>');f.appendTo("body");return f},onBeforeDrag:function(c){},onStartDrag:function(c){},onStopDrag:function(c){$("body").css("cursor","default")}});$("#optarea,#T"+b).droppable({accept:".comp_table",onDragEnter:function(f,d){if($(this).hasClass("comp_table")){$(".indicator").css({display:"block",left:$(this).offset().left,top:$(this).offset().top-10});curTmpInfo.curComp={tp:"zjj",obj:$(this)};f.cancelBubble=true;f.stopPropagation()}else{var c=$(this).children().last();var g=c.offset();curTmpInfo.curComp={tp:"zjw",obj:$(this)};$(".indicator").css({display:"block",left:g.left-10,top:g.top-5+$(c).height()})}},onDragLeave:function(f,d){if($(this).hasClass("comp_table")){var c=$(this).children().last();var g=c.offset();$(".indicator").css({display:"block",left:g.left-10,top:g.top-5+$(c).height()});curTmpInfo.curComp={tp:"zjw",obj:$(this)};f.cancelBubble=true;f.stopPropagation()}else{$(".indicator").hide()}},onDrop:function(d,c){$(".indicator").hide();if(curTmpInfo.curComp&&curTmpInfo.curComp.tp=="zjj"){curTmpInfo.isupdate=true;$(c).insertBefore(curTmpInfo.curComp.obj);d.cancelBubble=true;d.stopPropagation()}else{if(curTmpInfo.curComp.tp&&curTmpInfo.curComp.tp=="zjw"){$("#optarea").append(c)}}}})}function msginfo(a,c){var b=null;if(c&&c=="suc"){b="<div class='msginfo msgsuc'>"+a+"</div>"}else{b="<div class='msginfo msgerr'>"+a+"</div>"}$.messager.show({title:(c&&c=="suc")?"成功了":"出错了",msg:b,showType:"fade",timeout:2000,style:{right:"",top:document.body.scrollTop+document.documentElement.scrollTop+10,bottom:""}})}function releasePage(){if(pageInfo.comps.length==0){msginfo("发布失败，页面无任何内容！");return}resortComp();$("#pdailog").dialog({title:"报表发布",width:612,height:420,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px 5px 5px 1px;"><span class="inputtext">报表目录：</span><input id="reportcatalist" style="width:200px;"></div><div style="border-bottom:solid 1px #CCCCCC;border-top:solid 1px #CCCCCC;"><table id="reportlist" title="" style="width:600px;height:270px;"><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:320">名称</th><th data-options="field:\'crtdate\',width:100">创建时间</th><th data-options="field:\'loginName\',width:100">创建人</th></tr></thead></table></div><div style="margin:5px;"><span class="inputtext">报表名称：</span><input type="text" style="width:187px" name="rname" id="rname"> &nbsp; &nbsp; &nbsp; <span class="inputtext">报表类型：</span><select id="rtype" name="rtype" style="width:187px"><option value="gd">固定报表</optin><option value="olap">OLAP报表</optin></select></div>',onLoad:function(){},buttons:[{text:"确定",handler:function(){var d=$("#pdailog #reportcatalist").combotree("tree").tree("getSelected");if(d==null||d.id=="0"){msginfo("您还未选择报表发布目录。");return}var a=$("#pdailog #rname").val();if(a==""){msginfo("请输入报表名称！");$("#pdailog #rname").focus();return}var c=$("#pdailog #rtype").val();for(i=0;c=="gd"&&i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type!="text"&&pageInfo.comps[i].type!="customComp"&&pageInfo.comps[i].kpiJson==undefined){msginfo("组件中无数据，请先拖放度量或维度。");$("#pdailog").dialog("close");return}if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.push({type:"kpiOther",id:"kpi"})}}var b=JSON.stringify(pageInfo);for(i=0;c=="gd"&&i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.pop()}}$.ajax({type:"POST",url:"ReportDesign!release.action",dataType:"json",data:{pageName:a,cataId:d.id,pageInfo:b,incomeId:pageInfo.id,rtype:c},async:false,success:function(e){msginfo("报表发布成功。","suc");pageInfo.releCata=d.id;$("#pdailog").dialog("close");if(pageInfo.id){savepage(false)}},error:function(){msginfo("覆盖操作不能修改报表类型。")}})}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #reportcatalist").combotree({url:"../report/ReportCatalog!tree.action?type=-1",onClick:function(a){$("#reportlist").datagrid("load",{cataId:a.id,t:Math.random()})}});if(pageInfo.releCata){$("#pdailog #reportcatalist").combotree("setValues",[pageInfo.releCata])}$("#pdailog #reportlist").datagrid({singleSelect:true,collapsible:false,border:false,url:"../report/Report!listRelease.action",method:"post",queryParams:{cataId:pageInfo.releCata?pageInfo.releCata:"-1",t:Math.random()},onSelect:function(a,b){$("#pdailog #rname").val(b.name);if(b.rfile==null){$("#pdailog #rtype").val("olap")}else{$("#pdailog #rtype").val("gd")}}})}function printComp(e){var b=findCompById(e);if(b.type=="table"){b.tableJson.cols.push({type:"kpiOther",id:"kpi"})}var d={comps:[b],params:[]};var f="about:blank";var c="printwindow";window.open(f,c);var a="<form name='prtff' method='post' target='printwindow' action=\""+(curTmpInfo.prtUrl?curTmpInfo.prtUrl:"ReportDesign!print.action")+"\" id='expff'><input type='hidden' name='pageInfo' id='pageInfo' value='"+JSON.stringify(d)+"'></form>";if(b.type=="table"){b.tableJson.cols.pop()}$(a).appendTo("body").submit().remove()}function printData(){resortComp();for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type!="text"&&pageInfo.comps[i].type!="customComp"&&pageInfo.comps[i].kpiJson==undefined){msginfo("组件中无数据，请先添加指标。");$("#pdailog").dialog("close");return}if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.push({type:"kpiOther",id:"kpi"})}}var c=JSON.stringify(pageInfo);for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.pop()}}var d="about:blank";var b="printwindow";window.open(d,b);var a="<form name='prtff' method='post' target='printwindow' action=\"ReportDesign!print.action\" id='expff'><input type='hidden' name='pageInfo' id='pageInfo' value='"+c+"'></form>";$(a).appendTo("body").submit().remove()}function pushData(){var a='<div style="margin:5px 5px 5px 25px; line-height:26px;">推 送 到： <br/><select id="pushType" name="pushType" style="width:210px;"><option value=""></option><option value="3G">手机页面</option></select><br>页面名称：<br/><input type="text" name="pageName" id="pageName" style="width:210px;" ><br>页面说明：<br/><textarea name="pageNote"  id="pageNote" style="width:210px;" ></textarea></div>';$("#pdailog").dialog({title:"推送数据",width:290,height:280,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){resortComp();var f=$("#pdailog #pushType").val();var c=$("#pdailog #pageName").val();var e=$("#pdailog #pageNote").val();if(f==""){msginfo("请选择数据推送到哪里？");return}if(c==""){msginfo("请填写推送的页面名称！");$("#pdailog #pageName").focus();return}if(e==""){msginfo("请填写推送的页面说明信息！");$("#pdailog #pageNote").focus();return}for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type!="text"&&pageInfo.comps[i].type!="customComp"&&pageInfo.comps[i].kpiJson==undefined){msginfo("组件中无数据，请先添加指标。");$("#pdailog").dialog("close");return}if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.push({type:"kpiOther",id:"kpi"})}}var d=JSON.stringify(pageInfo);for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.pop()}}var b="";for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){if(pageInfo.params[i].type=="day"){b=pageInfo.params[i].colname}}$.ajax({type:"POST",url:"ReportDesign!push.action",data:{pushType:f,pageName:c,pageNote:e,dayParam:b,pageInfo:d},success:function(){msginfo("数据推送成功！","suc")}});$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function exportComp(c){var b=findCompById(c);var a="<form name='expff' method='post' action=\""+(curTmpInfo.expUrl?curTmpInfo.expUrl:"ReportExport.action")+"\" id='expff'><input type='hidden' name='type' id='type'><input type='hidden' name='json' id='json'><div class='exportpanel'><span class='exptp select' tp='html'><img src='../resource/img/export-html.gif'><br>HTML</span><span class='exptp' tp='csv'><img src='../resource/img/export-csv.gif'><br>CSV</span><span class='exptp' tp='excel'><img src='../resource/img/export-excel.gif'><br>EXCEL</span><span class='exptp' tp='pdf'><img src='../resource/img/export-pdf.gif'><br>PDF</span></div></form>";$("#pdailog").dialog({title:"导出数据",width:316,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var d=curTmpInfo.expType;$("#expff #type").val(d);if(b.type=="table"){b.tableJson.cols.push({type:"kpiOther",id:"kpi"})}$("#expff #json").val(JSON.stringify({comps:[b],params:[]}));if(b.type=="table"){b.tableJson.cols.pop()}$("#expff").submit();$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});curTmpInfo.expType="html";$(".exportpanel span.exptp").click(function(d){$(".exportpanel span.exptp").removeClass("select");$(this).addClass("select");curTmpInfo.expType=$(this).attr("tp")})}function exportPage(){var a="<form name='expff' method='post' action=\"ReportExport.action\" id='expff'><input type='hidden' name='type' id='type'><input type='hidden' name='json' id='json'><div class='exportpanel'><span class='exptp select' tp='html'><img src='../resource/img/export-html.gif'><br>HTML</span><span class='exptp' tp='csv'><img src='../resource/img/export-csv.gif'><br>CSV</span><span class='exptp' tp='excel'><img src='../resource/img/export-excel.gif'><br>EXCEL</span><span class='exptp' tp='pdf'><img src='../resource/img/export-pdf.gif'><br>PDF</span></div></form>";$("#pdailog").dialog({title:"导出数据",width:316,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){resortComp();var b=curTmpInfo.expType;$("#expff #type").val(b);for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type!="text"&&pageInfo.comps[i].type!="customComp"&&pageInfo.comps[i].kpiJson==undefined){msginfo("组件中无数据，请先添加指标。");$("#pdailog").dialog("close");return}if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.push({type:"kpiOther",id:"kpi"})}}$("#expff #json").val(JSON.stringify(pageInfo));for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.pop()}}$("#expff").submit();$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});curTmpInfo.expType="html";$(".exportpanel span.exptp").click(function(b){$(".exportpanel span.exptp").removeClass("select");$(this).addClass("select");curTmpInfo.expType=$(this).attr("tp")})}function helper(){$("#pdailog").dialog({title:"使用帮助",width:760,height:450,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","Helper.action")}function showloading(){var d=jQuery(document);var c=jQuery(window);var b=d.scrollTop()+60;var a=d.scrollLeft()+c.width()-200;$("#Cloading").css({top:b,left:a,display:"block"})}function hideLoading(){$("#Cloading").css("display","none")}function initHtml(){if(!curTmpInfo.face){return""}return'<div id="pdailog"></div><div id="kpioptmenu" class="easyui-menu"><div><span>计算</span><div style="width:120px;"><div onclick="kpicompute(\'sq\')">上期值</div><div onclick="kpicompute(\'tq\')">同期值</div><div onclick="kpicompute(\'zje\')">增减额</div><div onclick="kpicompute(\'hb\')">环比(%)</div><div onclick="kpicompute(\'tb\')">同比(%)</div><div class="menu-sep"></div><div onclick="kpicompute(\'sxpm\')">升序排名</div><div onclick="kpicompute(\'jxpm\')">降序排名</div><div onclick="kpicompute(\'zb\')">占比(%)</div></div></div><div onclick="kpiproperty()">属性...</div><div onclick="kpiFilter(\'table\')">筛选...</div><div><span>排序</span><div style="width:120px;"><div id="k_kpi_ord1" onclick="kpisort(\'asc\')">升序</div><div id="k_kpi_ord2"  onclick="kpisort(\'desc\')">降序</div><div id="k_kpi_ord3" iconCls="icon-ok" onclick="kpisort(\'\')">默认</div></div></div></div><div id="dimoptmenu" class="easyui-menu"><div onclick="dimsort(\'asc\')">升序</div><div onclick="dimsort(\'desc\')">降序</div><div><span>移动</span><div style="width:120px;"><div iconCls="icon-back" onclick="dimmove(\'left\')">左移</div><div iconCls="icon-right" onclick="dimmove(\'right\')">右移</div><div id="m_moveto" onclick="dimexchange()">移至</div></div></div><div iconCls="icon-reload" onclick="changecolrow(true)">行列互换</div><div iconCls="icon-filter" onclick="filterDims()">筛选...</div><div iconCls="icon-sum" onclick="aggreDim()" id="m_aggre">聚合...</div><div onclick="getDimTop()" id="m_aggre">取Top...</div></div><div class=\'chartloading\' id="Cloading"><div class="ldclose" onclick="hideLoading()"></div><div class="ltxt">Loading...</div></div>'}function setpage(){var c=pageInfo.drillset;var b=pageInfo.chartdrillset;var a='<fieldset style="margin-bottom:10px;"><legend>表格钻取设置</legend> <input type="radio" '+(!c||c=="1"?"checked":"")+' id="drillset" name="drillset" value="1">下钻时只展开当前节点。<br/><input type="radio" '+(c=="2"?"checked":"")+' id="drillset" name="drillset" value="2">下钻时展开所有节点。</fieldset><fieldset><legend>图形钻取设置</legend> <input type="radio" '+(b=="1"?"checked":"")+' id="chartdrill" name="chartdrill" value="1">进行多维度钻取。<br/><input type="radio" '+(!b||b=="2"?"checked":"")+' id="chartdrill" name="chartdrill" value="2">只展开当前维度。</fieldset>';$("#pdailog").dialog({title:"页面设置",width:400,height:230,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){pageInfo.drillset=$("#pdailog input[name='drillset']:radio:checked").val();pageInfo.chartdrillset=$("#pdailog input[name='chartdrill']:radio:checked").val();$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function dataming(a){jd.ModuleMgr.require(["jd.anls.Util"],function(){jd.anls.Util.olapANSL(a)})}function kpidesc(){$("#pdailog").dialog({title:"指标解释",width:600,height:350,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"关闭",iconCls:"icon-ok",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","DataSet!kpidesc.action?selectDsIds="+pageInfo.selectDs,{a:1,b:2})}if($==undefined){$=jQuery}function insertTable(){addComp(getMaxCompId(),"表格组件",null,true,"table")}function crtCrossTable(){var a="<table class='d_table'><tr><td class='blank'></td><td><div id='d_colDims' class='tabhelpr'>将维度拖到此处作为列标签</div></td></tr><tr><td><div id='d_rowDims' class='tabhelpr'>将维度拖到此处<br>作为行标签</div></td><td><div id='d_kpi' class='tabhelpr'>将指标拖到此处<br>查询数据</div></td></tr></table>";return a}function initDropDiv(b){var a=false;$("#T"+b+" #d_colDims, #T"+b+" #d_rowDims, #T"+b+" #d_kpi").droppable({accept:"#datasettree .tree-node",onDragEnter:function(f,d){var c=$("#datasettree").tree("getNode",d);var g=c.attributes.col_type;if(g==1&&($(this).attr("id")=="d_colDims"||$(this).attr("id")=="d_rowDims")){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");if($(this).attr("id")=="d_colDims"){$("#T"+b+" #d_colDims").css("border","1px solid #ff0000")}if($(this).attr("id")=="d_rowDims"){$("#T"+b+" #d_rowDims").css("border","1px solid #ff0000")}a=true}else{a=false}if(g==2&&$(this).attr("id")=="d_kpi"){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+b+" #d_kpi").css("border","1px solid #ff0000");a=false}f.cancelBubble=true;f.stopPropagation()},onDragLeave:function(d,c){if($(this).attr("id")=="d_kpi"&&a==true){}else{$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+b+" #"+$(this).attr("id")).css("border","none")}d.cancelBubble=true;d.stopPropagation()},onDrop:function(h,f){var l=$(this).parents(".comp_table").attr("id").replace("T","");var c=findCompById(Number(l));h.cancelBubble=true;h.stopPropagation();$("#T"+l+" #"+$(this).attr("id")).css("border","none");var d=$("#datasettree").tree("getNode",f);if(c.tid!=undefined){if(c.tid!=d.attributes.tid){msginfo("您拖入的"+(d.attributes.col_type==2?"指标":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}c.tid=d.attributes.tid;c.tname=d.attributes.tname;c.ttype=d.attributes.ttype;c.dsource=d.attributes.dsource;if(c.kpiJson==undefined){c.kpiJson=[]}if(c.tableJson==undefined){c.tableJson={cols:[],rows:[]}}if(d.attributes.col_type==2&&$(this).attr("id")=="d_kpi"){if(!kpiExist(d.attributes.col_id,c.kpiJson)){c.kpiJson.push({kpi_id:d.attributes.col_id,kpi_name:d.text,col_name:d.attributes.col_name,aggre:d.attributes.aggre,fmt:d.attributes.fmt,alias:d.attributes.alias,tid:c.tid,unit:d.attributes.unit,rate:d.attributes.rate})}else{msginfo("指标已经存在。");return}curTmpInfo.isupdate=true;tableView(c,Number(l))}if(d.attributes.col_type==1){if($(this).attr("id")=="d_colDims"){if(dimExist(d.attributes.col_id,c.tableJson.cols)||dimExist(d.attributes.col_id,c.tableJson.rows)){msginfo("维度已经存在。");return}var g=d.attributes.grouptype;if(g!=null&&findGroup(c.tableJson.rows,g)){msginfo("拖放失败，同一分组的维度必须在同一行/列标签。");return}c.tableJson.cols.push({id:d.attributes.col_id,dimdesc:d.text,type:d.attributes.dim_type,colname:d.attributes.alias,tid:c.tid,iscas:d.attributes.iscas,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,dim_name:d.attributes.dim_name,grouptype:d.attributes.grouptype,valType:d.attributes.valType,endlvl:d.attributes.endlvl});curTmpInfo.isupdate=true;tableView(c,Number(l))}if($(this).attr("id")=="d_rowDims"){if(dimExist(d.attributes.col_id,c.tableJson.rows)||dimExist(d.attributes.col_id,c.tableJson.cols)){msginfo("维度已经存在。");return}var g=d.attributes.grouptype;if(g!=null&&findGroup(c.tableJson.cols,g)){msginfo("拖放失败，同一分组的维度必须在同一行/列标签。");return}c.tableJson.rows.push({id:d.attributes.col_id,dimdesc:d.text,type:d.attributes.dim_type,colname:d.attributes.alias,tid:c.tid,iscas:d.attributes.iscas,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,dim_name:d.attributes.dim_name,grouptype:d.attributes.grouptype,valType:d.attributes.valType,endlvl:d.attributes.endlvl});curTmpInfo.isupdate=true;tableView(c,Number(l))}}}})}function findGroup(d,c,b){var a=false;if(!d||d==null){return a}for(m=0;m<d.length;m++){if(b&&b==d[m]){continue}if(d[m].grouptype==c){a=true;break}}return a}function paramsamedimdate(a){var d=true;var b=function(e){var f=false;for(var g=0;a.tableJson&&g<a.tableJson.cols.length;g++){if(a.tableJson.cols[g].type==e){f=true;break}}for(var g=0;a.tableJson&&g<a.tableJson.rows.length;g++){if(a.tableJson.rows[g].type==e){f=true;break}}return f};var c=pageInfo.params;for(i=0;c&&i<c.length;i++){if(c[i].grouptype=="date"){if(!b(c[i].type)){d=false;break}}}return d}function kpicompute(h){var b={zb:1,sxpm:1,jxpm:1,ydpj:1,sq:2,tq:2,zje:2,hb:2,tb:2};var e=curTmpInfo.ckid;var l=curTmpInfo.compId.replace("T","");var d=findCompById(l);var g=findKpiById(e,d.kpiJson);if(h=="zb"){g.compute="zb"}else{if(h=="sxpm"){g.compute="sxpm"}else{if(h=="jxpm"){g.compute="jxpm"}else{if(!isExistDateDim(d,"table")){msginfo("当前指标计算需要表格中先有时间类型的维度(年/季度/月/日)。");return}if(!paramsamedimdate(d)){msginfo("指标计算时，需要表格中具有和参数相同的维度。");return}var f=g.compute;if(!f||f==""){g.compute=h}else{var a=f.split(",");if(b[a[0]]==1){g.compute=h}else{var c=false;for(j=0;j<a.length;j++){if(a[j]==h){c=true;break}}if(!c){g.compute=f+","+h}}}}}}tableView(d,l)}function delExtKpi(d,g,f){var c=$(d).parents(".comp_table").attr("id").replace("T","");var a=findCompById(Number(c));var h=findKpiById(g,a.kpiJson);var e=h.compute.split(",");if(e.length==1){delete h.compute}else{var b="";for(i=0;i<e.length;i++){if(e[i]!=f){b=b+e[i]+","}}h.compute=b.substring(0,b.length-1)}tableView(a,c)}function tableView(g,f){if(g.tableJson==undefined||g.kpiJson==undefined){return}if(g.kpiJson.length==0&&g.tableJson.cols.length==0&&g.tableJson.rows.length==0){$("#T"+f+" div.ctx").html(crtCrossTable());initDropDiv(f);return}if(curTmpInfo.face){var a=function(n){delete n.dimdesc;delete n.tableColKey;delete n.colname;delete n.dim_name;delete n.tableName;delete n.tableColName;delete n.grouptype;delete n.type;delete n.valType};var e=g.tableJson.cols;for(i=0;i<e.length;i++){var h=e[i];a(h)}var l=g.tableJson.rows;for(i=0;i<l.length;i++){var h=l[i];a(h)}for(i=0;i<g.kpiJson.length;i++){var h=g.kpiJson[i];delete h.col_name;delete h.unit;delete h.alias;delete h.kpi_name}}g.tableJson.cols.push({type:"kpiOther",id:"kpi"});var d=JSON.stringify(g.tableJson);g.tableJson.cols.pop();var b="[]";if(pageInfo.params&&pageInfo.params.length>0){b=JSON.stringify(pageInfo.params)}var c=JSON.stringify(g.kpiJson);showloading();if(curTmpInfo.face){$.ajax({type:"get",dataType:"jsonp",jsonp:"jsonpcallback",url:curTmpInfo.tvUrl?curTmpInfo.tvUrl:"TableView!face.action",data:{tableJson:d,kpiJson:c,compId:f,params:b,dsource:g.dsource==null?"":g.dsource},success:function(n){hideLoading();$("#T"+f+" div.ctx").html(n.ctx);g.kpiJson=n.kpiJson;g.tableJson=n.tableJson;initDropDiv(f)}})}else{$.ajax({type:"POST",url:curTmpInfo.tvUrl?curTmpInfo.tvUrl:"TableView.action",dataType:"html",data:{tableJson:d,kpiJson:c,compId:f,params:b,dsource:g.dsource==null?"":g.dsource},success:function(n){hideLoading();$("#T"+f+" div.ctx").html(n);initDropDiv(f)},error:function(n){hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}}function kpiFilter(g){var e=curTmpInfo.ckid;var d=curTmpInfo.compId.replace("T","");var b=findCompById(d);var f=findKpiById(e,b.kpiJson);var h=f.filter;var c="";if(f.rate==1000){c="千"}else{if(f.rate==10000){c="万"}else{if(f.rate==1000000){c="百万"}else{if(f.rate==100000000){c="亿"}}}}var a="<div style='line-height:25px; margin:5px;'><br/> "+f.kpi_name+' &nbsp; <select id="ftype"><option value=""></option><option value=">" '+(h&&h.filterType==">"?"selected":"")+'>大于</option><option value="<" '+(h&&h.filterType=="<"?"selected":"")+'>小于</option><option value="=" '+(h&&h.filterType=="="?"selected":"")+'>等于</option><option value="between" '+(h&&h.filterType=="between"?"selected":"")+'>区间</option></select> &nbsp; <input type="text" id="startval" size="5" value="'+(h?h.val1:"")+'"><span id="endvalspan" style="display:'+(h&&h.filterType=="between"?"inline":"none")+'"> - <input type="text" id="endval" size="5" value="'+(h?h.val2:"")+'"></span>'+c+f.unit+"<br/>[<a id=\"clear\" href='javascript:;'>清除筛选</a>]</div>";$("#pdailog").dialog({title:"指标筛选",width:330,height:180,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var p=$("#pdailog #ftype").val();var l=$("#pdailog #startval").val();var o=$("#pdailog #endval").val();if(p==""||l==""){delete f.filter}else{var n={kpi:f.kpi_id,filterType:p,val1:Number(l),val2:(o==""?0:Number(o))};f.filter=n}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;if(g=="table"){tableView(b,d)}else{if(g=="chart"){chartview(b,d)}}}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #startval,#pdailog #endval").numberbox();$("#pdailog #ftype").bind("change",function(){var l=$(this);if(l.val()=="between"){$("#pdailog #endvalspan").css("display","inline")}else{$("#pdailog #endvalspan").css("display","none")}});$("#pdailog #clear").bind("click",function(){$("#pdailog #ftype").val("");$("#pdailog #startval").val("");$("#pdailog #endval").val("")})}function delJsonKpiOrDim(f){var a=curTmpInfo.ckid;var n=curTmpInfo.compId.replace("T","");var d=findCompById(Number(n));var e=curTmpInfo.pos;if(f=="kpi"){var l=d.kpiJson;var h=-1;for(var c=0;c<l.length;c++){if(l[c].kpi_id==a){h=c;break}}l.splice(h,1)}if(f=="dim"){var g=null;if(e=="col"){g=d.tableJson.cols}else{g=d.tableJson.rows}var h=-1;for(var c=0;c<g.length;c++){if(g[c].id==a){h=c;break}}g.splice(h,1);if(!isExistDateDim(d,"table")){for(var b=0;d.kpiJson&&b<d.kpiJson.length;b++){delete d.kpiJson[b].compute}}if(!paramsamedimdate(d)){for(var b=0;d.kpiJson&&b<d.kpiJson.length;b++){delete d.kpiJson[b].compute}}}curTmpInfo.isupdate=true;tableView(d,n)}function setKpiInfo(b,e){var d=$(b).offset();curTmpInfo.ckid=e;curTmpInfo.compId=$(b).parents(".comp_table").attr("id");var a=findCompById(Number(curTmpInfo.compId.replace("T","")));var c=findKpiById(e,a.kpiJson);if(c.sort=="asc"){$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-ok"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{if(c.sort=="desc"){$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-ok"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-ok"})}}$("#kpioptmenu").menu("show",{left:d.left,top:d.top+20})}function setCdimInfo(h,b,a){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=$(h).parents(".comp_table").attr("id");curTmpInfo.pos="col";curTmpInfo.dimname=a;var e=false;var g=findCompById(Number(curTmpInfo.compId.replace("T","")));var l=g.tableJson.cols;for(var f=0;f<l.length;f++){if(l[f].id==b){if(l[f].issum=="y"){e=true;break}}}if(e){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合..."})}var c=$("#dimoptmenu").menu("getItem",$("#m_moveto"));$("#dimoptmenu").menu("setText",{target:c.target,text:"移至行维度"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top+20})}function setRdimInfo(h,b,a){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=$(h).parents(".comp_table").attr("id");curTmpInfo.pos="row";curTmpInfo.dimname=a;var e=false;var g=findCompById(Number(curTmpInfo.compId.replace("T","")));var l=g.tableJson.rows;for(var f=0;f<l.length;f++){if(l[f].id==b){if(l[f].issum=="y"){e=true;break}}}if(e){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合..."})}var c=$("#dimoptmenu").menu("getItem",$("#m_moveto"));$("#dimoptmenu").menu("setText",{target:c.target,text:"移至列维度"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top+20})}function updateQDate(d,c,e){$("#pdailog").dialog({title:"修改数据账期",width:250,height:240,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var f=findCompById(c);if(e=="table"){f.tableJson.baseDate={start:$("#pdailog #dft2").val(),end:$("#pdailog #dft1").val()};curTmpInfo.isupdate=true;tableView(f,c)}if(e=="chart"){f.chartJson.baseDate={start:$("#pdailog #dft2").val(),end:$("#pdailog #dft1").val()};curTmpInfo.isupdate=true;chartview(f,c)}$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var b=$(d).attr("ed");var a=$(d).attr("st");b=b.substring(0,4)+"-"+b.substring(4,6)+"-"+b.substring(6,8);a=a.substring(0,4)+"-"+a.substring(4,6)+"-"+a.substring(6,8);$("#pdailog").dialog("refresh","DateFilter.action?dimType="+($(d).attr("dimid")==1?"day":"month")+"&dimId="+$(d).attr("dimid")+"&dft1="+b+"&dft2="+a)}function changecolrow(e){var d=curTmpInfo.compId.replace("T","");var b=findCompById(d);var c=b.tableJson.rows;b.tableJson.rows=b.tableJson.cols;b.tableJson.cols=c;tableView(b,d);if(b.complink&&e){var a=findCompById(b.complink);if(a!=null&&isSameDimsInDrill(b,a)){exchangexs(a.id,false)}}}function filterDims(){var o=curTmpInfo.ckid;var q=curTmpInfo.compId.replace("T","");var l=curTmpInfo.pos;var b=curTmpInfo.dimname;var g=findCompById(q);var p=null;if(l=="col"){p=g.tableJson.cols}else{p=g.tableJson.rows}$("#pdailog").dialog({title:b+" - 维度筛选",width:280,height:300,closed:false,cache:false,modal:true,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var A=null;for(var w=0;w<p.length;w++){if(p[w].id==o){A=p[w];break}}var x=$("#dimfiltertab").tabs("getSelected");var v=$("#dimfiltertab").tabs("getTabIndex",x);if("day"==A.type&&v==0){var u=$("#dimfiltertab #dft2").val();var t=$("#dimfiltertab #dft1").val();if(Number(u.replace(/-/g,""))>Number(t.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}A.startdt=u;A.enddt=t;A.filtertype=1;delete A.vals}else{if("month"==A.type&&v==0){var u=$("#dimfiltertab #dfm2").val();var t=$("#dimfiltertab #dfm1").val();if(Number(u)>Number(t)){msginfo("您选择的开始月份不能大于结束月份。");return}A.startmt=u;A.endmt=t;A.filtertype=1;delete A.vals}else{var y="";var z=$("#pdailog input[name='dimval']:checkbox:checked");z.each(function(C,B){y=y+$(this).val();if(C!=z.size()-1){y=y+","}});A.vals=y;A.filtertype=2;delete A.startmt;delete A.endmt;delete A.startdt;delete A.enddt}}curTmpInfo.isupdate=true;tableView(g,q);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var n="";var d="";var h="";var s=null;for(var e=0;e<p.length;e++){if(p[e].id==o){n=p[e].vals;d=p[e].type;h=p[e].filtertype==undefined?"":p[e].filtertype;s=p[e];break}}var c=$("#T"+q+" #datemodbtn");var r=c.attr("st");var f=c.attr("ed");var a=(curTmpInfo.filterUrl?curTmpInfo.filterUrl:"DimFilter.action")+"?dimType="+d+"&filtertype="+h+"&min="+r+"&max="+f+"&dimId="+o+"&vals="+n;if(d=="month"){a=a+"&dfm2="+(s.startmt==undefined?"":s.startmt);a=a+"&dfm1="+(s.endmt==undefined?"":s.endmt)}if(d=="day"){a=a+"&dft2="+(s.startdt==undefined?"":s.startdt);a=a+"&dft1="+(s.enddt==undefined?"":s.enddt)}if(curTmpInfo.face){$("#pdailog div.dialog-content").html("Loading...");$.ajax({type:"get",dataType:"jsonp",jsonp:"jsonpcallback",url:a,success:function(u){$("#pdailog div.dialog-content").html(u.ctx);$("#pdailog .dfilter .fltone").mousemove(function(){$(this).css("background-color","#FFF4D7")}).mouseout(function(v){$(this).css("background-color","#FFFFFF")}).click(function(w){if(w.target.id=="dimval"){return}var v=$(this).find("#dimval");if(v.attr("checked")=="checked"){v.attr("checked",false)}else{v.attr("checked",true)}});var t="${param.filtertype}";$("#pdailog #dimfiltertab").tabs({border:false,plain:false,fit:true,tabPosition:"top",tools:[{text:"清除",handler:function(){$("#pdailog input[name='dimval']").each(function(){$(this).attr("checked",false)})}},{text:"全选",handler:function(){$("#pdailog input[name='dimval']").each(function(){$(this).attr("checked",true)})}}]})}})}else{$("#pdailog").dialog("refresh",a)}}function aggreDim(){var f=curTmpInfo.ckid;var h=curTmpInfo.compId.replace("T","");var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(h);var g=null;if(e=="col"){g=d.tableJson.cols}else{g=d.tableJson.rows}var c=null;for(var b=0;b<g.length;b++){if(g[b].id==f){c=g[b]}}if(c.issum=="y"){c.issum="n";delete c.aggre;curTmpInfo.isupdate=true;tableView(d,h);return}var l='<div style=\'line-height:30px; margin:20px 20px 20px 40px;\'>聚合方式：<select id="dimaggre" name="dimaggre"><option value="sum">求和</option><option value="count">计数</option><option value="avg">平均</option><option value="max">最大</option><option value="min">最小</option><option value="var">方差</option><option value="sd">标准差</option><option value="middle">中位数</option></select></div>';$("#pdailog").dialog({title:"维度聚合",width:280,height:180,closed:false,cache:false,modal:true,toolbar:null,content:l,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){if(c.issum=="y"){c.issum="n";delete c.aggre}else{c.issum="y";c.aggre=$("#pdailog #dimaggre").val()}curTmpInfo.isupdate=true;tableView(d,h);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function isExistDateDim(a,d){var b=false;if(d=="table"){if(!a.tableJson||!a.tableJson.cols){return b}for(var c=0;c<a.tableJson.cols.length;c++){if(a.tableJson.cols[c].grouptype=="date"){b=true;break}}if(!a.tableJson||!a.tableJson.rows){return b}for(var c=0;c<a.tableJson.rows.length;c++){if(a.tableJson.rows[c].grouptype=="date"){b=true;break}}}if(d=="chart"){if(!a.chartJson||!a.chartJson.params){return b}for(var c=0;c<a.chartJson.params.length;c++){if(a.chartJson.params[c].grouptype=="date"){b=true;break}}if(!a.chartJson||!a.chartJson.xcol){return b}if(a.chartJson.xcol.grouptype=="date"){b=true}}return b}function kpiproperty(){var d=curTmpInfo.ckid;var c=curTmpInfo.compId.replace("T","");var b=findCompById(c);var e=findKpiById(d,b.kpiJson);var a="<div style='line-height:30px; margin:5px;'>指标名称："+e.kpi_name+"<br>所 属 表： "+b.tname+"<br>指标单位：<select id=\"kpiunit\" name=\"kpiunit\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+e.unit+'<br>格 式 化：<select id="fmt" name="fmt"><option value="###,##0">整数</option><option value="###,##0.0">小数(保留1位)</option><option value="###,##0.00">小数(保留2位)</option><option value="0.00%">百分比</option></select></div>';$("#pdailog").dialog({title:"指标属性",width:280,height:230,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){e.fmt=$("#pdailog #fmt").val();e.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;tableView(b,c)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+e.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+e.rate+"']").attr("selected",true);$("#pdailog #aggreType").find("option[value='"+e.aggre+"']").attr("selected",true)}function getDimTop(){var f=curTmpInfo.ckid;var h=curTmpInfo.compId.replace("T","");var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(h);var g=null;if(e=="col"){g=d.tableJson.cols}else{g=d.tableJson.rows}var c=null;for(var b=0;b<g.length;b++){if(g[b].id==f){c=g[b]}}var l='<div style="margin:20px 20px 20px 30px;line-height:25px;">维度取Top： <input type="text" id="top" name="top" size="5" value="'+(c.top?c.top:"")+'"> <select id="type" name="type"><option value="number" '+(c.topType=="number"?"selected":"")+'>数字</option><option value="percent" '+(c.topType=="percent"?"selected":"")+">百分比</option></select></div>";$("#pdailog").dialog({title:"维度取Top",width:270,height:170,closed:false,cache:false,modal:true,toolbar:null,content:l,buttons:[{text:"完成",iconCls:"icon-ok",handler:function(){var o=$("#pdailog #top").val();var n=$("#pdailog #type").val();c.top=o;c.topType=n;$("#pdailog").dialog("close");tableView(d,h)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #top").numberbox()}function kpisort(d){var c=curTmpInfo.ckid;var b=curTmpInfo.compId.replace("T","");var a=findCompById(b);for(i=0;i<a.kpiJson.length;i++){if(a.kpiJson[i].kpi_id==c){a.kpiJson[i].sort=d}else{a.kpiJson[i].sort=""}}curTmpInfo.isupdate=true;tableView(a,b)}function dimsort(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.tableJson.cols}else{f=a.tableJson.rows}for(var d=0;d<f.length;d++){if(f[d].id==b){f[d].dimord=g;break}}for(d=0;d<a.kpiJson.length;d++){a.kpiJson[d].sort=""}curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide")}function dimexchange(){var f=curTmpInfo.ckid;var n=curTmpInfo.compId.replace("T","");var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(n);if(e=="col"){var h=0;var c=null;var g=d.tableJson.cols;for(var b=0;b<g.length;b++){if(g[b].id==f){h=b;c=g[b];break}}var l=c.grouptype;if(l!=null&&findGroup(d.tableJson.cols,l,c)){msginfo("移动失败，同一分组的维度必须在同一行/列标签。");return}d.tableJson.cols.splice(h,1);d.tableJson.rows.push(c)}if(e=="row"){var h=0;var c=null;var g=d.tableJson.rows;for(var b=0;b<g.length;b++){if(g[b].id==f){h=b;c=g[b];break}}var l=c.grouptype;if(l!=null&&findGroup(d.tableJson.rows,l,c)){msginfo("移动失败，同一分组的维度必须在同一行/列标签。");return}d.tableJson.rows.splice(h,1);d.tableJson.cols.push(c)}curTmpInfo.isupdate=true;tableView(d,n)}function dimmove(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.tableJson.cols}else{f=a.tableJson.rows}if(f.length<=1){msginfo("无效移动。");return}for(var d=0;d<f.length;d++){if(f[d].id==b){if(g=="left"){if(d<=0){msginfo("无效移动。");return}else{var g=f[d-1];f[d-1]=f[d];f[d]=g;curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide");return}}else{if(g=="right"){if(d>=f.length-1){msginfo("无效移动。");return}else{var g=f[d+1];f[d+1]=f[d];f[d]=g;curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide");return}}}break}}}function getTableHeadJson(c){var a=findCompById(c);if(a==null){msginfo("组件不存在！")}var b;$.ajax({type:"POST",async:false,url:"Table2JSON.action",dataType:"json",data:{json:JSON.stringify(a),_hideMVDiv:"true"},success:function(d){b=d}});return b}function findDimById(c,d){var a=null;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=d[b];break}}return a}function findKpiById(d,c){var a=null;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=c[b];break}}return a}function findParamById(a){var b=null;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var c=pageInfo.params[i];if(c.id==a){b=c;break}}return b}function kpiExist(d,c){var a=false;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=true;break}}return a}function dimExist(c,d){var a=false;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=true;break}}return a}function findCompById(c){var a=null;for(i=0;i<pageInfo.comps.length;i++){var b=pageInfo.comps[i];if(b.id==c){a=b;break}}return a};