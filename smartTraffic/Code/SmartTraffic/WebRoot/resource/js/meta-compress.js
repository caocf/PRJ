if($==undefined){$=jQuery}var atp=["sum","avg","count","max","min"];function initdatatree(){var a=[{text:"主题域",id:"zty",state:"closed",iconCls:"icon-subject",attributes:{showmenu:true,type:"subject"}},{text:"维度",id:"wd",state:"closed",iconCls:"icon-dim",attributes:{showmenu:true,type:"dim"}},{text:"指标",id:"zb",state:"closed",iconCls:"icon-kpi",attributes:{showmenu:true,type:"kpi"}},{text:"数据源",id:"sjy",state:"open",iconCls:"icon-dsource",attributes:{showmenu:false,type:"dsource"}},{text:"设置",id:"pageset",iconCls:"icon-set",attributes:{showmenu:false,type:"set"}}];$("#mydatatree").tree({data:a,url:"SubjectManager!tree.action",onBeforeLoad:function(b,c){if(b==null){return false}if(b.attributes&&b.attributes.type=="subject"){$("#mydatatree").tree("options").url="SubjectManager!tree.action?T="+Math.random();return true}else{if(b.attributes&&b.attributes.type=="dim"){$("#mydatatree").tree("options").url="Dim!listGroup.action?T="+Math.random();return true}else{if(b.attributes&&b.attributes.type=="kpi"){$("#mydatatree").tree("options").url="Kpi!listGroup.action?t="+Math.random();return true}else{if(b.attributes&&b.attributes.type=="set"){$("#mydatatree").tree("options").url="Set.action?t="+Math.random();return true}else{return false}}}}},onClick:function(b){if(b.attributes&&b.attributes.type=="dsource"){initdsourcetable()}else{if(b.attributes&&b.attributes.type=="subject"){initSubjectList(b)}else{if(b.attributes&&b.attributes.type=="dim"){initdimtable(b)}else{if(b.attributes&&b.attributes.type=="kpi"){initkpitable(b)}else{if(b.attributes&&b.attributes.type=="set"){initsetpage()}}}}}if($("#cubelistdiv").size()>0){$("#metalayout").layout("remove","east")}},onContextMenu:function(c,b){c.preventDefault();$("#mydatatree").tree("select",b.target);if(b.attributes&&b.attributes.showmenu==true&&b.attributes.type=="subject"){if(b.id=="zty"){$("#subTreeMenu").menu("disableItem",$("#subTreeMenu #mod"));$("#subTreeMenu").menu("disableItem",$("#subTreeMenu #del"))}else{$("#subTreeMenu").menu("enableItem",$("#subTreeMenu #mod"));$("#subTreeMenu").menu("enableItem",$("#subTreeMenu #del"))}$("#subTreeMenu").menu("show",{left:c.pageX,top:c.pageY})}else{if(b.attributes&&b.attributes.showmenu==true&&b.attributes.type=="dim"){if(b.id=="wd"||b.id=="fzw"){$("#dimTreeMenu").menu("enableItem",$("#dimTreeMenu #add"));$("#dimTreeMenu").menu("disableItem",$("#dimTreeMenu #mod"));$("#dimTreeMenu").menu("disableItem",$("#dimTreeMenu #del"))}else{$("#dimTreeMenu").menu("disableItem",$("#dimTreeMenu #add"));$("#dimTreeMenu").menu("enableItem",$("#dimTreeMenu #mod"));$("#dimTreeMenu").menu("enableItem",$("#dimTreeMenu #del"))}$("#dimTreeMenu").menu("show",{left:c.pageX,top:c.pageY})}else{if(b.attributes&&b.attributes.showmenu==true&&b.attributes.type=="kpi"){if(b.id=="zb"){$("#kpiTreeMenu").menu("enableItem",$("#kpiTreeMenu #add"));$("#kpiTreeMenu").menu("disableItem",$("#kpiTreeMenu #mod"));$("#kpiTreeMenu").menu("disableItem",$("#kpiTreeMenu #del"))}else{$("#kpiTreeMenu").menu("disableItem",$("#kpiTreeMenu #add"));$("#kpiTreeMenu").menu("enableItem",$("#kpiTreeMenu #mod"));$("#kpiTreeMenu").menu("enableItem",$("#kpiTreeMenu #del"))}$("#kpiTreeMenu").menu("show",{left:c.pageX,top:c.pageY})}}}}});initSubjectList($("#mydatatree").tree("getRoots")[0])}function initsetpage(){var a='<div id="pctx" style="margin:6px;"><input type="button" onclick="setCubeDates(this)" name="btn" value="更新立方体时间区间"><br/>通过查询立方体中时间维的最大值及最小值，动态更新立方体数据时间区间。</div>';$("#optarea").html(a);$("#pctx").panel({title:"页面设置",fit:true,border:false,content:a})}function setCubeDates(a){__showLoading();$(a).attr("disabled",true);$.ajax({type:"POST",url:"Set!setCubeDates.action",dataType:"html",data:{},success:function(b){__hideLoading();$.messager.alert("成功了。","更新成功。","info")},error:function(){__hideLoading();$.messager.alert("出错了。","系统出错，请查看后台日志。","error")}})}function initdimtable(b){if($("#dimtable").size()>0){$("#dimtable").datagrid("load",{gtype:(b.id=="wd"?"":b.id),t:Math.random()});return}var a="<table id=\"dimtable\" title=\"维度管理\" ><thead><tr><th data-options=\"field:'ck',checkbox:true\"><th data-options=\"field:'dimname',width:120\">维度标识</th></th><th data-options=\"field:'dimdesc',width:120\">名称</th><th data-options=\"field:'tname',width:120\">对应表</th><th data-options=\"field:'colkey',width:120,align:'center'\">KEY字段</th><th data-options=\"field:'colname',width:120,align:'center'\">Text字段</th><th data-options=\"field:'groupname',width:120,align:'center'\">分组</th><th data-options=\"field:'ord',width:120,align:'center'\">维度排序</th></tr></thead></table>";$("#optarea").html(a);$("#dimtable").datagrid({singleSelect:false,collapsible:false,pagination:true,pageSize:20,border:false,fit:true,queryParams:{gtype:(b.id=="wd"?"":b.id),t:Math.random()},url:"Dim!list.action",method:"get",toolbar:[{text:"新增",iconCls:"icon-add",handler:function(){newdim(false,b)}},{text:"修改",iconCls:"icon-edit",handler:function(){var c=$("#dimtable").datagrid("getChecked");if(c==null||c.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}if(c.length>1){$.messager.alert("出错了。","只能选择一行数据进行修改。","error");return}newdim(true,b,c[0])}},{text:"删除",iconCls:"icon-cancel",handler:function(){var e=$("#dimtable").datagrid("getChecked");if(e==null||e.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}if(confirm("是否确认删除？")){var c="";for(i=0;i<e.length;i++){c=c+e[i].dimid;if(i!=e.length-1){c=c+","}}var d=$("#mydatatree").tree("getSelected");$.ajax({type:"POST",url:"Dim!delDim.action",dataType:"html",data:{dimid:c},success:function(f){$("#dimtable").datagrid("load",{gtype:(d.id=="wd"?"":d.id),t:Math.random()})}})}}}]})}function initkpitable(b){if($("#kpitable").size()>0){$("#kpitable").datagrid("load",{groupId:(b.id=="zb"?"":b.id),t:Math.random()});return}var a="<table id=\"kpitable\" title=\"指标管理\" ><thead><tr><th data-options=\"field:'ck',checkbox:true\"><th data-options=\"field:'id',width:120\">指标标识</th></th><th data-options=\"field:'name',width:120\">名称</th><th data-options=\"field:'unit',width:120\">单位</th><th data-options=\"field:'groupname',width:120,align:'center'\">所属分类</th><th data-options=\"field:'fmt',width:120,align:'center'\">格式化</th><th data-options=\"field:'aggre',width:120,align:'center'\">聚合方式</th><th data-options=\"field:'rate',width:120,align:'center'\">比例</th></tr></thead></table>";$("#optarea").html(a);$("#kpitable").datagrid({singleSelect:false,collapsible:false,pagination:true,pageSize:20,border:false,fit:true,queryParams:{groupId:(b.id=="zb"?"":b.id),t:Math.random()},url:"Kpi!listKpi.action",method:"get",toolbar:[{text:"新增",iconCls:"icon-add",handler:function(){newkpi(false,b)}},{text:"修改",iconCls:"icon-edit",handler:function(){var c=$("#kpitable").datagrid("getChecked");if(c==null||c.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}if(c.length>1){$.messager.alert("出错了。","只能选择一行数据进行修改。","error");return}newkpi(true,b,c[0])}},{text:"删除",iconCls:"icon-cancel",handler:function(){var f=$("#kpitable").datagrid("getChecked");if(f==null||f.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}if(confirm("是否确认删除？")){var d=$("#mydatatree").tree("getSelected");var c="";var e="";for(i=0;i<f.length;i++){c=c+f[i].id;e=e+f[i].kpiDescKey;if(i!=f.length-1){c=c+",";e=e+","}}$.ajax({type:"POST",url:"Kpi!delKpi.action",dataType:"html",data:{kpiId:c,kpiDescKey:e},success:function(g){$("#kpitable").datagrid("load",{groupId:(d.id=="zb"?"":d.id),t:Math.random()})}})}}}]})}function newkpi(h,d,g){var f;if(h){$.ajax({type:"POST",async:false,url:"Kpi!getKpi.action",dataType:"json",data:{kpiId:g.id},success:function(k){f=k;curTmpInfo.kpi=k}})}var a="";$.ajax({type:"POST",async:false,url:"Kpi!listGroup.action",dataType:"json",data:{},success:function(l){for(var k=0;k<l.length;k++){a=a+'<option value="'+l[k].id+'" '+(f&&f.groupid==l[k].id?"selected":"")+">"+l[k].text+"</option>"}}});var c="";for(i=0;i<atp.length;i++){c=c+'<option value="'+atp[i]+'" '+(f&&atp[i]==f.aggre?"selected":"")+">"+atp[i]+"</option>"}var b='<div class="textpanel"><span class="inputtext">指标名称：</span><input type="text" value="'+(f?f.name:"")+'" class="inputform" id="kpiname"><br><span class="inputtext">所属分类：</span><select class="inputform" id="groupid">'+a+'</select><br><span class="inputtext">单位：</span><input type="text" value="'+(f?f.unit:"")+'" style="width:50px;" id="unit">(元、次、分钟、%等)<br/><span class="inputtext">格式化：</span><select class="inputform" name="fmt" id="fmt"><option  value="###,##0" '+(f&&f.fmt=="###,##0"?"selected":"")+'>整数</option><option value="###,##0.00" '+(f&&f.fmt=="###,##0.00"?"selected":"")+' >小数</option><option value="0.00%" '+(f&&f.fmt=="0.00%"?"selected":"")+'>百分比</option></select><br/><span class="inputtext">聚合方式：</span><select id="aggre" class="inputform" >'+c+'</select><br/><span class="inputtext">比例：</span><select id="rate" class="inputform" ><option  value=""></option><option value="1" '+(f&&f.rate==1?"selected":"")+'>1</option><option value="10000" '+(f&&f.rate==10000?"selected":"")+'>10000(万)</option><option value="1000000" '+(f&&f.rate==1000000?"selected":"")+'>1000000(百万)</option><option value="100000000" '+(f&&f.rate==100000000?"selected":"")+'>100000000(亿)</option></select><br/><span class="inputtext">指标解释：</span><input type="text" value="'+(f?f.kpiDesc:"")+'" class="inputform" id="kpinote"><br/></div>';$("#pdailog").dialog({title:h?"编辑指标":"创建指标",width:320,height:300,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",handler:function(){var k=$("#pdailog #kpiname").val();var n=$("#pdailog #groupid").val();var p=$("#pdailog #unit").val();var l=$("#pdailog #fmt").val();var q=$("#pdailog #aggre").val();var o=$("#pdailog #rate").val();var m=$("#pdailog #kpinote").val();if(!h){$.ajax({type:"POST",url:"Kpi!saveKpi.action",data:{kpi_name:k,kpi_table_id:n,unit:p,fmt:l,aggre:q,rate:o,name_desc:m,kpi_desc_key:newGuid(),calc_kpi:0},dataType:"json",success:function(r){$("#kpitable").datagrid("load",{groupId:n,t:Math.random()})}})}else{$.ajax({type:"POST",url:"Kpi!updateKpi.action",data:{rid:curTmpInfo.kpi.id,kpi_name:k,kpi_table_id:n,unit:p,fmt:l,aggre:q,rate:o,name_desc:m,kpi_desc_key:curTmpInfo.kpi.kpiDescKey},dataType:"json",success:function(r){$("#kpitable").datagrid("load",{groupId:n,t:Math.random()})}})}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});var e=$("#mydatatree").tree("getSelected");if(h==false&&d!=null&&d.id!="zb"){$("#pdailog #groupid").val(e.id)}}function newdim(h,c,k){var d;if(h){$.ajax({type:"POST",async:false,url:"Dim!getDim.action",dataType:"json",data:{dimid:k.dimid},success:function(l){d=l;curTmpInfo.dim=l}})}var f='<option value=""></option>';var b='<option value=""></option>';var c=$("#mydatatree").tree("getSelected");var a="";if(d){a=d.gtype}else{a=c.id}$.ajax({type:"POST",async:false,url:"Metadata!listTables.action",dataType:"json",data:{},success:function(m){for(i=0;i<m.tables.length;i++){var l=m.tables[i];f=f+'<option value="'+l.id+'" '+(d&&d.tname!=null&&d.tname.toUpperCase()==l.id.toUpperCase()?"selected":"")+">"+l.text+"</option>"}for(i=0;i<m.groups.length;i++){var l=m.groups[i];b=b+'<option value="'+l.id+'" '+(a==l.id?"selected":"")+">"+l.text+"</option>"}}});var g='<div class="textpanel"><span class="inputtext">维度标识：</span><input type="text" value="'+(d?d.dimname:"")+'" class="inputform" id="dimname"><br><span class="inputtext">中文名：</span><input type="text" value="'+(d?d.dimdesc:"")+'" class="inputform" id="dimdesc"><br/><span class="inputtext">对应表：</span><select id="tname" class="inputform" >'+f+'</select><br/><span class="inputtext">KEY字段：</span><select id="colkey" class="inputform" ></select><br/><span class="inputtext">Text字段：</span><select id="colname" class="inputform" ></select><br/><span class="inputtext">维度排序：</span><select id="dimord" class="inputform" ><option value="asc" '+(d&&d.ord=="asc"?"selected":"")+'>asc</option><option value="desc" '+(d&&d.ord=="desc"?"selected":"")+">desc</option></select>"+(c.id!="wfzw"?'<br/><span class="inputtext">所属分组：</span><select id="groupType" class="inputform" >'+b+"</select>":"")+"</div>";$("#pdailog").dialog({title:h?"编辑维度":"创建维度",width:320,height:300,closed:false,cache:false,modal:true,toolbar:null,content:g,buttons:[{text:"确定",handler:function(){var l=$("#pdailog #dimname").val();var o=$("#pdailog #dimdesc").val();var n=$("#pdailog #tname").val();var p=$("#pdailog #colkey").val();var q=$("#pdailog #colname").val();var r=$("#pdailog #dimord").val();var m=$("#pdailog #groupType").val();if(!h){$.ajax({type:"POST",url:"Dim!saveDim.action",data:{dim_name:l,dim_desc:o,dim_tname:n,dim_type:"frd",col_key:p.split("@")[0],col_name:q,dim_ord:r,group_type:m,key_val_type:p.split("@")[1]},dataType:"json",success:function(t){var s=$("#mydatatree").tree("getSelected");$("#dimtable").datagrid("load",{gtype:(s.id=="wd"?"":s.id),t:Math.random()})}})}else{$.ajax({type:"POST",url:"Dim!updateDim.action",data:{dim_id:curTmpInfo.dim.dimid,dim_name:l,dim_desc:o,dim_tname:n,col_key:p.split("@")[0],col_name:q,dim_ord:r,group_type:m,key_val_type:p.split("@")[1]},dataType:"json",success:function(t){var s=$("#mydatatree").tree("getSelected");$("#dimtable").datagrid("load",{gtype:(s.id=="wd"?"":s.id),t:Math.random()})}})}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});var e=function(l){if(l==""){return}$.ajax({type:"POST",url:"Metadata!listTableCols.action",data:{tname:l},dataType:"json",success:function(o){var n='<option value=""></option>';var m='<option value=""></option>';for(i=0;i<o.length;i++){n=n+'<option value="'+o[i].name+"@"+o[i].type+'" '+(d&&d.colkey.toUpperCase()==o[i].name.toUpperCase()?"selected":"")+">"+o[i].name+"</option>";m=m+'<option value="'+o[i].name+'" '+(d&&d.colname.toUpperCase()==o[i].name.toUpperCase()?"selected":"")+">"+o[i].name+"</option>"}$("#pdailog #colkey").html(n);$("#pdailog #colname").html(m)}})};$("#pdailog #tname").bind("change",function(){e($(this).val())});e($("#pdailog #tname").val())}function delKpiGroup(){var a=$("#mydatatree").tree("getSelected");if(confirm("是否确认删除？")){$.ajax({type:"POST",url:"Kpi!delKpiGroup.action",dataType:"text",data:{groupId:a.id},success:function(b){$("#mydatatree").tree("remove",a.target)},error:function(){$.messager.alert("出错了。","该分类下包含有指标，不能删除。","error")}})}}function delGroup(){var a=$("#mydatatree").tree("getSelected");if(confirm("是否确认删除？")){$.ajax({type:"POST",url:"Dim!delGroup.action",dataType:"html",data:{groupId:a.id},success:function(b){$("#mydatatree").tree("remove",a.target)},error:function(){$.messager.alert("出错了。","该分组下包含有维度，不能删除。","error")}})}}function addGroup(d){var c;if(d){var b=$("#mydatatree").tree("getSelected");$.ajax({type:"POST",async:false,url:"Dim!getGroup.action",dataType:"json",data:{groupId:b.id},success:function(e){c=e}})}var a='<div class="textpanel"><span class="inputtext">分组名称：</span><input type="text" value="'+(c?c.name:"")+'" class="inputform" id="groupname"><br><span class="inputtext">排序：</span><input type="text" value="'+(c?c.ord:"1")+'" class="inputform" id="ord"></div>';$("#pdailog").dialog({title:d?"修改维度分组":"创建维度分组",width:310,height:180,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){var f=$("#pdailog #groupname").val();var e=$("#pdailog #ord").val();if(f==""){msginfo("请填写分组名称。");$("#pdailog #groupname").focus();return}if(isNaN(e)){msginfo("排序字段必须是数字类型。");$("#pdailog #ord").focus();return}if(d==false){var g={group_id:newGuid(),group_name:f,ord:e};$.ajax({type:"POST",url:"Dim!saveGroup.action",dataType:"html",data:g,success:function(h){$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='fzw']"),data:[{id:g.group_id,text:g.group_name,iconCls:"icon-group",attributes:{showmenu:true,type:"dim"}}]})}})}else{var g={group_id:c.id,group_name:f,ord:e};$.ajax({type:"POST",url:"Dim!updateGroup.action",dataType:"html",data:g,success:function(h){$("#mydatatree").tree("update",{target:b.target,text:g.group_name})}})}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function initdsourcetable(){if($("#dsourcetable").size()>0){$("#dsourcetable").datagrid("load",{t:Math.random()});return}var a="<table id=\"dsourcetable\" title=\"数据源管理\" ><thead><tr><th data-options=\"field:'ck',checkbox:true\"><th data-options=\"field:'dsname',width:120,formatter:fb1\">名称</th></th><th data-options=\"field:'use',width:120\">类型</th><th data-options=\"field:'linktype',width:100\">数据库</th><th data-options=\"field:'linkurl',width:250\">连接字符串</th><th data-options=\"field:'linkname',width:120,align:'center'\">用户名</th><th data-options=\"field:'loginName',width:120,align:'center'\">创建人</th></tr></thead></table>";$("#optarea").html(a);$("#dsourcetable").datagrid({singleSelect:true,collapsible:false,pagination:true,pageSize:20,border:false,fit:true,url:"DataSource!list2.action",queryParams:{t:Math.random()},method:"get",toolbar:[{text:"新增",iconCls:"icon-add",handler:function(){newdsource(false)}},{text:"修改",iconCls:"icon-edit",handler:function(){var b=$("#dsourcetable").datagrid("getChecked");if(b==null||b.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}newdsource(true,b[0].dsid)}},{text:"删除",iconCls:"icon-cancel",handler:function(){var b=$("#dsourcetable").datagrid("getChecked");if(b==null||b.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}if(confirm("是否确认删除？")){$.ajax({type:"POST",url:"DataSource!del.action",dataType:"html",data:{dsid:b[0].dsid},success:function(c){$("#dsourcetable").datagrid("load",{t:Math.random()})}})}}}]})}function fb1(e,d,f){if(d.use&&d.use=="jndi"){return d.jndiname}else{return d.dsname}}function fb2(e,d,f){if(d.ttype==1){return"日表"}else{if(d.ttype==2){return"月表"}else{if(d.ttype==3){return"季度表"}else{if(d.ttype==4){return"年表"}}}}}function addKpiGroup(d){var c;if(d==true){var b=$("#mydatatree").tree("getSelected");$.ajax({type:"POST",async:false,url:"Kpi!getGroup.action",dataType:"json",data:{groupId:b.id},success:function(e){c=e;curTmpInfo.kpi=c}})}var a='<div class="textpanel"><span class="inputtext">分类名称：</span><input type="text" id="groupname" class="inputform" value="'+(c?c.name:"")+'"><br/><span class="inputtext">排序：</span><input type="text" id="ord" class="inputform" value="'+(c?c.ord:"1")+'"></div>';$("#pdailog").dialog({title:d?"编辑指标分类":"创建指标分类",width:310,height:210,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var f=$("#pdailog #groupname").val();var e=$("#pdailog #ord").val();if(f==""){msginfo("请录入分类名称！");$("#pdailog #groupname").focus();return}if(isNaN(e)){msginfo("排序字段必须是数字类型。");$("#pdailog #ord").focus();return}if(d){var g=$("#mydatatree").tree("getSelected");$.ajax({type:"POST",url:"Kpi!updateGroup.action",data:{name:f,ord:e,id:g.id},dataType:"text",success:function(h){$("#mydatatree").tree("update",{target:g.target,text:f})}})}else{$.ajax({type:"POST",url:"Kpi!saveGroup.action",data:{name:f,ord:e},dataType:"text",success:function(k){var h=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("append",{parent:h.target,data:[{id:k,text:f,attributes:{showmenu:true,type:"kpi"},iconCls:"icon-kpigroup"}]})}})}$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function newdsource(d,c){var b;if(d){$.ajax({type:"POST",async:false,url:"DataSource!getDs.action",dataType:"json",data:{dsid:c},success:function(e){b=e;curTmpInfo.ds=b}})}var a='<div id="dsource_tab" style="height:auto; width:auto;"><div title="JDBC"><form id="datasourceform" name="datasourceform"><input type="hidden" name="connstate" id="connstate"><div class="textpanel"><span class="inputtext">数据源名称：</span><input type="text" id="dsname" name="dsname" style="width:400px;" value="'+(b&&b.use=="jdbc"?b.dsname:"")+'"><br/><span class="inputtext">数据源类型：</span><select id="linktype" name="linktype" style="width:400px;"><option value="mysql" '+(b&&b.use=="jdbc"&&b.linktype=="mysql"?"selected":"")+'>MYSQL</option><option value="oracle" '+(b&&b.use=="jdbc"&&b.use=="jdbc"&&b.linktype=="oracle"?"selected":"")+'>ORACLE</option><option value="sqlserver" '+(b&&b.use=="jdbc"&&b.linktype=="sqlserver"?"selected":"")+'>SQL Server</option></select><br/><span class="inputtext">连接字符串：</span><input type="text" id="linkurl" name="linkurl" style="width:400px;" value="'+(b&&b.use=="jdbc"?b.linkurl:"jdbc:mysql://ip/database?useUnicode=true&characterEncoding=UTF8")+'"><br/><span class="inputtext">连接用户名：</span><input type="text" id="linkname" name="linkname" style="width:400px;" value="'+(b&&b.use=="jdbc"?b.linkname:"")+'"> <br/><span class="inputtext">连接密码：</span><input type="password" name="linkpwd" id="linkpwd" style="width:400px;" value="'+(b&&b.use=="jdbc"?encoder(b.linkpwd,"decode"):"")+'"></div></form></div><div data-options="'+(b&&b.use=="jndi"?"selected:true":"")+'" title="JNDI"><div class="textpanel"><span class="inputtext">JNDI名称：</span><input type="text" value="'+(b&&b.use=="jndi"?b.jndiname:"")+'" style="width:400px;" name="jndiname" id="jndiname"></div></div></div>';$("#pdailog").dialog({title:d?"编辑数据源":"创建数据源",width:540,height:300,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"测试连接",handler:function(){var f=$("#dsource_tab").tabs("getSelected");var e=$("#dsource_tab").tabs("getTabIndex",f);if(e==0){var g=$("#datasourceform").serialize();$.ajax({type:"POST",url:"../webreport/Data!testConn.action",dataType:"json",data:g,success:function(h){if(h.ret){msginfo("测试成功！","suc");$("#datasourceform #connstate").val("y")}else{msginfo("测试失败！")}}})}else{if(e==1){var g={jndiname:$("#dsource_tab #jndiname").val()};$.ajax({type:"POST",url:"../webreport/Data!testJNDI.action",dataType:"json",data:g,success:function(h){if(h.ret){msginfo("测试成功！","suc");$("#datasourceform #connstate").val("y")}else{msginfo("测试失败！")}}})}}}},{text:"确定",handler:function(){var f=$("#dsource_tab").tabs("getSelected");var e=$("#dsource_tab").tabs("getTabIndex",f);if(e==0){if($("#datasourceform #dsname").val()==""){msginfo("请输入数据源名称！");$("#datasourceform #dsname").focus();return}if($("#datasourceform #connstate").val()!="y"){msginfo("请先测试连接正常再确定！");return}if(d==false){var g={linktype:$("#linktype").val(),linkname:$("#linkname").val(),linkpwd:encoder($("#linkpwd").val(),"encode"),linkurl:$("#linkurl").val(),dsname:$("#datasourceform #dsname").val(),dsid:newGuid(),use:"jdbc"};$.ajax({type:"POST",url:"DataSource!saveds.action",dataType:"html",data:{dsid:g.dsid,content:JSON.stringify(g)},success:function(h){$("#dsourcetable").datagrid("load",{t:Math.random()})}})}else{var g=curTmpInfo.ds;g.linktype=$("#linktype").val();g.linkname=$("#linkname").val();g.linkpwd=encoder($("#linkpwd").val(),"encode");g.linkurl=$("#linkurl").val();g.dsname=$("#datasourceform #dsname").val();$.ajax({type:"POST",url:"DataSource!update.action",dataType:"html",data:{dsid:g.dsid,content:JSON.stringify(g)},success:function(h){$("#dsourcetable").datagrid("load",{t:Math.random()})}})}}else{if(e==1){if($("#dsource_tab #jndiname").val()==""){msginfo("请输入JNDI名称！");$("#dsource_tab #jndiname").focus();return}if($("#datasourceform #connstate").val()!="y"){msginfo("请先测试连接正常再确定！");return}if(d==false){var g={jndiname:$("#dsource_tab #jndiname").val(),dsid:newGuid(),use:"jndi"};$.ajax({type:"POST",url:"DataSource!saveds.action",dataType:"html",data:{dsid:g.dsid,content:JSON.stringify(g)},success:function(h){$("#dsourcetable").datagrid("load",{t:Math.random()})}})}else{var g=curTmpInfo.ds;g.jndiname=$("#jndiname").val();$.ajax({type:"POST",url:"DataSource!update.action",dataType:"html",data:{dsid:g.dsid,content:JSON.stringify(g)},success:function(h){$("#dsourcetable").datagrid("load",{t:Math.random()})}})}}}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #dsource_tab").tabs({fit:true,border:false});$("#pdailog #linktype").change(function(){var e=$(this).val();if(e=="mysql"){$("#pdailog #linkurl").val("jdbc:mysql://ip/database?useUnicode=true&characterEncoding=UTF8")}else{if(e=="oracle"){$("#pdailog #linkurl").val("jdbc:oracle:thin:@ip:1521:sid")}else{if(e=="sqlserver"){$("#pdailog #linkurl").val("jdbc:jtds:sqlserver://ip:1433/database")}}}})}function initCubeList(b){if($("#cubelistdiv").size()==0){$("#metalayout").layout("add",{region:"east",split:true,width:500,title:"立方体管理",collapsible:false,id:"cubelistdiv"})}if($("#cubelist").size()>0){$("#cubelist").datagrid("load",{id:b.id,t:Math.random()});return}var a='<table id="cubelist" title="" ><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'tdesc\',width:160">中文名</th><th data-options="field:\'tname\',width:120">表名</th><th data-options="field:\'ttype\',formatter:fb2,width:100">类型</th></tr></thead></table>';$("#cubelistdiv").append(a);$("#cubelist").datagrid({singleSelect:true,collapsible:false,pagination:false,url:"Cube!list.action",queryParams:{id:b.id,t:Math.random()},fit:true,border:false,toolbar:[{text:"新增",iconCls:"icon-add",handler:function(){newCube(false,b)}},{text:"编辑",iconCls:"icon-edit",handler:function(){var c=$("#cubelist").datagrid("getChecked");if(c==null||c.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}newCube(true,b,c[0].tid)}},{text:"删除",iconCls:"icon-cancel",handler:function(){var c=$("#cubelist").datagrid("getChecked");if(c==null||c.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}if(confirm("是否确认删除？")){$.ajax({type:"POST",url:"Cube!delete.action",dataType:"json",data:{id:c[0].tid},success:function(d){$("#cubelist").datagrid("load",{id:c[0].dsid,t:Math.random()})}})}}}]})}function newCube(h,d,f){var e;if(h==true){$.ajax({type:"POST",async:false,url:"Cube!getTable.action",dataType:"json",data:{id:f},success:function(k){e=k}})}var b='<div id="cubeTabs"><div title="基本信息"><div class="textpanel"><span class="inputtext">名称(表名)：</span><input type="text"  value="'+(e?e.tname:"")+'" id="tname" class="inputform" '+(h==true?'readOnly="true"':"")+">"+(h==true?"(不能更改)":'<input type="button" id="selectTabBtn" value="选择">')+'<br/><span class="inputtext">中 文 名：</span><input type="text"  value="'+(e?e.tdesc:"")+'" id="tdesc" class="inputform"><br/></div></div><div title="维度和指标"><div class="textpanel"><div class="cubetreecls"><div class="cubetitle">表字段</div><ul id="cubelefttree"></ul></div><div class="cubecenter"><p style="height:100px;"></p><input type="button" onclick="ds2cube()" value=">" title="选择"><br><input type="button" title="移除" value="<" onclick="cube2ds()"></div><div class="cubetreecls" style="width:280px;"><div class="cubetitle">立方体结构</div><ul id="cuberighttree"></ul></div><div class="cubebtn"><a href="javascript:;" id="crtkpibtn" data-options="plain:true,iconCls:\'icon-add\'">指标</a><a href="javascript:;" id="dim_editbtn" data-options="plain:true,iconCls:\'icon-edit\'">关联</a><a href="javascript:cube2ds();" id="dim_delbtn" data-options="plain:true,iconCls:\'icon-cancel\'">删除</a></div></div></div></div>';$("#pdailog").dialog({title:h?"编辑立方体":"新建立方体",width:760,height:445,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var t=$("#pdailog #tname").val();if(t==""){msginfo("您还未选择表。");$("#pdailog #cubeTabs").tabs("select",0);$("#pdailog #tname").select();return}var n=$("#pdailog #tdesc").val();if(n==""){msginfo("请填写表的中文名称。");$("#pdailog #cubeTabs").tabs("select",0);$("#pdailog #tdesc").select();return}var q=$("#cuberighttree").tree("getChildren",$("#cuberighttree div[node-id='wd']"));var r=$("#cuberighttree").tree("getChildren",$("#cuberighttree div[node-id='zb']"));if(q==null||q.length==0){msginfo("您还未定义维度。");return}if(r==null||r.length==0){msginfo("您还未定义指标。");return}for(c=0;c<q.length;c++){if(!q[c].attributes.col_id||q[c].attributes.col_id==""){msginfo("维度 "+q[c].attributes.dispName+" 未关联到维度表。");return}}for(c=0;c<r.length;c++){if(!r[c].attributes.col_id||r[c].attributes.col_id==""){msginfo("指标 "+r[c].attributes.dispName+" 未关联到指标表。");return}}var o=false;for(c=0;c<q.length;c++){var k=q[c].attributes.name;if(k=="day"||k=="month"||k=="quarter"||k=="year"){o=true;break}}if(o==false){msginfo("立方体未设置时间类型维度。");return}var l=[];for(c=0;c<q.length;c++){var p=q[c].attributes;l.push({col_type:1,col_id:p.col_id,dim_name:p.name,col_name:p.dispName,ord:c,alias:p.dispName})}var m=[];for(c=0;c<r.length;c++){var p=r[c].attributes;m.push({col_type:2,col_id:p.col_id,col_name:p.col_name,ord:c,alias:p.dispName,jszb:p.jszb,calc:(p.needDate=="y"?1:0)})}var s={dim:l,kpi:m,tname:t,tdesc:n,ds_id:curTmpInfo.subjectId,defCube:$('#pdailog input[name="setDefCube"]:checked').val()};if(h){s.tid=f}$.ajax({type:"POST",url:h?"Cube!updateCube.action":"Cube!saveCube.action",dataType:"json",data:{json:JSON.stringify(s)},success:function(u){$("#cubelist").datagrid("load",{id:s.ds_id,t:Math.random()})}});$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#dim_editbtn,#dim_delbtn,#crtdimgroup,#crtdimbtn,#crtkpibtn").linkbutton();$("#crtkpibtn").click(function(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var l='<div class="actColumn">';$.ajax({type:"POST",async:false,url:"Metadata!listTableCols.action",dataType:"json",data:{tname:$("#pdailog #tname").val()},success:function(m){for(c=0;c<m.length;c++){if(m[c].type!="String"){l=l+'<span class="column" name="'+m[c].name+'">'+m[c].name+"</span>"}}for(c=0;c<atp.length;c++){l=l+'<span class="column" name="'+atp[c]+'()">'+atp[c]+"()</span>"}}});l=l+"</div>";var k='<div class="textpanel"><span class="inputtext">指标别名：</span><input type="text" class="inputform" id="alias" value="">(英文字符) <br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：</span></td><td><textarea name="expression" id="expression" cols="40" style="height:52px;" rows="2"></textarea></td></tr></tbody></table>是否需要时间维： <input type="checkbox" value="y" name="needDate" >是<br/>'+l+"</div>";$("#dsColumn_div").dialog({title:"添加计算指标",width:390,height:270,closed:false,cache:false,modal:true,toolbar:null,content:k,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var m=$("#dsColumn_div #alias").val();var o=$("#dsColumn_div #expression").val();var n=$('#dsColumn_div input[name="needDate"]:checked').val();if(m==""){msginfo("请填写指标别名。");$("#dsColumn_div #alias").focus();return}if(o==""){msginfo("请填写指标计算表达式。");$("#dsColumn_div #expression").focus();return}$("#cuberighttree").tree("append",{parent:$("#cuberighttree div[node-id='zb']"),data:{id:m,text:m+"(未关联)",attributes:{tp:"kpi",drag:true,dispName:m,jszb:1,expression:o,needDate:n},iconCls:"icon-ckpi"}});$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div .actColumn .column").bind("click",function(){var m=$(this).attr("name");insertText2focus(document.getElementById("expression"),m)})});var g=function(){var n=$("#cuberighttree").tree("getSelected");if(n==null||!n.attributes){msginfo("您还未选择需要关联的维度或指标。");return}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var l="";var p=n.attributes.tp;if(p=="dim"){var k="";$.ajax({type:"POST",async:false,url:"Dim!listDims.action",dataType:"json",data:{},success:function(q){for(c=0;c<q.length;c++){k=k+'<option value="'+q[c].id+"@"+(q[c].tname!=null?q[c].tname:q[c].desc)+"@"+q[c].name+'" '+(n.attributes.col_id==q[c].id?"selected":"")+">"+q[c].desc+"("+(q[c].tname!=null?q[c].tname:"")+")</option>"}}});l='<div class="textpanel">表 <b>'+$("#pdailog #tname").val()+"</b> 字段 <b>"+n.id+'</b> <br/>  &nbsp; &nbsp; &nbsp; =>关联到=> <br/> 维度表： <select id="slavetable" style="width:150px;">'+k+"</select> </div>"}else{if(p=="kpi"){var m="";$.ajax({type:"POST",async:false,url:"Kpi!listGroup.action",dataType:"json",data:{},success:function(r){var q=n.attributes.kpigroup;for(c=0;c<r.length;c++){m=m+'<option value="'+r[c].id+'" '+(r[c].id==q?"selected":"")+">"+r[c].text+"</option>"}}});l='<div class="textpanel">表 <b>'+$("#pdailog #tname").val()+"</b> 字段 <b>"+n.id+'</b> <br/>  &nbsp; &nbsp; &nbsp; =>关联到=> <br/> 指标表： <select id="kpiGroups" style="width:110px;">'+m+'</select> <select id="skpi" style="width:110px;"></select><br/>指标表达式：'+(n.attributes.col_name?n.attributes.col_name:"还未关联指标")+"</div>"}}$("#dsColumn_div").dialog({title:"字段关联",width:350,height:(p=="kpi"?240:200),closed:false,cache:false,modal:true,toolbar:null,content:l,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(p=="dim"){var q=$("#dsColumn_div #slavetable").val();n.attributes.col_id=q.split("@")[0];n.attributes.name=q.split("@")[2];$("#cuberighttree").tree("update",{target:n.target,text:n.attributes.dispName+" -> "+q.split("@")[1]})}else{if(p=="kpi"){var q=$("#dsColumn_div #skpi").val();n.attributes.col_id=q.split("@")[0];n.attributes.aggre=q.split("@")[1];if(n.attributes.jszb==1){n.attributes.col_name=n.attributes.expression}else{n.attributes.col_name=n.attributes.aggre+"("+n.attributes.dispName+")"}n.attributes.kpigroup=$("#dsColumn_div #kpiGroups").val();$("#cuberighttree").tree("update",{target:n.target,text:n.attributes.dispName+" -> "+$("#dsColumn_div #skpi").find("option:selected").text()})}}$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});if(p=="kpi"){var o=function(q){$.ajax({type:"POST",url:"Kpi!listKpi2.action",dataType:"json",data:{groupId:q},success:function(t){var s=n.attributes.col_id;var r="";for(c=0;c<t.length;c++){r=r+'<option value="'+t[c].id+"@"+t[c].aggre+'" '+(s==t[c].id?"selected":"")+">"+t[c].name+"</option>"}$("#dsColumn_div #skpi").html(r)}})};$("#dsColumn_div #kpiGroups").change(function(){o($(this).val())});o($("#dsColumn_div #kpiGroups").val())}};$("#dim_editbtn").click(function(){g()});$("#pdailog #cubeTabs").tabs({border:false,fit:true,tabPosition:"left",onSelect:function(l,k){if(k==1){if($("#pdailog #tname").val()!=""){$.ajax({type:"POST",url:"Metadata!listTableCols.action",dataType:"json",data:{tname:$("#pdailog #tname").val(),dsid:(d.dsource==null?"":d.dsource)},success:function(p){var n=[{id:"table_root",text:$("#pdailog #tname").val(),iconCls:"icon-dataset2",children:[]}];for(c=0;c<p.length;c++){n[0].children.push({id:p[c].name,text:p[c].name,iconCls:"icon-dscol",attributes:{type:p[c].type}})}$("#pdailog #cubelefttree").tree({data:n,dnd:false,onDragEnter:function(r,q){return false}});if(e){var o=function(r){var q=null;for(j=0;j<e.dim.length;j++){if(e.dim[j].alias==r){q=e.dim[j]}}if(q==null){for(j=0;j<e.kpi.length;j++){if(e.kpi[j].alias==r){q=e.kpi[j]}}}return q};var m=$("#cubelefttree").tree("getChildren",$("#cubelefttree div[node-id='table_root']"));for(c=0;c<m.length;c++){if(o(m[c].id)!=null){$(m[c].target).attr("hide","y").hide()}}}},error:function(){$.messager.alert("出错了。","表名出错。","error")}})}}}});var a={id:"lft",text:"数据立方体",iconCls:"icon-cube",children:[{id:"wd",text:"维度",iconCls:"icon-dim",children:[]},{id:"zb",text:"指标",iconCls:"icon-kpi",children:[]}]};if(e){for(var c=0;c<e.dim.length;c++){dim=e.dim[c];a.children[0].children.push({id:dim.colname,text:dim.colname+" -> "+(dim.tname==null?dim.dimdesc:dim.tname),iconCls:"icon-dim",attributes:{tp:"dim",drag:true,dispName:dim.colname,name:dim.dimname,col_id:dim.colid}})}for(var c=0;c<e.kpi.length;c++){kpi=e.kpi[c];a.children[1].children.push({id:kpi.alias,text:kpi.alias+" -> "+kpi.kpiname,iconCls:(kpi.jszb==1?"icon-ckpi":"icon-kpi"),attributes:{tp:"kpi",drag:true,dispName:kpi.alias,col_id:kpi.colid,kpigroup:kpi.groupid,aggre:kpi.aggre,col_name:kpi.colname,jszb:kpi.jszb,expression:(kpi.jszb==1?kpi.colname:""),needDate:(kpi.calc==1?"y":"")}})}}$("#pdailog #cuberighttree").tree({data:[a],dnd:true,onBeforeDrag:function(k){if(k.attributes&&k.attributes.drag){return true}else{return false}},onDragEnter:function(m,l){var k=$("#cuberighttree").tree("getNode",m);if(!k.attributes||k.attributes.drag==false){return false}if(l.attributes.tp=="kpi"&&k.attributes.tp=="dim"){return false}if(k.attributes.tp=="kpi"&&l.attributes.tp=="dim"){return false}return true},onBeforeDrop:function(n,m,k){var l=$("#cuberighttree").tree("getNode",n);if(!l.attributes||l.attributes.drag==false){return false}if(l.attributes.tp=="kpi"&&k=="append"){return false}if(l.attributes.tp=="dim"&&k=="append"){return false}if(m.attributes.tp=="kpi"&&l.attributes.tp=="dim"){return false}if(l.attributes.tp=="kpi"&&m.attributes.tp=="dim"){return false}return true},onDrop:function(m,l,k){},onDblClick:function(){g()}});$("#pdailog #selectTabBtn").bind("click",function(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var k="";$.ajax({type:"POST",async:false,url:"Metadata!listTables2.action",dataType:"json",data:{dsid:(d.dsource==null?"":d.dsource)},success:function(l){for(c=0;c<l.length;c++){k=k+'<input type="radio" id="tableId" name="tableId" value="'+l[c].id+'">'+l[c].text+"<br/>"}}});$("#dsColumn_div").dialog({title:"选择表",width:350,height:260,closed:false,cache:false,modal:true,toolbar:null,content:k,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var l=$('input[name="tableId"]:checked').val();if(!l||l==null){msginfo("请至少选择一个数据表！");return}$("#pdailog #tname").val(l);$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})})}function ds2cube(){var c=$("#cubelefttree").tree("getSelected");if(c==null||!c.attributes){msginfo("请先从左边树选择字段。");return}if($(c.target).attr("hide")=="y"){return}var a=$("#cuberighttree").tree("getSelected");if(a==null){msginfo("再从右边选择维度或指标。");return}var b=$("#cuberighttree").tree("getParent",a.target);if(b==null){msginfo("再从右边选择维度或指标。");return}if(a.text=="指标"||b.text=="指标"){$("#cuberighttree").tree("append",{parent:$("#cuberighttree div[node-id='zb']"),data:{id:c.id,text:c.text+"(未关联)",attributes:{tp:"kpi",drag:true,aggre:"sum",dispName:c.text,calc:0,jszb:0},iconCls:"icon-kpi"}});$(c.target).attr("hide","y").hide()}else{if(a.text=="维度"||b.text=="维度"){$("#cuberighttree").tree("append",{parent:$("#cuberighttree div[node-id='wd']"),data:{id:c.id,text:c.text+"(未关联)",attributes:{tp:"dim",drag:true,dispName:c.text},iconCls:"icon-dim"}});$(c.target).attr("hide","y").hide()}}}function cube2ds(){var c=$("#cuberighttree").tree("getSelected");if(c==null){msginfo("您还未选择需要删除的度量或维度。");return}var b=$("#cubelefttree").tree("getParent",c.target);if(!(b!=null&&(b.text=="指标"||b.text=="维度"))){return}var e=c.id;var a=$("#cubelefttree").tree("getRoot");var d=$("#cubelefttree").tree("getChildren",a.target);for(i=0;i<d.length;i++){if(d[i].id==e){$(d[i].target).attr("hide","n").show();break}}$("#cuberighttree").tree("remove",c.target)}function initSubjectList(b){if($("#subjectlist").size()>0){$("#subjectlist").datagrid("load",{id:(b.id=="zty"?"0":b.id),t:Math.random()});return}var a="<table id=\"subjectlist\" title=\"分析主题列表\" ><thead><tr><th data-options=\"field:'ck',checkbox:true\"><th data-options=\"field:'name',width:160\">名称</th><th data-options=\"field:'fl',width:120\">分类</th><th data-options=\"field:'note',width:300\">说明</th><th data-options=\"field:'mindt',width:100,align:'center'\">最小时间</th><th data-options=\"field:'maxdt',width:100,align:'center'\">最大时间</th></tr></thead></table>";$("#optarea").html(a);$("#subjectlist").datagrid({singleSelect:true,collapsible:false,pagination:true,pageSize:20,fit:true,border:false,url:"SubjectManager!listSubject.action",method:"get",queryParams:{id:(b.id=="zty"?"0":b.id),t:Math.random()},onSelect:function(d,c){curTmpInfo.subjectId=c.id;initCubeList(c)},toolbar:[{text:"新增",iconCls:"icon-add",handler:function(){addSubject(false)}},{text:"编辑",iconCls:"icon-edit",handler:function(){var c=$("#subjectlist").datagrid("getChecked");if(c==null||c.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}addSubject(true,c[0].id)}},{text:"设置",iconCls:"icon-set",handler:function(){var e=$("#subjectlist").datagrid("getChecked");if(e==null||e.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}var d="";$.ajax({type:"GET",url:"SubjectManager!queryCubes.action",dataType:"json",async:false,data:{id:e[0].id},success:function(f){for(i=0;i<f.length;i++){d=d+'<option value="'+f[i].id+'" '+(e[0].defTid==f[i].id?"selected":"")+">"+f[i].name+"</option>"}}});var c='<div class="textpanel"><input type="checkbox" name="setDefSubject" id="setDefSubject" value="y">设置为多维分析默认分析主题？ </div>';$("#pdailog").dialog({title:"分析主题设置",width:330,height:200,closed:false,cache:false,modal:true,toolbar:null,content:c,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var f=$("#pdailog #cubeId").val();var g=$('#pdailog input[name="setDefSubject"]:checked').val();$.ajax({type:"POST",url:"SubjectManager!updateCubeId.action",dataType:"html",data:{id:e[0].id,defTid:f,setDefSubject:g},success:function(k){var h=$("#mydatatree").tree("getSelected");$("#subjectlist").datagrid("load",{id:(h==null?"0":h.id),t:Math.random()})}});$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}},{text:"删除",iconCls:"icon-cancel",handler:function(){var c=$("#subjectlist").datagrid("getChecked");if(c==null||c.length==0){$.messager.alert("出错了。","您还未勾选数据。","error");return}if(confirm("是否确认删除？")){$.ajax({type:"GET",url:"SubjectManager!delSubject.action",dataType:"HTML",data:{id:c[0].id},success:function(e){var d=$("#mydatatree").tree("getSelected");$("#subjectlist").datagrid("load",{id:(d==null?"0":d.id),t:Math.random()})},error:function(){$.messager.alert("出错了。","当前主题下含有立方体，不能删除。","error")}})}}}]})}function delType(){if(confirm("是否确认删除？")){var a=$("#mydatatree").tree("getSelected");if($("#mydatatree").tree("getChildren",a.target).length>0){$.messager.alert("出错了。","当前分类含有子分类，不能删除。","error");return}$.ajax({type:"GET",url:"SubjectManager!delType.action",dataType:"HTML",data:{id:a.id},success:function(b){$("#mydatatree").tree("remove",a.target)},error:function(){$.messager.alert("出错了。","当前分类下含有主题，不能删除。","error")}})}}function addSubject(f,b){var d=$("#mydatatree").tree("getSelected");var e;if(f){$.ajax({type:"GET",async:false,url:"SubjectManager!getSubject.action",dataType:"JSON",data:{id:b},success:function(g){e=g}})}var c='<option value="">(当前默认)</option>';$.ajax({type:"GET",async:false,url:"DataSource!list.action?T="+Math.random(),dataType:"JSON",data:{id:b},success:function(g){for(j=0;j<g.length;j++){c=c+'<option value="'+g[j].dsid+'" '+(e&&e.dsource==g[j].dsid?"selected":"")+">"+(g[j].use&&g[j].use=="jndi"?g[j].jndiname:g[j].dsname)+"</option>"}}});var a='<div style="margin:10px;"><span class="inputtext">主题名称：</span><input type="text" id="name" class="inputform" value="'+(e?e.name:"")+'"><br/><br/><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td width="70" valign="top"><span class="inputtext">说明信息：</span></td><td><textarea name="note" style="width:200px;" id="note" rows="2">'+(e?e.note:"")+'</textarea></td></tr></tbody></table><br/><span class="inputtext">数据源：</span><select id="dsource" class="inputform">'+c+'</select><br/><br/><span class="inputtext">所属分类：</span><input type="text" id="typeSelect" value="'+(e?e.pid:(d&&d.id!="zty"?d.id:""))+'"><br/><br/>';a=a+'<span class="inputtext">数据时间区间：</span><input type="text" id="mindt" style="width:73px;" value="'+(e?e.mindt:"19800101")+'"> - <input type="text" id="maxdt" style="width:73px;" value="'+(e?e.maxdt:"20141231")+'">(格式：yyyyMMdd)<br/><br/><span class="inputtext">排序：</span><input type="text" id="ord" value="1" class="inputform" value="'+(e?e.ord:"")+'"></div>';$("#pdailog").dialog({title:f?"修改分析主题":"新建分析主题",width:430,height:335,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var l=$("#pdailog #name").val();var n=$("#pdailog #note").val();var k=$("#pdailog #dsource").val();var h=$("#pdailog #ord").val();var m=$("#pdailog #mindt").val();var o=$("#pdailog #maxdt").val();var g=$("#pdailog #typeSelect").combotree("getValue");if(l==""){msginfo("请录入主题名称！");$("#pdailog #name").focus();return}if(g==""){msginfo("请选择主题所属分类！");return}if(isNaN(h)){msginfo("排序字段必须是数字类型。");$("#pdailog #ord").focus();return}if(f==false){$.ajax({type:"POST",url:"SubjectManager!saveSubject.action",data:{name:l,note:n,ord:h,pid:g,mindt:m,maxdt:o,dsource:k},success:function(p){$("#subjectlist").datagrid("load",{id:g,t:Math.random()})}})}else{$.ajax({type:"POST",url:"SubjectManager!updateSubject.action",dataType:"text",data:{name:l,note:n,ord:h,pid:g,mindt:m,maxdt:o,dsource:k,ds_id:b},success:function(p){$("#subjectlist").datagrid("load",{id:g,t:Math.random()})}})}$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#typeSelect").combotree({url:"SubjectManager!allTree.action"})}function addSubType(d){var b=$("#mydatatree").tree("getSelected");var c;if(d){$.ajax({type:"GET",async:false,url:"SubjectManager!getType.action",dataType:"JSON",data:{id:b.id},success:function(e){c=e}})}var a='<div class="textpanel"><span class="inputtext">分类名称：</span><input type="text" id="name" class="inputform" value="'+(c?c.name:"")+'"><br/><span class="inputtext">分类说明：</span><input type="text" id="note" class="inputform" value="'+((c&&c.note!=null?c.note:""))+'"><br/><span class="inputtext">排序：</span><input type="text" id="ord" class="inputform" value="'+(c&&c.ord!=null?c.ord:"1")+'"><br/></div>';$("#pdailog").dialog({title:d?"修改分类":"新建分类",width:330,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var f=$("#pdailog #name").val();var g=$("#pdailog #note").val();var e=$("#pdailog #ord").val();if(isNaN(e)){alert("排序字段必须是数字类型。");return}if(d==false){$.ajax({type:"POST",url:"SubjectManager!saveTypes.action",dataType:"text",data:{name:f,note:g,ord:e,pid:(b.id=="zty"?"0":b.id)},success:function(h){$("#mydatatree").tree("append",{parent:b.target,data:[{id:h,text:f,iconCls:"icon-subject3",attributes:{showmenu:true,type:"subject"}}]})}})}else{$.ajax({type:"POST",url:"SubjectManager!updateType.action",dataType:"text",data:{name:f,note:g,ord:e,ds_id:b.id},success:function(h){$("#mydatatree").tree("update",{target:b.target,text:f})}})}$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]})}function msginfo(a,c){var b=null;if(c&&c=="suc"){b="<div class='msginfo msgsuc'>"+a+"</div>"}else{b="<div class='msginfo msgerr'>"+a+"</div>"}$.messager.show({title:(c&&c=="suc")?"成功了":"出错了",msg:b,showType:"fade",timeout:2000,style:{right:"",top:document.body.scrollTop+document.documentElement.scrollTop+10,bottom:""}})}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a}function encoder(h,g){var f=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","7","8","9","0",".","-","*","/","'",":",";",">","<","~","!","@","#","$","%","^","&","(",")","{","}","[","]","|","_"];var e=["T","l","m",">","S","&","J","G","/","!","p","h","Z","7","q","_","U","(","0","a","X","f","^","@","D","~","M","t","O","6","9","C","N","K","H","g","w","4","F","<","e","2","R","o","$","d","V","v","]","#","[","L","r","b","Y","{","z","k","x","n","5","B","W","-","A","P","1","j","E","u","s","'","I","c","%",".","i","y","Q","*",")","3","8","}",";",":","|"];var a=function(m,c){var n=-1;for(var l=0;l<c.length;l++){if(m==c[l]){n=l;break}}return n};var d="";if(g=="encode"){for(var b=0;b<h.length;b++){var k=h.charAt(b);d=d+e[a(k,f)]}}else{if(g=="decode"){for(var b=0;b<h.length;b++){var k=h.charAt(b);d=d+f[a(k,e)]}}}return d}function insertText2focus(e,f){e.focus();if(document.selection){var d=document.selection.createRange();d.text=f}else{if(typeof e.selectionStart=="number"&&typeof e.selectionEnd=="number"){var c=e.selectionStart,b=e.selectionEnd,g=c,a=e.value;e.value=a.substring(0,c)+""+f+a.substring(b,a.length);g+=f.length;e.selectionStart=e.selectionEnd=g}else{e.value+=f}}};