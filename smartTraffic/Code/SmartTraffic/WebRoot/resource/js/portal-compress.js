if($==undefined){$=jQuery}var layout={};layout.l1_json={tr1:[{colspan:1,rowspan:1,width:100,height:100,id:1}]};layout.l2_json={tr1:[{colspan:1,rowspan:1,width:50,height:100,id:1},{colspan:1,rowspan:1,width:50,height:100,id:2}]};layout.l3_json={tr1:[{colspan:2,rowspan:1,width:100,height:50,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:50,id:2},{colspan:1,rowspan:1,width:50,height:50,id:3}]};layout.l4_json={tr1:[{colspan:2,rowspan:1,width:100,height:33,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:33,id:2},{colspan:1,rowspan:1,width:50,height:33,id:3}],tr3:[{colspan:2,rowspan:1,width:100,height:33,id:4}]};layout.l5_json={tr1:[{colspan:2,rowspan:1,width:100,height:20,id:1}],tr2:[{colspan:1,rowspan:1,width:50,height:20,id:2},{colspan:1,rowspan:1,width:50,height:20,id:3}],tr3:[{colspan:2,rowspan:1,width:100,height:20,id:4}],tr4:[{colspan:1,rowspan:1,width:50,height:20,id:5},{colspan:1,rowspan:1,width:50,height:20,id:6}],tr5:[{colspan:2,rowspan:1,width:100,height:20,id:7}]};function backpage(){if(curTmpInfo.isupdate==true){if(confirm("您已对页面进行了修改，是否保存再退出？")){savepage();if(pageInfo.id&&pageInfo.id!=""){location.href="PortalIndex!show.action?pageId="+pageInfo.id}else{location.href="PortalIndex.action"}}else{if(pageInfo.id&&pageInfo.id!=""){location.href="PortalIndex!show.action?pageId="+pageInfo.id}else{location.href="PortalIndex.action"}}}else{if(pageInfo.id&&pageInfo.id!=""){location.href="PortalIndex!show.action?pageId="+pageInfo.id}else{location.href="PortalIndex.action"}}}function resetComppos(){for(var d=1;true;d++){var f=pageInfo.body["tr"+d];if(!f||f==null){break}for(var c=0;c<f.length;c++){var g=f[c];g.children=[];var e=$("#layout_"+g.id).children();if(e&&e.size()>0){var a=e;for(var b=0;a&&b<a.size();b++){g.children.push(findCompById(a[b].id.replace("c_","")))}}}}}function savepage(){resetComppos();var a=pageInfo.id;if(a==undefined||a==null){a=""}if(a==""){$.messager.prompt("仪表盘保存","请输入新的仪表盘名称？",function(b){if(b){$.ajax({type:"POST",url:"PortalIndex!save.action",async:false,data:{pageInfo:JSON.stringify(pageInfo),pageName:b},success:function(c){pageInfo.id=c;msginfo("保存成功！","suc");curTmpInfo.isupdate=false}})}})}else{$.post("PortalIndex!save.action",{pageInfo:JSON.stringify(pageInfo),pageId:a},function(b){msginfo("保存成功！","suc");curTmpInfo.isupdate=false})}}function selectcomp(){var a="<div class=\"textpanel\">(直接拖拽组件到操作区中。)<div class='exportpanel'><span class='exptp' tp='text'>文本</span><span class='exptp' tp='table'>表格</span><span class='exptp' tp='chart' ctp='line'>曲线图</span><span class='exptp' tp='chart' ctp='area'>面积图</span><span class='exptp' tp='chart' ctp='column'>柱状图</span><span class='exptp' tp='chart' ctp='bar'>条形图</span><span class='exptp' tp='chart' ctp='pie'>饼图</span><span class='exptp' tp='chart' ctp='gauge'>仪表盘</span><span class='exptp' tp='chart' ctp='radar'>雷达图</span><span class='exptp' tp='chart' ctp='scatter'>散点图</span><span class='exptp' tp='chart' ctp='bubble'>气泡图</span><span class='exptp' tp='chart' ctp='map'>地图</span></div></div>";$("#pdailog").dialog({title:"选择组件",width:400,height:270,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"关闭",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog .exportpanel span.exptp").draggable({proxy:function(d){var c=$(d).width();var b=$(d).height();var e=$('<div style="border:1px solid #999999;background-color:#cccccc; opacity:0.5; filter:alpha(opacity=50); width:'+c+"px; height:"+b+'px;">'+($(d).text())+"</div>");e.appendTo("body");return e},revert:false,onStartDrag:function(b){$("#pdailog").dialog("close")}})}function helper(){var a='<div class="window_ctx">您可以通过拖拽的方式，定义自己的数据仪表盘，仪表盘支持图形、表格、文本、日历、地图等多种展现方式。<br/>1.选择数据。<br/><img src="../resource/img/ybp1.gif"><br/>2.选择组件。<br/><img src="../resource/img/ybp2.gif"><br/>3.配置组件数据。<br/><img src="../resource/img/ybp3.gif"><br/>4.配置组件属性。<br/><img src="../resource/img/ybp4.gif"><br/>睿思BI-数据仪表盘V2.0 <br/> <b>北京睿思科技有限公司 版权所有</b></div>';$("#pdailog").dialog({title:"帮助",width:730,height:440,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"关闭",handler:function(){$("#pdailog").dialog("close")}}]})}function selectdataset(){$("#pdailog").dialog({title:"选择数据",width:620,height:400,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px;">数据分类： <input id="subjectCubeSelect" style="width:200px;"></div><table id="subjectlist" title="" style="width:610px;height:300px;" ><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:160">名称</th><th data-options="field:\'fl\',width:100">分类</th><th data-options="field:\'note\',width:300">说明</th></tr></thead></table>',buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var a=$("#subjectlist").datagrid("getChecked");if(a==null||a.length==0){msginfo("请勾选数据。");return}pageInfo.selectDs=a[0].defTid;$("#pdailog").dialog("close");curTmpInfo.isupdate=true;reloadDatasetTree()}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#subjectCubeSelect").combotree({url:"../report/SubjectManager!tree.action",onClick:function(a){$("#subjectlist").datagrid("load",{id:a.id,t:Math.random()})}});$("#subjectlist").datagrid({singleSelect:true,collapsible:false,pagination:true,pageSize:20,border:true,url:"../report/SubjectManager!listSubject.action",method:"post",queryParams:{id:"0",t:Math.random()}})}function reloadDatasetTree(){$("#datasettree").tree({url:"../bireport/DataSet!tree.action?selectDsIds="+(pageInfo.selectDs?pageInfo.selectDs:""),dnd:true,lines:true,onBeforeDrag:function(a){if(!a.attributes||a.attributes.tp=="root"){return false}return true},onDragEnter:function(b,a){return false}})}function setlayout(){var ctx='<div class="textpanel"><br/>';for(var i=1;i<=6;i++){ctx=ctx+'<span class="rlayout"><img src="../resource/img/layout/l'+i+'.png"><br/><input type="radio" name="sellayout" value="'+i+'" '+(i==pageInfo.layout?"checked":"")+" ></span>"}ctx=ctx+"</div>";$("#pdailog").dialog({title:"设置仪表盘布局",width:430,height:340,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:ctx,buttons:[{text:"确定",handler:function(){var comps=curTmpInfo.comps;var s=$('input[name="sellayout"]:checked').val();pageInfo.layout=Number(s);var json=null;if(s==1){json=layout.l1_json}else{if(s==2){json=layout.l2_json}else{if(s==3){json=layout.l3_json}else{if(s==4){json=layout.l4_json}else{if(s==5){json=layout.l5_json}else{if(s==6){$("#pdailog").dialog("close");autoLayout();return}}}}}}pageInfo.body=json=eval("("+JSON.stringify(json)+")");var ids=[];for(i=0;comps&&i<comps.length;i++){ids.push(comps[i])}json.tr1[0].children=ids;crtLayoutHTML(json,true);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function autoLayout(){var b=function(n){var l='<table border="0" cellspacing="0" cellpadding="0" class="r_layout" id="autoLayoutTable">';for(var m=1;true;m++){var o=n["tr"+m];if(!o||o==null){break}l=l+"<tr>";for(var h=0;h<o.length;h++){var p=o[h];l=l+'<td class="laytd" height="'+p.height+'%" width="'+p.width+'%" colspan="'+p.colspan+'" rowspan="'+p.rowspan+'" pos="'+((m-1)+","+h)+'">';l=l+"&nbsp; </td>"}l=l+"</tr>"}l=l+"</table>";return l};var c=pageInfo.body;var a=b(c);$("#pdailog").dialog({title:"自定义布局",width:540,height:350,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"确定",handler:function(){var o={};var t=document.getElementById("autoLayoutTable").rows;var p=0;for(var n=0;n<t.length;n++){var r=t[n].cells;var m=[];o["tr"+(n+1)]=m;for(var h=0;h<r.length;h++){var q=$(r[h]);var l={};l.colspan=q.attr("colspan")?q.attr("colspan"):"1";l.rowspan=(q.attr("rowspan")?q.attr("rowspan"):"1");l.height=Number(q.attr("height").replace("%",""));l.width=Number(q.attr("width").replace("%",""));l.id=p;p=p+1;m.push(l)}}pageInfo.body=json=o;for(var n=0;curTmpInfo.comps&&n<curTmpInfo.comps.length;n++){if(!json.tr1[0].children){json.tr1[0].children=[]}json.tr1[0].children.push(curTmpInfo.comps[n])}initlayout(false);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});var f=function(h){$("#autoLayoutTable td").removeClass("tdselect");$(h).addClass("tdselect")};var e=function(n,h){$("#autoLayoutTable td").removeClass("tdselect");var m=$(n).attr("pos").split(",");var l=$(h).attr("pos").split(",");if(m[0]>l[0]||m[1]>l[1]){tmp=m;m=l;l=tmp}for(i=m[0];i<=l[0];i++){for(j=m[1];j<=l[1];j++){$("#autoLayoutTable td[pos='"+(i+","+j)+"']").addClass("tdselect")}}};var d=false;var g=null;$("#autoLayoutTable td").live("click",function(){f(this)}).live("mousedown",function(h){d=true;g=this}).live("mouseup",function(h){d=false}).live("mousemove",function(h){if(d){e(g,this)}}).live("contextmenu",function(h){h.preventDefault();h.stopPropagation();curTmpInfo.curtabtd=this;if($("#autoLayoutTable td.tdselect").size()<=1){f(this)}if($(this).attr("colspan")>1||$(this).attr("rowspan")>1){$("#autolayoutmenu").menu("enableItem",$("#lyt_unmergeCell"))}else{$("#autolayoutmenu").menu("disableItem",$("#lyt_unmergeCell"))}$("#autolayoutmenu").menu("show",{left:h.pageX,top:h.pageY})})}function lyt_mergeCell(){var c=null;var b=null;var a=$("#autoLayoutTable td.tdselect").size();if(a<=1){return}$("#autoLayoutTable td.tdselect").each(function(d,e){if(d==0){c=$(this).attr("pos").split(",")}if(d==a-1){b=$(this).attr("pos").split(",")}if(d>0){$(this).remove()}});$("#autoLayoutTable td.tdselect").attr("rowspan",Math.abs(c[0]-b[0])+1).attr("colspan",Math.abs(c[1]-b[1])+1);updateHeightWidth(true)}function lyt_unmergeCell(){var g=$(curTmpInfo.curtabtd);var f=g.attr("colspan")?g.attr("colspan"):1;var c=g.attr("rowspan")?g.attr("rowspan"):1;g.attr("colspan",1);g.attr("rowspan",1);var b=g;for(i=1;i<=c;i++){for(j=1;j<(i==1?f:Number(f)+1);j++){var d="";d=d+'<td class="laytd"></td>';var a=true;if(i==1){b=g}else{var e=g.attr("pos").split(",");if(e[1]>0){b=$("#autoLayoutTable td[pos='"+((Number(e[0])+(i-1))+","+(Number(e[1])-1<=0?0:Number(e[1])-1))+"']")}else{a=false;b=$("#autoLayoutTable td[pos='"+((Number(e[0])+(i-1))+","+(Number(e[1])+Number(f)))+"']")}}if(a){b.after(d);b=b.next()}else{b.before(d);b=b.prev()}}}updateHeightWidth()}function lyt_insertRow(){var f=curTmpInfo.curtabtd;var d=document.getElementById("autoLayoutTable").rows[0].cells.length;var b=0;for(var c=0;c<d;c++){var a=document.getElementById("autoLayoutTable").rows[0].cells[c];b=b+($(a).attr("colspan")?Number($(a).attr("colspan")):1)}var e="<tr>";for(i=0;i<b;i++){e=e+'<td class="laytd">';e=e+"</td>"}e=e+"</tr>";$(f).parent().after(e);updateHeightWidth()}function lyt_insertCol(){var e=curTmpInfo.curtabtd;var b=document.getElementById("autoLayoutTable").rows;var a=-1;$(e).parent().children().each(function(f,g){if(g==e){a=f}});for(i=0;i<b.length;i++){var d=$(b[i].cells[a]);var c='<td class="laytd"></td>';d.after(c)}updateHeightWidth()}function lyt_deleteCol(){var d=curTmpInfo.curtabtd;var b=document.getElementById("autoLayoutTable").rows;var a=-1;$(d).parent().children().each(function(e,f){if(f==d){a=e}});for(i=0;i<b.length;i++){var c=$(b[i].cells[a]);c.remove()}updateHeightWidth()}function lyt_deleteRow(){var a=curTmpInfo.curtabtd;$(a).parent().remove();updateHeightWidth()}function updateHeightWidth(f){var h=document.getElementById("autoLayoutTable").rows[0].cells;var g=0;for(i=0;i<h.length;i++){g=g+Number(($(h[i]).attr("colspan")?$(h[i]).attr("colspan"):1))}var l=document.getElementById("autoLayoutTable").rows;var c=l.length;for(j=0;j<c;j++){h=l[j].cells;for(i=0;i<h.length;i++){var b=((100/g)*($(h[i]).attr("colspan")?Number($(h[i]).attr("colspan")):1));var d=((100/c)*($(h[i]).attr("rowspan")?Number($(h[i]).attr("rowspan")):1));var e=0;for(var a=0;a<i;a++){e=e+($(h[a]).attr("colspan")?Number($(h[a]).attr("colspan")):1)}$(h[i]).attr({width:Math.round(b)+"%",height:Math.round(d)+"%"});if(f&&f==true){}else{$(h[i]).attr({pos:j+","+e})}}}}function initPortalLayout(){var json=pageInfo.body;var cps=[];var ret='<table border="0" style="width:1020px;" cellspacing="0" cellpadding="0" class="r_layout" id="layout_table">';for(var i=1;true;i++){var tr=json["tr"+i];if(!tr||tr==null){break}ret=ret+"<tr>";for(var j=0;j<tr.length;j++){var td=tr[j];ret=ret+'<td class="laytd2" height="'+td.height+'%" width="'+td.width+'%" colspan="'+td.colspan+'" rowspan="'+td.rowspan+'" >';if(td.children){for(var k=0;k<td.children.length;k++){var comp=findTCompById(td.children[k]);var str=compStr(comp,false);ret=ret+str;cps.push(comp)}}ret=ret+"</td>"}ret=ret+"</tr>"}ret=ret+"</table>";$("#optarea").html(ret);for(var i=0;i<cps.length;i++){var comp=cps[i];var url="../"+comp.url;var param=comp.dayParam&&comp.dayParam!=""?"({"+comp.dayParam+":'"+curDt+"'})":"({})";$("#c_"+comp.id+" div.cctx").html("<div style='padding:5px;'>加载中...</div>").load(url,eval(param),function(){})}}function initlayout(){var b=pageInfo.layout;var a=pageInfo.body;crtLayoutHTML(a,true)}function crtLayoutHTML(m,l){var e=[];var f='<table border="0"  style="width:1020px;" cellspacing="0" cellpadding="0" class="r_layout" id="layout_table">';for(var d=1;true;d++){var h=m["tr"+d];if(!h||h==null){break}f=f+"<tr>";for(var c=0;c<h.length;c++){var a=h[c];f=f+'<td class="laytd" height="'+a.height+'%" width="'+a.width+'%" colspan="'+a.colspan+'" rowspan="'+a.rowspan+'" id="layout_'+a.id+'">';if(a.children){for(var b=0;b<a.children.length;b++){var g=addComp(a.children[b],a.id,false);f=f+g;e.push(a.children[b])}}f=f+"</td>"}f=f+"</tr>"}f=f+"</table>";curTmpInfo.comps=e;$("#optarea").html(f);if(l){for(d=0;d<e.length;d++){bindCompEvent(e[d]);if(e[d].type=="table"){tableView(e[d],e[d].id)}else{if(e[d].type=="chart"){chartview(e[d],e[d].id)}}}}$("#layout_table td.laytd").droppable({accept:".cbox,.exptp",onDragEnter:function(q,o){var p=$(this);if(p.children().size()==0){$(".indicator").css({display:"block",left:p.offset().left,top:p.offset().top-3})}else{var n=p.children().last();if(n.attr("id")==$(o).attr("id")){n=n.prev()}if(n.size()==0){$(".indicator").css({display:"block",left:p.offset().left,top:p.offset().top-10})}else{curTmpInfo.id=n.attr("id");curTmpInfo.tp="after";$(".indicator").css({display:"block",left:n.offset().left,top:n.offset().top+n.height()})}}},onDragLeave:function(o,n){},onDrop:function(q,p){$(".indicator").hide();var o=$(p).attr("class");if(o=="exptp"){var n=$(this).attr("id").split("_")[1];var r=$(p).attr("tp");if(r=="text"){insertText("insert",n)}else{if(r=="table"){insertTable(n)}else{if(r=="chart"){insertChart(n,$(p).attr("ctp"))}}}}else{if($(this).children().size()==0){$(this).append(p)}else{if(curTmpInfo.tp=="before"){$("#"+curTmpInfo.id).before(p)}else{$("#"+curTmpInfo.id).after(p)}}}curTmpInfo.isupdate=true}})}function compevent(h){var f=findCompById(h);if(f.type=="chart"||f.type=="table"){}else{return}var a;var d;if(f.type=="chart"&&f.chartJson){a=f.chartJson.link;d=f.chartJson.linkAccept}else{if(f.tableJson){a=f.tableJson.link;d=f.tableJson.linkAccept}}var g='<select id="linkcomp" name="linkcomp" class="inputform"><option value=""></option>';for(i=0;i<curTmpInfo.comps.length;i++){var b=curTmpInfo.comps[i];if(b.type=="chart"||b.type=="table"){if(b.id!=h){g=g+'<option value="'+b.id+'" '+(a&&a.target==b.id?"selected":"")+" >"+b.name+"</option>"}}}g=g+"</select>";var c=function(n){var m="";$.ajax({type:"post",url:"../bireport/Dim!queryDims.action",data:{tableId:n},dataType:"json",async:false,success:function(o){for(k=0;k<o.length;k++){m=m+'<option value="'+o[k].col_name+'" '+(d&&d.col==o[k].col_name?"selected":"")+">"+o[k].dim_desc+"</option>"}}});return m};var e='<select id="acceptCol" name="acceptCol" class="inputform"><option value=""></option>';e=e+c(f.tid);e=e+"</select>";var l='<div id="compevent_tab" style="height:auto; width:auto;"><div title="事件发起"><div class="textpanel"><span class="inputtext">联动组件：</span>'+g+'<br/> &nbsp; &nbsp; ->或-> <br/><span class="inputtext">链接到URL：</span><input type="text" name="linkurl" id="linkurl" class="inputform" value="'+(a&&a.url?a.url:"")+'"><br/><a href="javascript:;" id="cleanPostEvent">清除事件发起</a></div></div><div title="事件接收"><div class="textpanel"><span class="inputtext">接收字段：</span>'+e+'<br/><span class="inputtext">默认值：</span><input type="text" name="dftval" id="dftval" class="inputform" value="'+(d&&d.dftval?d.dftval:"")+'"><br/><span class="inputtext">默认值类型：</span><select name="valtype" id="valtype" class="inputform"><option value=""></option><option value="number" '+(d&&d.valType=="number"?"selected":"")+'>数字类型</option><option value="string" '+(d&&d.valType=="string"?"selected":"")+'>字符类型</option></select><br/><a href="javascript:;" id="cleanAcceptEvent">清除事件接收</a></div></div></div>';$("#pdailog").dialog({title:"组件事件设置",width:300,height:(f.type=="table"?290:250),closed:false,cache:false,modal:true,toolbar:null,content:l,buttons:[{text:"确定",handler:function(){var o=$("#pdailog #compevent_tab").tabs("getSelected");var r=$("#pdailog #compevent_tab").tabs("getTabIndex",o);if(r==0){var v=$("#compevent_tab #linkcomp").val();var m=$("#compevent_tab #linkurl").val();var u=$("#compevent_tab #sendCol").val();if(v==""&&m==""){$("#pdailog").dialog("close");return}var t=findCompById(v);if(f.type=="chart"){f.chartJson.link={target:v,type:(t.type=="table"?"cross":t.type),url:m,alias:u}}else{if(f.tableJson){f.tableJson.link={target:v,type:(t.type=="table"?"cross":t.type),url:m,alias:u}}else{msginfo("组件还未定义数据，不能定义事件。")}}}else{var p=$("#compevent_tab #acceptCol").val();var n=$("#compevent_tab #dftval").val();var q=$("#compevent_tab #valtype").val();if(p==""&&n==""){$("#pdailog").dialog("close");return}if(f.type=="chart"){f.chartJson.linkAccept={col:p,dftval:n,valType:q};chartview(f,f.id)}else{if(f.tableJson){f.tableJson.linkAccept={col:p,dftval:n,valType:q}}else{msginfo("组件还未定义数据，不能定义事件。")}}}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #compevent_tab").tabs({border:false,fit:true});$("#compevent_tab #cleanPostEvent").bind("click",function(){$("#compevent_tab #linkcomp").val("");$("#compevent_tab #linkurl").val("");$("#compevent_tab #sendCol").val("");if(f.type=="chart"){delete f.chartJson.link}else{delete f.tableJson.link}});$("#compevent_tab #cleanAcceptEvent").bind("click",function(){$("#compevent_tab #acceptCol").val("");$("#compevent_tab #dftval").val("");$("#compevent_tab #valtype").val("");if(f.type=="chart"){delete f.chartJson.linkAccept;chartview(f,f.id)}else{delete f.tableJson.linkAccept}})}function releasePage(){if(!curTmpInfo.comps||curTmpInfo.comps.length==0){msginfo("您还未添加任何组件。");return}resetComppos();$("#pdailog").dialog({title:"仪表盘发布",width:612,height:420,closed:false,cache:false,modal:true,toolbar:null,content:'<div style="margin:5px;"><span class="inputtext">报表目录：</span><input id="reportcatalist" style="width:200px;"></div><div style="border-bottom:solid 1px #CCCCCC;border-top:solid 1px #CCCCCC;"><table id="reportlist" title="" style="width:600px;height:270px;"><thead><tr><th data-options="field:\'ck\',checkbox:true"><th data-options="field:\'name\',width:320">名称</th><th data-options="field:\'crtdate\',width:100">创建时间</th><th data-options="field:\'loginName\',width:100">创建人</th></tr></thead></table></div><div style="margin:5px;"><span class="inputtext">报表名称：</span><input type="text" style="width:187px" name="rname" id="rname"></div>',onLoad:function(){},buttons:[{text:"确定",handler:function(){var c=$("#pdailog #reportcatalist").combotree("tree").tree("getSelected");if(c==null||c.id=="0"){msginfo("您还未选择仪表盘发布目录。");return}var a=$("#pdailog #rname").val();if(a==""){msginfo("请输入仪表盘名！");$("#pdailog #rname").focus();return}var b=JSON.stringify(pageInfo);$.ajax({type:"POST",url:"PortalIndex!release.action",dataType:"json",data:{pageName:a,cataId:c.id,pageInfo:b},async:false,success:function(d){msginfo("仪表盘发布成功。","suc");pageInfo.releCata=c.id;curTmpInfo.isupdate=true;$("#pdailog").dialog("close")},error:function(){msginfo("仪表盘发布失败，名称存在重复。")}})}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #reportcatalist").combotree({url:"../report/ReportCatalog!tree.action?type=-1",onClick:function(a){$("#reportlist").datagrid("load",{cataId:a.id,t:Math.random()})}});if(pageInfo.releCata){$("#pdailog #reportcatalist").combotree("setValues",[pageInfo.releCata])}$("#pdailog #reportlist").datagrid({singleSelect:true,collapsible:false,border:false,url:"../report/Report!listRelease.action",method:"post",queryParams:{cataId:pageInfo.releCata?pageInfo.releCata:"-1",t:Math.random()},onSelect:function(a,b){$("#pdailog #rname").val(b.name)}})}function msginfo(a,c){var b=null;if(c&&c=="suc"){b="<div class='msginfo msgsuc'>"+a+"</div>"}else{b="<div class='msginfo msgerr'>"+a+"</div>"}$.messager.show({title:(c&&c=="suc")?"成功了":"出错了",msg:b,showType:"fade",timeout:2000,style:{right:"",top:document.body.scrollTop+document.documentElement.scrollTop+10,bottom:""}})}function formatNumber(h,o){if(o.indexOf("%")>0){h=h*100}var b=o?o.split("."):[""];var n="";var t=0;if(b.length>1){t=b[1].length}var d=1;for(g=0;g<t;g++){d=d*10}h=h*d;h=Math.round(h);h=h/d;var q=h?h.toString().split("."):["0"];var p=q[0];var c=b[0];var g=p.length-1;var u=false;for(var m=c.length-1;m>=0;m--){switch(c.substr(m,1)){case"#":if(g>=0){n=p.substr(g--,1)+n}break;case"0":if(g>=0){n=p.substr(g--,1)+n}else{n="0"+n}break;case",":u=true;n=","+n;break}}if(g>=0){if(u){var e=p.length;for(;g>=0;g--){n=p.substr(g,1)+n;if(g>0&&((e-g)%3)==0){n=","+n}}}else{n=p.substr(0,g+1)+n}}n=n+".";p=q.length>1?q[1]:"";c=b.length>1?b[1]:"";g=0;for(var m=0;m<c.length;m++){switch(c.substr(m,1)){case"#":if(g<p.length){n+=p.substr(g++,1)}break;case"0":if(g<p.length){n+=p.substr(g++,1)}else{n+="0"}break}}var a=n.replace(/^,+/,"").replace(/\.$/,"");if(o.indexOf("%")>0){a=a+"%"}return a}function tableUpdateComp(a){var b=jQuery("#"+a.id+" .row-link");b.live("click",function(c){alert("定制模式下点击无效。")})}function chartComp_Link(){alert("定制模式下点击无效。")}function findLayoutById(a){var c=null;for(var d=1;true;d++){var e=pageInfo.body["tr"+d];if(!e||e==null){break}for(var b=0;b<e.length;b++){var f=e[b];if(f.id==a){c=f;break}}}return c}if($==undefined){$=jQuery}function insertChart(a,f){curTmpInfo.charttype=f;var d=newGuid();var c="";if(f=="line"){c=c+"曲线图"}else{if(f=="column"){c=c+"柱状图"}else{if(f=="pie"){c=c+"饼图"}else{if(f=="gauge"){c=c+"仪表盘"}else{if(f=="radar"){c=c+"雷达图"}else{if(f=="scatter"){c=c+"散点图"}else{if(f=="bubble"){c=c+"气泡图"}else{if(f=="map"){c=c+"地图"}else{if(f=="area"){c=c+"面积图"}else{if(f=="bar"){c=c+"条形图"}}}}}}}}}}var b={id:d,name:c,type:"chart"};b.chartJson={type:f,xcol:{},ycol:{},scol:{},params:[],width:(f=="pie"||f=="gauge"?"360":"600"),height:"250",showLegend:"true"};var e=addComp(b,a,true);$("#layout_"+a).append(e);bindCompEvent(b)}function editChartData(g){if($("#dataProperty").size()==0){$("#Jlayout").layout("add",{region:"south",id:"dataProperty",split:false,collapsible:false,height:120,title:"编辑图形数据",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","south")}}]})}else{$("#Jlayout").layout("panel","south").panel("setTitle","编辑图形数据")}var d=findCompById(g);var a=d.chartJson.type;var c=false;var f=false;var b=false;var l=false;c=a=="pie"||a=="gauge";f=a=="bubble"||a=="scatter";b=a=="bubble";l=a=="map";var e='<div class="tsbd">'+(f?'<div class="ts_h">'+(c?"观察维度":"横轴")+'：<div id="y2col" class="h_ctx">'+(d.kpiJson&&d.kpiJson.length>0?'<span title="'+d.kpiJson[1].kpi_name+'" class="charttxt">'+(d.kpiJson[1].kpi_name)+'</span><span onclick="chartmenu(this, '+d.kpiJson[1].kpi_id+",'y2col','"+d.kpiJson[1].kpi_name+"','"+g+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将指标拖到这里</span>')+"</div></div>":'<div class="ts_h">'+(c?"观察维度":(l?"地域维度":"横轴"))+'：<div id="xcol" class="h_ctx">'+(d.chartJson.xcol&&d.chartJson.xcol.id?'<span class="charttxt" title="'+d.chartJson.xcol.dimdesc+'">'+d.chartJson.xcol.dimdesc+'</span><span onclick="chartmenu(this, '+d.chartJson.xcol.id+",'xcol', '"+d.chartJson.xcol.dimdesc+"','"+g+'\')" title="配置" class="charticon"></span>':'<span class="charttip">'+(l?"将地域拖到这里":"将维度拖到这里")+"</span>")+"</div></div>")+'<div class="ts_h">'+(c||l?"指标":"纵轴")+'：<div id="ycol" class="h_ctx">'+(d.kpiJson&&d.kpiJson.length>0?'<span class="charttxt" title="'+d.kpiJson[0].kpi_name+'">'+(d.kpiJson[0].kpi_name)+'</span><span onclick="chartmenu(this, '+d.kpiJson[0].kpi_id+",'ycol','"+d.kpiJson[0].kpi_name+"','"+g+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将指标拖到这里</span>')+"</div></div>"+(b?'<div class="ts_h">气泡大小：<div id="y3col" class="h_ctx">'+(d.kpiJson&&d.kpiJson.length>0?'<span title="'+d.kpiJson[2].kpi_name+'" class="charttxt">'+(d.kpiJson[2].kpi_name)+'</span><span onclick="chartmenu(this, '+d.kpiJson[2].kpi_id+",'y3col','"+d.kpiJson[2].kpi_name+"','"+g+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将指标拖到这里</span>')+"</div></div>":"")+(f?'<div class="ts_h">观察维度：<div id="xcol" class="h_ctx">'+(d.chartJson.xcol&&d.chartJson.xcol.id?'<span class="charttxt" title="'+d.chartJson.xcol.dimdesc+'">'+d.chartJson.xcol.dimdesc+'</span><span onclick="chartmenu(this, '+d.chartJson.xcol.id+",'xcol', '"+d.chartJson.xcol.dimdesc+"','"+g+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将维度拖到这里</span>')+"</div></div>":"")+(b||l?"":'<div class="ts_h" '+(c?'style="display:none"':"")+'>图例：<div id="scol" class="h_ctx">'+(d.chartJson.scol&&d.chartJson.scol.id?'<span class="charttxt" title="'+d.chartJson.scol.dimdesc+'">'+d.chartJson.scol.dimdesc+'</span><span onclick="chartmenu(this,'+d.chartJson.scol.id+", 'scol', '"+d.chartJson.scol.dimdesc+"','"+g+'\')" title="配置" class="charticon"></span>':'<span class="charttip">将维度拖到这里</span>')+"</div></div>")+"</div>";var h='<div style="margin:10px;"><div class="chartDatasty" id="chartData">'+e+"</div></div>";$("#dataProperty").html(h);if(f){initChartByScatter(g)}else{initChartKpiDrop(g)}}function initChartKpiDrop(a){$("#chartData #xcol, #chartData #ycol, #chartData #scol").droppable({accept:"#datasettree .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);var f=b.attributes.col_type;if(f==1&&($(this).attr("id")=="xcol"||$(this).attr("id")=="scol")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#chartData #"+$(this).attr("id")).css("border-color","#ff0000")}if(f==2&&$(this).attr("id")=="ycol"){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#chartData #ycol").css("border-color","#ff0000")}d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#chartData #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,g){var d=findCompById(a);$("#chartData #"+$(this).attr("id")).css("border-color","#7F9DB9");var f=$("#datasettree").tree("getNode",g);h.cancelBubble=true;h.stopPropagation();if(d.tid!=undefined){if(d.tid!=f.attributes.tid){msginfo("您拖入的"+(f.attributes.col_type==2?"指标":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}if(f.attributes.calc_kpi==1){if(!isExistDateDim(d,"chart")){msginfo("您拖入的指标需要图形中有时间类型的维度(年/季度/月/日)。");return}}d.tid=f.attributes.tid;d.tname=f.attributes.tname;d.ttype=f.attributes.ttype;if(d.kpiJson==undefined){d.kpiJson=[]}if(f.attributes.col_type==1){var c=f.attributes.col_id;if(findDimById(c,d.chartJson.params)!=null){msginfo("您拖放的维度已存在于钻取维中，不能拖放。");return}}if(f.attributes.col_type==2&&$(this).attr("id")=="ycol"){d.kpiJson=[];d.kpiJson.push({kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate});d.chartJson.ycol={type:"kpi"};$(this).html('<span class="charttxt" title="'+f.text+'">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycol','"+f.text+"','"+d.id+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,a)}if(f.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(d.chartJson.scol!=undefined&&d.chartJson.scol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.scol!=undefined&&d.chartJson.scol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分类相同，不能拖放。");return}}d.chartJson.xcol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType};$(this).html('<span class="charttxt" title="'+f.text+'">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'xcol', '"+f.text+"','"+d.id+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,a)}if(f.attributes.col_type==1&&$(this).attr("id")=="scol"){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分类相同，不能拖放。");return}}d.chartJson.scol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType};$(this).html('<span class="charttxt" title="'+f.text+'">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+f.attributes.col_id+", 'scol', '"+f.text+"','"+d.id+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,a)}}})}function initChartByScatter(a){$("#chartData #xcol, #chartData #ycol, #chartData #y2col, #chartData #y3col, #chartData #scol").droppable({accept:"#datasettree .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);var f=b.attributes.col_type;if(f==1&&($(this).attr("id")=="scol"||$(this).attr("id")=="xcol")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#chartData #"+$(this).attr("id")).css("border-color","#ff0000")}if(f==2&&($(this).attr("id")=="ycol"||$(this).attr("id")=="y2col"||$(this).attr("id")=="y3col")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#chartData #"+$(this).attr("id")).css("border-color","#ff0000")}d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#chartData #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,g){var d=findCompById(a);$("#chartData #"+$(this).attr("id")).css("border-color","#7F9DB9");var f=$("#datasettree").tree("getNode",g);h.cancelBubble=true;h.stopPropagation();if(d.tid!=undefined){if(d.tid!=f.attributes.tid){msginfo("您拖入的"+(f.attributes.col_type==2?"指标":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}if(f.attributes.calc_kpi==1){if(!isExistDateDim(d,"chart")){msginfo("您拖入的指标需要图形中有时间类型的维度(年/季度/月/日)。");return}}d.tid=f.attributes.tid;d.tname=f.attributes.tname;d.ttype=f.attributes.ttype;if(d.kpiJson==undefined){d.kpiJson=[]}if(f.attributes.col_type==1){var c=f.attributes.col_id;if(findDimById(c,d.chartJson.params)!=null){msginfo("您拖放的维度已存在于钻取维中，不能拖放。");return}}if(f.attributes.col_type==2&&$(this).attr("id")=="ycol"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[1]!=null&&d.kpiJson[1].kpi_id==f.attributes.col_id)||(d.kpiJson[2]!=null&&d.kpiJson[2].kpi_id==f.attributes.col_id)){msginfo("您拖放的指标已存在当前图形中。");return}d.kpiJson[0]={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate};d.chartJson.ycol={type:"kpi"};$(this).html('<span class="charttxt" title="'+f.text+'">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycol','"+f.text+"','"+d.id+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,a)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,a)}}}if(f.attributes.col_type==2&&$(this).attr("id")=="y2col"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[0]!=null&&d.kpiJson[0].kpi_id==f.attributes.col_id)||(d.kpiJson[2]!=null&&d.kpiJson[2].kpi_id==f.attributes.col_id)){msginfo("您拖放的指标已存在当前图形中。");return}var l={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate};d.kpiJson[1]=l;$(this).html('<span class="charttxt" title="'+f.text+'">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'y2col','"+f.text+"','"+d.id+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,a)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,a)}}}if(f.attributes.col_type==2&&$(this).attr("id")=="y3col"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[0]!=null&&d.kpiJson[0].kpi_id==f.attributes.col_id)||(d.kpiJson[1]!=null&&d.kpiJson[1].kpi_id==f.attributes.col_id)){msginfo("您拖放的指标已存在当前图形中。");return}var l={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate};d.kpiJson[2]=l;$(this).html('<span class="charttxt" title="'+f.text+'">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'y3col','"+f.text+"','"+d.id+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,a)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,a)}}}if(f.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(d.chartJson.scol!=undefined&&d.chartJson.scol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.scol!=undefined&&d.chartJson.scol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分类相同，不能拖放。");return}}d.chartJson.xcol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType};$(this).html('<span class="charttxt" title="'+f.text+'">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'xcol', '"+f.text+"','"+d.id+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,a)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,a)}}}if(f.attributes.col_type==1&&$(this).attr("id")=="scol"){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分类相同，不能拖放。");return}}d.chartJson.scol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.alias,tid:d.tid,iscas:f.attributes.iscas,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType};$(this).html('<span class="charttxt" title="'+f.text+'">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+f.attributes.col_id+", 'scol', '"+f.text+"','"+d.id+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,a)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,a)}}}}})}function chartview(c,b){if(c.kpiJson==undefined||c.kpiJson.length==0){return}showloading();var a=JSON.stringify(c.chartJson);var e=JSON.stringify(c.kpiJson);var f=c.ttype;var d="[]";if(pageInfo.params&&pageInfo.params.length>0){d=JSON.stringify(pageInfo.params)}$.ajax({type:"POST",url:"ChartView.action",dataType:"html",data:{chartJson:a,kpiJson:e,kpiType:f,compId:b,params:d},success:function(g){hideLoading();$("#c_"+b+" div.cctx").html(g)},error:function(g){hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function setChartProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:220,title:"图形属性设置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","图形属性设置")}if(!a.style){a.style={}}s=a.style;var c=a.chartJson.type;var b=[];b.push({name:"图形标题",col:"title",value:(a.name?a.name:""),group:"图形属性",editor:"text"});b.push({name:"高度",col:"height",value:(a.chartJson.height?a.chartJson.height:""),group:"图形属性",editor:"numberbox"});b.push({name:"宽度",col:"width",value:(a.chartJson.width?a.chartJson.width:""),group:"图形属性",editor:"numberbox"});if(c!="gauge"){b.push({name:"是否显示图例",col:"showLegend",value:(a.chartJson.showLegend?a.chartJson.showLegend:""),group:"图形属性",editor:{type:"checkbox",options:{on:true,off:false}}})}if(c!="gauge"){b.push({name:"图例位置",col:"legendLayout",value:(a.chartJson.legendLayout?a.chartJson.legendLayout:""),group:"图形属性",editor:{type:"combobox",options:{data:[{text:"vertical",value:"vertical"},{text:"horizontal",value:"horizontal"}]}}})}b.push({name:"事件",col:"compevent",value:"<a href=\"javascript:compevent('"+a.id+"');\">设置</a>",group:"图形属性"});if(c=="pie"||c=="gauge"||c=="scatter"||c=="bubble"||c=="radar"||c=="map"){}else{b.push({name:"标题",col:"dimdesc",value:(a.chartJson.xcol?a.chartJson.xcol.dimdesc:""),group:"横轴",editor:"text"})}if(c=="pie"||c=="gauge"||c=="scatter"||c=="bubble"||c=="radar"||c=="map"){}else{b.push({name:"显示间隔",col:"tickInterval",value:(a.chartJson.xcol&&a.chartJson.xcol.tickInterval?a.chartJson.xcol.tickInterval:""),group:"横轴",editor:"numberbox"})}if(c=="pie"||c=="gauge"||c=="scatter"||c=="bubble"||c=="radar"||c=="map"){}else{b.push({name:"旋转角度",col:"routeXaxisLable",value:(a.chartJson.xcol&&a.chartJson.xcol.routeXaxisLable?a.chartJson.xcol.routeXaxisLable:""),group:"横轴",editor:"numberbox"})}if(c=="gauge"||c=="scatter"||c=="bubble"||c=="radar"||c=="map"){}else{b.push({name:"取Top",col:"top",value:(a.chartJson.xcol.top?a.chartJson.xcol.top:""),group:"横轴",editor:"numberbox"})}if(c=="scatter"||c=="bubble"){b.push({name:"标题",col:"kpi_name2",value:(a.kpiJson&&a.kpiJson.length>1?a.kpiJson[1].kpi_name:""),group:"横轴",editor:"text"});b.push({name:"单位",col:"unit2",value:(a.kpiJson&&a.kpiJson.length>1?a.kpiJson[1].unit:""),group:"横轴",editor:"text"});b.push({name:"格式化",col:"fmt2",value:(a.kpiJson&&a.kpiJson.length>1?a.kpiJson[1].fmt:""),group:"横轴",editor:{type:"combobox",options:{data:fmtJson}}});b.push({name:"指标比例",col:"rate2",value:(a.kpiJson&&a.kpiJson.length>1?a.kpiJson[1].rate:""),group:"横轴",editor:{type:"combobox",options:{data:kpirate}}})}if(c!="pie"){b.push({name:"标题",col:"kpi_name",value:(a.kpiJson&&a.kpiJson.length>0?a.kpiJson[0].kpi_name:""),group:"纵轴",editor:"text"})}b.push({name:"单位",col:"unit",value:(a.kpiJson&&a.kpiJson.length>0?a.kpiJson[0].unit:""),group:"纵轴",editor:"text"});b.push({name:"格式化",col:"fmt",value:(a.kpiJson&&a.kpiJson.length>0?a.kpiJson[0].fmt:""),group:"纵轴",editor:{type:"combobox",options:{data:fmtJson}}});if(c=="pie"||c=="scatter"||c=="bubble"||c=="map"){}else{b.push({name:"最小值",col:"ymin",value:(a.kpiJson&&a.kpiJson.length>0?a.kpiJson[0].ymin:""),group:"纵轴",editor:"numberbox"})}if(c=="gauge"){b.push({name:"最大值",col:"ymax",value:(a.kpiJson&&a.kpiJson.length>0?a.kpiJson[0].ymax:""),group:"纵轴",editor:"numberbox"})}b.push({name:"指标比例",col:"rate",value:(a.kpiJson&&a.kpiJson.length>0?a.kpiJson[0].rate:""),group:"纵轴",editor:{type:"combobox",options:{data:kpirate}}});if(c=="pie"){b.push({name:"是否显示标签",col:"dataLabel",value:(a.chartJson.dataLabel?a.chartJson.dataLabel:""),group:"图形属性",editor:{type:"checkbox",options:{on:true,off:false}}})}b.push({name:"位置",col:"align",value:(s.align?s.align:"left"),group:"标题样式",editor:{type:"combobox",options:{data:[{value:"left",text:"left"},{value:"center",text:"center"}]}}});b.push({name:"字体大小",col:"fontsize",value:(s.fontsize?s.fontsize:""),group:"标题样式",editor:"numberbox"});b.push({name:"字体颜色",col:"fontcolor",value:(s.fontcolor?s.fontcolor:""),group:"标题样式",editor:{type:"combobox",options:{data:colorJson,formatter:function(d){return'<div style="background-color:'+d.value+'">'+d.text+"</div>"}}}});b.push({name:"是否粗体",col:"fontweight",value:(s.fontweight?s.fontweight:""),group:"标题样式",editor:{type:"checkbox",options:{on:true,off:false}}});b.push({name:"是否斜体",col:"italic",value:(s.italic?s.italic:""),group:"标题样式",editor:{type:"checkbox",options:{on:true,off:false}}});b.push({name:"是否下划线",col:"underscore",value:(s.underscore?s.underscore:""),group:"标题样式",editor:{type:"checkbox",options:{on:true,off:false}}});b.push({name:"背景颜色",col:"bgcolor",value:(s.bgcolor?s.bgcolor:""),group:"标题样式",editor:{type:"combobox",options:{data:colorJson,formatter:function(d){return'<div style="background-color:'+d.value+'">'+d.text+"</div>"}}}});b.push({name:"边框颜色",col:"bordercolor",value:(s.bordercolor?s.bordercolor:""),group:"标题样式",editor:{type:"combobox",options:{data:colorJson,formatter:function(d){return'<div style="background-color:'+d.value+'">'+d.text+"</div>"}}}});b.push({name:"边框大小",col:"bordersize",value:(s.bordersize?s.bordersize:""),group:"标题样式",editor:"numberbox"});b.push({name:"边框类型",col:"bordertype",value:(s.bordertype?s.bordertype:""),group:"标题样式",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}});$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,fitColumns:false,scrollbarSize:0,onAfterEdit:function(p,h,q){var f=h.value;var g=h.col;if(g=="showLegend"||g=="legendLayout"||g=="dataLabel"){if(a.chartJson[g]==undefined){a.chartJson[g]=""}if(a.chartJson[g]==f){return}a.chartJson[g]=f;chartview(a,a.id)}else{if(g=="height"||g=="width"){var l=Highcharts.charts;var m=null;for(i=0;i<l.length;i++){var n=l[i];if($(n.container).parent().attr("id")=="C"+a.id){m=n}}a.chartJson[g]=f;m.setSize(a.chartJson.width,a.chartJson.height);$("#C"+a.id).css({width:a.chartJson.width+"px",height:a.chartJson.height+"px"})}else{if(g=="tickInterval"||g=="routeXaxisLable"||g=="dimdesc"||g=="top"){if(a.chartJson.xcol[g]==undefined){a.chartJson.xcol[g]=""}if(a.chartJson.xcol[g]==f){return}a.chartJson.xcol[g]=f;chartview(a,a.id)}else{if(g=="kpi_name"||g=="unit"||g=="fmt"||g=="ymin"||g=="ymax"||g=="rate"){var e=a.kpiJson[0];if(e[g]==undefined){e[g]=""}if(e[g]==f){return}e[g]=f;chartview(a,a.id)}else{if(g=="kpi_name2"||g=="unit2"||g=="fmt2"||g=="rate2"){var e=a.kpiJson[1];if(e[g]==undefined){e[g]=""}if(g=="kpi_name2"){if(e.kpi_name==f){return}e.kpi_name=f}else{if(g=="unit2"){if(e.unit==f){return}e.unit=f}else{if(g=="fmt2"){if(e.fmt==f){return}e.fmt=f}else{if(g=="rate2"){if(e.rate2==f){return}e.rate2=f}}}}chartview(a,a.id)}else{if(g=="title"){a.name=f;$("#c_"+a.id+" div.ctit").text(f)}else{s[g]=f;var d=$("#c_"+a.id+" div.ctit");if(g=="align"){d.css("text-align",f)}if(g=="fontsize"){d.css("font-size",f+"px")}if(g=="fontcolor"){d.css("color",f)}if(g=="fontweight"){if(f=="true"){d.css("font-weight","bold")}else{d.css("font-weight","inherit")}}if(g=="italic"){if(f=="true"){d.css("font-style","italic")}else{d.css("font-style","inherit")}}if(g=="underscore"){if(f=="true"){d.css("text-decoration","underline")}else{d.css("text-decoration","inherit")}}if(g=="bgcolor"){d.css("background-color",f)}}}}}}}curTmpInfo.isupdate=true},data:b})}function chartmenu(c,f,e,a,b){var d=$(c).offset();curTmpInfo.ckid=f;curTmpInfo.tp=e;curTmpInfo.compId=b;curTmpInfo.dimname=a;if(e=="ycol"||e=="y2col"||e=="y3col"){$("#chartoptmenu").menu("enableItem",$("#m_set"))}else{$("#chartoptmenu").menu("disableItem",$("#m_set"))}$("#chartoptmenu").menu("show",{left:d.left,top:d.top-5})}function delChartKpiOrDim(){var c=curTmpInfo.tp;var b=curTmpInfo.compId;var d=curTmpInfo.ckid;var a=findCompById(b);if(c=="xcol"){a.chartJson.xcol={};$("#chartData #xcol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(a,b)}if(c=="ycol"){a.chartJson.ycol={};if(a.kpiJson.length>1){a.kpiJson[0]=null}else{a.kpiJson=[]}$("#chartData #ycol").html('<span class="charttip">将指标拖到这里</span>')}if(c=="y2col"){if(a.kpiJson.length>1){a.kpiJson[1]=null}else{a.kpiJson=[]}$("#chartData #y2col").html('<span class="charttip">将指标拖到这里</span>')}if(c=="y3col"){a.kpiJson[2]=null;$("#chartData #y3col").html('<span class="charttip">将指标拖到这里</span>')}if(c=="scol"){a.chartJson.scol={};$("#chartData #scol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(a,b)}}function chartsort(d){var c=curTmpInfo.tp;var b=curTmpInfo.compId;var e=curTmpInfo.ckid;var a=findCompById(b);if(c=="xcol"){delete a.kpiJson[0].sort;a.chartJson.xcol.dimord=d}if(c=="ycol"){a.kpiJson[0].sort=d}if(c=="scol"){delete a.kpiJson[0].sort;a.chartJson.scol.dimord=d}curTmpInfo.isupdate=true;chartview(a,b)}function chartfilterDims(){var m=curTmpInfo.tp;var l=curTmpInfo.ckid;var n=curTmpInfo.compId;var b=curTmpInfo.dimname;var g=findCompById(n);var e=null;if(m=="xcol"){e=g.chartJson.xcol}else{if(m=="scol"){e=g.chartJson.scol}else{return kpiFilter("chart")}}$("#pdailog").dialog({title:b+" - 维度筛选",width:280,height:300,closed:false,cache:false,modal:true,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var u=$("#dimfiltertab").tabs("getSelected");var t=$("#dimfiltertab").tabs("getTabIndex",u);if("day"==e.type&&t==0){var r=$("#dimfiltertab #dft2").val();var q=$("#dimfiltertab #dft1").val();if(Number(r.replace(/-/g,""))>Number(q.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}e.startdt=r;e.enddt=q;e.filtertype=1;delete e.vals}else{if("month"==e.type&&t==0){var r=$("#dimfiltertab #dfm2").val();var q=$("#dimfiltertab #dfm1").val();if(Number(r)>Number(q)){msginfo("您选择的开始月份不能大于结束月份。");return}e.startmt=r;e.endmt=q;e.filtertype=1;delete e.vals}else{var v="";var w=$("#pdailog input[name='dimval']:checkbox:checked");w.each(function(y,x){v=v+$(this).val();if(y!=w.size()-1){v=v+","}});e.vals=v;e.filtertype=2;delete e.startmt;delete e.endmt;delete e.startdt;delete e.enddt}}curTmpInfo.isupdate=true;chartview(g,n);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var d=e.type;var c=$("#c_"+n+" #datemodbtn");var o=c.attr("st");var f=c.attr("ed");var p=e;var h=e.filtertype==undefined?"":e.filtertype;var a="../bireport/DimFilter.action?dimType="+d+"&filtertype="+h+"&min="+o+"&max="+f+"&dimId="+l+"&vals="+e.vals;if(d=="month"){a=a+"&dfm2="+(p.startmt==undefined?"":p.startmt);a=a+"&dfm1="+(p.endmt==undefined?"":p.endmt)}if(d=="day"){a=a+"&dft2="+(p.startdt==undefined?"":p.startdt);a=a+"&dft1="+(p.enddt==undefined?"":p.enddt)}$("#pdailog").dialog("refresh",a)}function kpiFilter(g){var e=curTmpInfo.ckid;var d=curTmpInfo.compId;var b=findCompById(d);var f=findKpiById(e,b.kpiJson);var h=f.filter;var c="";if(f.rate==1000){c="千"}else{if(f.rate==10000){c="万"}else{if(f.rate==1000000){c="百万"}else{if(f.rate==100000000){c="亿"}}}}var a="<div style='line-height:25px; margin:5px;'><br/> "+f.kpi_name+' &nbsp; <select id="ftype"><option value=""></option><option value=">" '+(h&&h.filterType==">"?"selected":"")+'>大于</option><option value="<" '+(h&&h.filterType=="<"?"selected":"")+'>小于</option><option value="=" '+(h&&h.filterType=="="?"selected":"")+'>等于</option><option value="between" '+(h&&h.filterType=="between"?"selected":"")+'>区间</option></select> &nbsp; <input type="text" id="startval" size="5" value="'+(h?h.val1:"")+'"><span id="endvalspan" style="display:'+(h&&h.filterType=="between"?"inline":"none")+'"> - <input type="text" id="endval" size="5" value="'+(h?h.val2:"")+'"></span>'+c+f.unit+"<br/>[<a id=\"clear\" href='javascript:;'>清除筛选</a>]</div>";$("#pdailog").dialog({title:"指标筛选",width:330,height:180,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var o=$("#pdailog #ftype").val();var l=$("#pdailog #startval").val();var n=$("#pdailog #endval").val();if(o==""||l==""){delete f.filter}else{var m={kpi:f.kpi_id,filterType:o,val1:Number(l),val2:(n==""?0:Number(n))};f.filter=m}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;if(g=="table"){tableView(b,d)}else{if(g=="chart"){chartview(b,d)}}}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #startval,#pdailog #endval").numberbox();$("#pdailog #ftype").bind("change",function(){var l=$(this);if(l.val()=="between"){$("#pdailog #endvalspan").css("display","inline")}else{$("#pdailog #endvalspan").css("display","none")}});$("#pdailog #clear").bind("click",function(){$("#pdailog #ftype").val("");$("#pdailog #startval").val("");$("#pdailog #endval").val("")})}function setChartKpi(){var g=curTmpInfo.tp;if(g=="xcol"||g=="scol"){return}var c=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var d=curTmpInfo.dimname;var b=findCompById(e);var f=null;if(g=="ycol"){f=b.kpiJson[0]}else{if(g=="y2col"){f=b.kpiJson[1]}else{if(g=="y3col"){f=b.kpiJson[2]}}}var a="<div style='line-height:25px; margin:5px;'>指标名称："+f.kpi_name+"<br>所 属 表： "+b.tname+"<br>指标单位：<select id=\"kpiunit\" name=\"kpiunit\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+f.unit+'<br>格 式 化：<select id="fmt" name="fmt"><option value="###,##0">整数</option><option value="###,##0.0">小数</option><option value="0.00%">百分比</option></select></div>';$("#pdailog").dialog({title:"指标属性",width:280,height:260,closed:false,cache:false,modal:true,content:a,toolbar:null,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){f.fmt=$("#pdailog #fmt").val();f.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;chartview(b,e)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+f.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+f.rate+"']").attr("selected",true)}function findDimById(c,d){var a=null;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=d[b];break}}return a}if($==undefined){$=jQuery}var fmtJson=[{text:"整数",value:"#,###"},{text:"小数(保留一位)",value:"#,###.0"},{text:"小数(保留两位)",value:"#,###.00"},{text:"小数(保留四位)",value:"#,###.0000"},{text:"百分比",value:"#,###.00%"}];var kpirate=[{text:"1",value:"1"},{text:"千",value:"1000"},{text:"万",value:"10000"},{text:"百万",value:"1000000"},{text:"亿",value:"100000000"}];var colorJson=[{text:"无",value:""},{text:"黑色",value:"#000000"},{text:"白色",value:"#FFFFFF"},{text:"红色",value:"#FF0000"},{text:"鲜绿色",value:"#00FF00"},{text:"蓝色",value:"#0000FF"},{text:"黄色",value:"#FFFF00"},{text:"粉红色",value:"#FF00FF"},{text:"青绿色",value:"#00FFFF"},{text:"深红色",value:"#800000"},{text:"绿色",value:"#008000"},{text:"深蓝色",value:"#000080"},{text:"深黄色",value:"#808000"},{text:"紫罗兰",value:"#800080"},{text:"青色",value:"#008080"},{text:"灰－25％",value:"#C0C0C0"},{text:"灰－50％",value:"#808080"},{text:"海螺色",value:"#9999FF"},{text:"梅红色",value:"#993366"},{text:"象牙色",value:"#FFFFCC"},{text:"浅青绿",value:"#CCFFFF"},{text:"深紫色",value:"#660066"},{text:"珊瑚红",value:"#FF8080"},{text:"海蓝色",value:"#0066CC"},{text:"冰蓝",value:"#CCCCFF"},{text:"深蓝色",value:"#000080"},{text:"粉红色",value:"#FF00FF"},{text:"黄色",value:"#FFFF00"},{text:"青绿色",value:"#00FFFF"},{text:"紫罗兰",value:"#800080"},{text:"深红色",value:"#800000"},{text:"青色",value:"#008080"},{text:"蓝色",value:"#0000FF"},{text:"天蓝色",value:"#00CCFF"},{text:"浅青绿",value:"#CCFFFF"},{text:"浅绿色",value:"#CCFFCC"},{text:"浅黄色",value:"#FFFF99"},{text:"淡蓝色",value:"#99CCFF"},{text:"玫瑰红",value:"#FF99CC"},{text:"淡紫色",value:"#CC99FF"},{text:"茶色",value:"#FFCC99"},{text:"浅蓝色",value:"#3366FF"},{text:"水绿色",value:"#33CCCC"},{text:"酸橙色",value:"#99CC00"},{text:"金色",value:"#FFCC00"},{text:"浅橙色",value:"#FF9900"},{text:"橙色",value:"#FF6600"},{text:"蓝－灰",value:"#666699"},{text:"灰－40％",value:"#969696"},{text:"深青",value:"#003366"},{text:"海绿",value:"#339966"},{text:"深绿",value:"#003300"},{text:"橄榄色",value:"#333300"},{text:"褐色",value:"#993300"},{text:"梅红色",value:"#993366"},{text:"靛蓝色",value:"#333399"},{text:"灰－80％",value:"#333333"}];function initparam(){if(pageInfo.params&&pageInfo.params.length>0){$("#p_param div.ptabhelpr").remove();$("#p_param").append("<b>参数： </b>");for(i=0;i<pageInfo.params.length;i++){var a=$("#p_param");var b='<span class="pppp" id="pa_'+pageInfo.params[i].id+'"><span title="筛选" onclick="paramFilter(\''+pageInfo.params[i].id+"', '"+pageInfo.params[i].type+"', '"+pageInfo.params[i].name+'\')" class="text">'+pageInfo.params[i].name+"(";if(pageInfo.params[i].type=="frd"||pageInfo.params[i].type=="year"||pageInfo.params[i].type=="quarter"){b=b+(!pageInfo.params[i].valStrs||pageInfo.params[i].valStrs==""?"无":pageInfo.params[i].valStrs)}else{b=b+pageInfo.params[i].st+" 至 "+pageInfo.params[i].end}b=b+')</span><a class="one_p" title="删除" onclick="deleteParam(\''+pageInfo.params[i].id+'\')" href="javascript:;" style="opacity: 0.6;"> &nbsp; </a></span>';a.append(b)}}$("#p_param").droppable({accept:"#datasettree .tree-node",onDragEnter:function(f,d){var c=$("#datasettree").tree("getNode",d);var g=c.attributes.col_type;if(g==1){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000")}f.cancelBubble=true;f.stopPropagation()},onDragLeave:function(d,c){$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","1px solid #EEE");d.cancelBubble=true;d.stopPropagation()},onDrop:function(h,d){h.cancelBubble=true;h.stopPropagation();$(this).css("border","1px solid #EEE");var c=$("#datasettree").tree("getNode",d);var l=c.attributes.col_type;if(l==1){if(!pageInfo.params){pageInfo.params=[]}if(findParamById(c.attributes.col_id)!=null){msginfo("您已经添加了该参数！");return}var m=c.attributes.col_id;var g={id:m,name:c.text,type:c.attributes.dim_type,colname:c.attributes.alias,tid:c.attributes.tid,valType:c.attributes.valType,tableName:c.attributes.tableName,tableColKey:c.attributes.tableColKey,tableColName:c.attributes.tableColName,dimord:c.attributes.dimord};pageInfo.params.push(g);var f=$(this);f.find("div.ptabhelpr").remove();if(f.find("b").size()==0){f.append("<b>参数： </b>")}f.append('<span class="pppp" id="pa_'+m+'"><span title="筛选" onclick="paramFilter(\''+m+"', '"+c.attributes.dim_type+"','"+c.text+'\')" class="text">'+c.text+'(无)</span><a class="one_p" title="删除" onclick="deleteParam(\''+m+'\')" href="javascript:;" style="opacity: 0.6;"> &nbsp; </a></span>');paramFilter(m,g.type,g.name)}}})}function paramFilter(e,c,b){var d=findParamById(e);$("#pdailog").dialog({title:b+" - 参数值筛选",width:240,height:240,closed:false,cache:false,modal:true,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var g="";var f="";if(d.type=="frd"||d.type=="year"||d.type=="quarter"){var h=$("#pdailog input[name='dimval']:checkbox:checked");h.each(function(m,l){g=g+$(this).val();if(m!=h.size()-1){g=g+","}f=f+$(this).attr("desc");if(m!=h.size()-1){f=f+","}});$("#p_param #pa_"+e+" span.text").text(b+"("+(f==""?"无":f)+")");d.vals=g;d.valStrs=f}else{if(d.type=="month"){d.st=$("#pdailog #dfm2").val();d.end=$("#pdailog #dfm1").val();if(Number(d.st)>Number(d.end)){msginfo("您选择的开始月份不能大于结束月份。");return}$("#p_param #pa_"+e+" span.text").text(b+"("+d.st+" 至 "+d.end+")")}else{if(d.type=="day"){d.st=$("#pdailog #dft2").val();d.end=$("#pdailog #dft1").val();if(Number(d.st.replace(/-/g,""))>Number(d.end.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}$("#p_param #pa_"+e+" span.text").text(b+"("+d.st+" 至 "+d.end+")")}}}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;flushPage()}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var a="../bireport/DimFilter!paramFilter.action?dimType="+c+"&dfm2="+(d.st?d.st:"")+"&dfm1="+(d.end?d.end:"")+"&dft2="+(d.st?d.st:"")+"&dft1="+(d.end?d.end:"")+"&dimId="+e+"&vals="+(!d.vals||d.vals==""?"":d.vals);$("#pdailog").dialog("refresh",a)}function flushPage(){for(var a=0;curTmpInfo.comps&&a<curTmpInfo.comps.length;a++){var b=curTmpInfo.comps[a].type;if(b=="table"){tableView(curTmpInfo.comps[a],curTmpInfo.comps[a].id)}else{if(b=="chart"){chartview(curTmpInfo.comps[a],curTmpInfo.comps[a].id)}}}}function deleteParam(c){$("#p_param #pa_"+c).remove();var a=-1;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var b=pageInfo.params[i];if(b.id==c){a=i;break}}pageInfo.params.splice(a,1);if(pageInfo.params.length==0){$("#p_param").html('<div class="ptabhelpr">拖拽维度到此处作为页面参数</div>')}flushPage()}function insertTable(a){var b={id:newGuid(),name:"表格组件",type:"table"};var c=addComp(b,a,true);$("#layout_"+a).append(c);bindCompEvent(b)}function insertText(d,a,c){$("#pdailog").dialog({title:"请输入文本内容 - 文本组件",width:490,height:240,closed:false,cache:false,modal:true,toolbar:null,content:'<div class="textpanel"><textarea name="txtctx" id="txtctx" cols="84" rows="8"></textarea></div>',buttons:[{text:"确定",handler:function(){if(d=="insert"){var e=$("#txtctx").val();var g={id:newGuid(),type:"text",name:"文本组件",desc:e};var h=addComp(g,a,true);$("#layout_"+a).append(h.replace(/\n/g,"<br>"));bindCompEvent(g)}if(d=="update"){var e=$("#txtctx").val();var f=findCompById(c);f.desc=e;$("#c_"+c+" div.cctx").html(e.replace(/\n/g,"<br>"))}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});if(d=="update"){var b=findCompById(c);$("#txtctx").val(b.desc)}$("#txtctx").focus()}function addComp(d,g,l){var m=d;var c=findLayoutById(g);if(l){if(!c.children){c.children=[]}c.children.push(m);if(!curTmpInfo.comps){curTmpInfo.comps=[]}curTmpInfo.comps.push(m)}var a="";if(m.style){var b=m.style;if(m.style.align&&m.style.align!=""){a=a+"text-align:"+m.style.align+";"}if(m.style.fontsize&&m.style.fontsize!=""){a=a+"font-size:"+m.style.fontsize+"px;"}if(m.style.fontcolor&&m.style.fontcolor!=""){a=a+"color:"+m.style.fontcolor+";"}if(b.fontweight){a=a+"font-weight:bold;"}if(b.italic){a=a+"font-style:italic;"}if(b.underscore){a=a+"text-decoration: underline;"}if(b.bgcolor){a=a+"background-color:"+b.bgcolor+";"}}var h="";if(m.style){var b=m.style;if(m.style.talign&&m.style.talign!=""){h=h+"text-align:"+m.style.talign+";"}if(m.style.tfontsize&&m.style.tfontsize!=""){h=h+"font-size:"+m.style.tfontsize+"px;"}if(m.style.tfontcolor&&m.style.tfontcolor!=""){h=h+"color:"+m.style.tfontcolor+";"}if(b.tfontweight){h=h+"font-weight:bold;"}if(b.titalic){h=h+"font-style:italic;"}if(b.tunderscore){h=h+"text-decoration: underline;"}if(b.tbgcolor){h=h+"background-color:"+b.tbgcolor+";"}}var f='<div class="cbox" id="c_'+m.id+'"><div class="ctitle"><div class="ctit" style="'+a+'">'+m.name+'</div><div class="ticon"><a href="javascript:setComp(\''+g+"', '"+d.id+'\');" class="icon-set cedit" title="设置组件" ></a><a href="javascript:editComp(\''+g+"', '"+d.id+'\');" class="icon-edit cedit" title="编辑组件" ></a><a class="del" href="javascript:deletecomp(\''+g+"', '"+d.id+'\');" title="删除组件" cid="'+m.id+'"></a></div></div><div class="cctx" style="'+h+'">';if(m.type=="text"){f=f+d.desc.replace(/\n/g,"<br>")}else{if(m.type=="table"){var e='<div align="center" class="tipinfo">(点击编辑按钮配置表格的列)</div>';f=f+e}else{if(m.type=="chart"){var e='<div align="center" class="tipinfo">(点击编辑按钮配置图形数据)</div>';f=f+e}}}f=f+"</div></div>";return f}function bindCompEvent(a){$("#c_"+a.id).draggable({revert:true,handle:$("#c_"+a.id+" .ctitle .ctit"),proxy:function(d){var c=$(d).width();var b=$(d).height();var e=$('<div style="border:1px solid #999999;background-color:#cccccc; opacity:0.5; filter:alpha(opacity=50); width:'+c+"px; height:"+b+'px;"></div>');e.appendTo("body");return e},onStartDrag:function(b){},onStopDrag:function(b){}});$("#c_"+a.id).droppable({accept:".cbox",onDragEnter:function(c,b){curTmpInfo.id=$(this).attr("id");curTmpInfo.tp="before";$(".indicator").css({display:"block",left:$(this).offset().left,top:$(this).offset().top-10});c.cancelBubble=true;c.stopPropagation()},onDragLeave:function(f,c){if($(this).hasClass("cbox")){var d=$(this).parent();var b=d.children().last();if(b.attr("id")==$(c).attr("id")){b=b.prev()}if(b.size()==0){$(".indicator").css({display:"block",left:d.offset().left,top:d.offset().top-10})}else{curTmpInfo.id=b.attr("id");curTmpInfo.tp="after";$(".indicator").css({display:"block",left:b.offset().left,top:b.offset().top+b.height()})}}else{$(".indicator").hide()}f.cancelBubble=true;f.stopPropagation()},onDrop:function(c,b){c.cancelBubble=true;c.stopPropagation()}})}function showloading(){var d=jQuery(document);var c=jQuery(window);var b=d.scrollTop()+60;var a=d.scrollLeft()+c.width()-200;$("#Cloading").css({top:b,left:a,display:"block"})}function hideLoading(){$("#Cloading").css("display","none")}function editComp(a,c){$("#Jlayout").layout("remove","east");var b=findCompById(c);if(b.type=="text"){insertText("update",a,c)}else{if(b.type=="table"){editTableData(c)}else{if(b.type=="chart"){editChartData(c)}}}}function setComp(a,c){$("#Jlayout").layout("remove","south");var b=findCompById(c);if(b.type=="text"){setTextProperty(b)}else{if(b.type=="table"){setTableProperty(b)}else{if(b.type=="chart"){setChartProperty(b)}}}}function editTableData(e){if($("#dataProperty").size()==0){$("#Jlayout").layout("add",{region:"south",id:"dataProperty",split:false,collapsible:false,height:120,title:"编辑表格数据",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","south")}}]})}else{$("#Jlayout").layout("panel","south").panel("setTitle","编辑表格数据")}var c=findCompById(e);var g="";for(var d=0;c.tableJson&&c.tableJson.rows&&d<c.tableJson.rows.length;d++){g=g+'<span id="d_'+c.tableJson.rows[d].id+'" class="dimcol"><span class="text">'+c.tableJson.rows[d].dimdesc+'</span><a style="opacity: 0.6;" href="javascript:;" onclick="setRdimInfo(this, '+c.tableJson.rows[d].id+", '"+c.tableJson.rows[d].dimdesc+"','"+e+"')\"> &nbsp; </a></span>"}for(var d=0;c.kpiJson&&d<c.kpiJson.length;d++){g=g+'<span id="k_'+c.kpiJson[d].kpi_id+'" class="col"><span class="text">'+c.kpiJson[d].kpi_name+'</span><a style="opacity: 0.6;" href="javascript:;" onclick="setKpiInfo(this,'+c.kpiJson[d].kpi_id+",'"+e+"');\"> &nbsp; </a></span>"}if(g==""){g='<div class="tipinfo">拖拽维度或指标到此处作为表格的列字段</div>'}else{g='<span id="tabRows"><b>表格字段：</b>'+g+"</span>"}var b="";for(var d=0;c.tableJson&&c.tableJson.cols&&d<c.tableJson.cols.length;d++){var f=c.tableJson.cols[d];b=b+'<span id="d_'+f.id+'" class="dimcol"><span class="text">'+f.dimdesc+'</span><a style="opacity: 0.6;" href="javascript:;" onclick="setCdimInfo(this, '+f.id+", '"+f.dimdesc+"','"+e+"')\"> &nbsp; </a></span>"}if(b!=""){b='<span id="tabCols"> &nbsp; &nbsp; <b>列字段：</b>'+b+"</span>"}var a='<div style="margin:10px;"><div class="tableDatasty" id="tableData">'+g+b+"</div></div>";$("#dataProperty").html(a);$("#tableData").droppable({accept:"#datasettree .tree-node",onDragEnter:function(m,l){var h=$("#datasettree").tree("getNode",l);var n=h.attributes.col_type;$(l).draggable("proxy").find("span").removeClass("tree-dnd-no");$(l).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#tableData").css("border","1px solid #ff0000");m.cancelBubble=true;m.stopPropagation()},onDragLeave:function(l,h){$(h).draggable("proxy").find("span").addClass("tree-dnd-no");$(h).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#tableData").css("border","1px dotted #666");l.cancelBubble=true;l.stopPropagation()},onDrop:function(o,m){var q=e;var h=findCompById(q);o.cancelBubble=true;o.stopPropagation();$("#tableData").css("border","1px dotted #666");var l=$("#datasettree").tree("getNode",m);if(h.tid!=undefined){if(h.tid!=l.attributes.tid){msginfo("您拖入的"+(l.attributes.col_type==2?"指标":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}if(l.attributes.calc_kpi==1){if(!isExistDateDim(h,"table")){msginfo("您拖入的指标需要表格中先有时间类型的维度(年/季度/月/日)。");return}}h.tid=l.attributes.tid;h.tname=l.attributes.tname;h.ttype=l.attributes.ttype;if(h.kpiJson==undefined){h.kpiJson=[]}if(h.tableJson==undefined){h.tableJson={cols:[],rows:[]}}if(l.attributes.col_type==2){if(!kpiExist(l.attributes.col_id,h.kpiJson)){h.kpiJson.push({kpi_id:l.attributes.col_id,kpi_name:l.text,col_name:l.attributes.col_name,aggre:l.attributes.aggre,fmt:l.attributes.fmt,alias:l.attributes.alias,tid:h.tid,unit:l.attributes.unit,rate:l.attributes.rate})}else{msginfo("指标已经存在。");return}var p='<span id="k_'+l.attributes.col_id+'" class="col"><span class="text">'+l.text+'</span><a style="opacity: 0.6;" href="javascript:;" onclick="setKpiInfo(this,'+l.attributes.col_id+",'"+h.id+"');\"> &nbsp; </a></span>";var n=$("#tableData");if(n.find("#tabRows").size()==0){n.html('<span id="tabRows"><b>表格字段：</b>'+p+"</span>")}else{if($("#tableData #tabRows").find("span.col").size()==0){$("#tableData #tabRows").append(p)}else{$("#tableData #tabRows").find("span.col").last().after(p)}}curTmpInfo.isupdate=true;tableView(h,q)}if(l.attributes.col_type==1){if(!dimExist(l.attributes.col_id,h.tableJson.rows)&&!dimExist(l.attributes.col_id,h.tableJson.cols)){h.tableJson.rows.push({id:l.attributes.col_id,dimdesc:l.text,type:l.attributes.dim_type,colname:l.attributes.alias,tid:h.tid,iscas:l.attributes.iscas,tableName:l.attributes.tableName,tableColKey:l.attributes.tableColKey,tableColName:l.attributes.tableColName,dimord:l.attributes.dimord,dim_name:l.attributes.dim_name,grouptype:l.attributes.grouptype,valType:l.attributes.valType})}else{msginfo("维度已经存在。");return}var p='<span id="d_'+l.attributes.col_id+'" class="dimcol"><span class="text">'+l.text+'</span><a style="opacity: 0.6;" href="javascript:;" onclick="setRdimInfo(this, '+l.attributes.col_id+", '"+l.text+"','"+h.id+"')\"> &nbsp; </a></span>";var n=$("#tableData");if(n.find("#tabRows").size()==0){n.html('<span id="tabRows"><b>表格字段：</b>'+p+"</span>")}else{if($("#tableData #tabRows").find("span.dimcol").size()==0){$("#tableData #tabRows").find("b").after(p)}else{$("#tableData #tabRows").find("span.dimcol").last().after(p)}}curTmpInfo.isupdate=true;tableView(h,q)}}})}function delJsonKpiOrDim(e){var a=curTmpInfo.ckid;var l=curTmpInfo.compId;var c=findCompById(l);var d=curTmpInfo.pos;if(e=="kpi"){var h=c.kpiJson;var g=-1;for(var b=0;b<h.length;b++){if(h[b].kpi_id==a){g=b;break}}h.splice(g,1);$("#tableData #k_"+a).remove()}if(e=="dim"){var f=null;if(d=="col"){f=c.tableJson.cols}else{f=c.tableJson.rows}var g=-1;for(var b=0;b<f.length;b++){if(f[b].id==a){g=b;break}}f.splice(g,1);$("#tableData #d_"+a).remove();if(d=="col"){if(f.length==0){$("#tableData #tabCols").remove()}}else{if(d=="row"){if(f.length==0){}}}}curTmpInfo.isupdate=true;tableView(c,l)}function setTableProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:200,title:"表格属性配置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","表格属性配置")}if(!a.style){a.style={}}var b=a.style;$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,fitColumns:false,onAfterEdit:function(h,f,e){var g=f.value;var d=f.col;if(d=="name"){a.name=g;$("#c_"+a.id+" div.ctit").text(g)}else{if(d=="showtitle"){a.showtitle=g}else{b[d]=g;var c=$("#c_"+a.id+" div.ctit");if(d=="align"){c.css("text-align",g)}if(d=="fontsize"){c.css("font-size",g+"px")}if(d=="fontcolor"){c.css("color",g)}if(d=="fontweight"){if(g=="true"){c.css("font-weight","bold")}else{c.css("font-weight","inherit")}}if(d=="italic"){if(g=="true"){c.css("font-style","italic")}else{c.css("font-style","inherit")}}if(d=="underscore"){if(g=="true"){c.css("text-decoration","underline")}else{c.css("text-decoration","inherit")}}if(d=="bgcolor"){if(g==""){c.css("background-color","inherit")}else{c.css("background-color",g)}}}}},data:[{name:"表格标题",col:"name",value:(a.name?a.name:""),group:"表格属性",editor:"text"},{name:"是否显示标题",col:"showtitle",value:(a.showtitle?a.showtitle:"true"),group:"表格属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"事件",col:"compevent",value:"<a href=\"javascript:compevent('"+a.id+"');\">设置</a>",group:"表格属性"},{name:"位置",col:"align",value:(b.align?b.align:"left"),group:"标题样式",editor:{type:"combobox",options:{data:[{value:"left",text:"left"},{value:"center",text:"center"}]}}},{name:"字体大小",col:"fontsize",value:(b.fontsize?b.fontsize:""),group:"标题样式",editor:"numberbox"},{name:"字体颜色",col:"fontcolor",value:(b.fontcolor?b.fontcolor:""),group:"标题样式",editor:{type:"combobox",options:{data:colorJson,formatter:function(c){return'<div style="background-color:'+c.value+'">'+c.text+"</div>"}}}},{name:"是否粗体",col:"fontweight",value:(b.fontweight?b.fontweight:""),group:"标题样式",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否斜体",col:"italic",value:(b.italic?b.italic:""),group:"标题样式",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否下划线",col:"underscore",value:(b.underscore?b.underscore:""),group:"标题样式",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"背景颜色",col:"bgcolor",value:(b.bgcolor?b.bgcolor:""),group:"标题样式",editor:{type:"combobox",options:{data:colorJson,formatter:function(c){return'<div style="background-color:'+c.value+'">'+c.text+"</div>"}}}},{name:"边框颜色",col:"bordercolor",value:(b.bordercolor?b.bordercolor:""),group:"标题边框",editor:{type:"combobox",options:{data:colorJson,formatter:function(c){return'<div style="background-color:'+c.value+'">'+c.text+"</div>"}}}},{name:"边框大小",col:"bordersize",value:(b.bordersize?b.bordersize:""),group:"标题边框",editor:"numberbox"},{name:"边框类型",col:"bordertype",value:(b.bordertype?b.bordertype:""),group:"标题边框",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}},{name:"边框颜色",col:"tbordercolor",value:(b.tbordercolor?b.tbordercolor:""),group:"表格边框",editor:{type:"combobox",options:{data:colorJson,formatter:function(c){return'<div style="background-color:'+c.value+'">'+c.text+"</div>"}}}},{name:"边框大小",col:"tbordersize",value:(b.tbordersize?b.tbordersize:""),group:"表格边框",editor:"numberbox"},{name:"边框类型",col:"tbordertype",value:(b.tbordertype?b.tbordertype:""),group:"表格边框",editor:{type:"combobox",options:{data:[{text:"实线",value:"solid"},{text:"虚线",value:"dotted"}]}}},{name:"内边距(padding)",col:"padding",value:(b.padding?b.padding:""),group:"表格边框",editor:"numberbox"},{name:"外边距(margin)",col:"margin",value:(b.margin?b.margin:""),group:"表格边框",editor:"numberbox"}]})}function setTextProperty(a){if($("#compSet").size()==0){$("#Jlayout").layout("add",{region:"east",split:false,width:200,title:"文本属性配置",collapsible:false,id:"compSet",tools:[{iconCls:"icon-cancel",handler:function(){$("#Jlayout").layout("remove","east")}}]})}else{$("#Jlayout").layout("panel","east").panel("setTitle","文本属性配置")}if(!a.style){a.style={}}s=a.style;$("#compSet").propertygrid({showGroup:true,border:false,showHeader:false,scrollbarSize:0,fitColumns:false,onAfterEdit:function(g,d,c){var f=d.value;var b=d.col;if(f){if(b=="name"){a.name=f;$("#c_"+a.id+" div.ctit").text(f)}else{if(b=="showtitle"){a.showtitle=f}else{a.style[b]=f;var e=$("#c_"+a.id+" .cctx");if(b=="tfontsize"){e.css("font-size",f+"px")}else{if(b=="talign"){e.css("text-align",f)}else{if(b=="tfontcolor"){e.css("color",f)}else{if(b=="tfontweight"){if(f=="true"){e.css("font-weight","bold")}else{e.css("font-weight","normal")}}else{if(b=="titalic"){if(f=="true"){e.css("font-style","italic")}else{e.css("font-style","normal")}}else{if(b=="tunderscore"){if(f=="true"){e.css("text-decoration","underline")}else{e.css("text-decoration","inherit")}}else{if(b=="tbgcolor"){if(f==""){e.css("background-color","inherit")}else{e.css("background-color",f)}}else{if(b=="tlineheight"){e.css("line-height",f+"px")}}}}}}}}}}}},data:[{name:"是否显示标题",col:"showtitle",value:(a.showtitle?a.showtitle:"true"),group:"文本属性",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"标题",col:"name",value:(a.name?a.name:""),group:"文本属性",editor:"text"},{name:"位置",col:"talign",value:(s.talign?s.talign:""),group:"文本属性",editor:{type:"combobox",options:{data:[{value:"left",text:"left"},{value:"center",text:"center"},{value:"right",text:"right"}]}}},{name:"背景颜色",col:"tbgcolor",value:(s.tbgcolor?s.tbgcolor:""),group:"文本属性",editor:{type:"combobox",options:{data:colorJson,formatter:function(b){return'<div style="background-color:'+b.value+'">'+b.text+"</div>"}}}},{name:"行高(lineHeight)",col:"tlineheight",value:(s.tlineheight?s.tlineheight:""),group:"文本属性",editor:"numberbox"},{name:"字体大小",col:"tfontsize",value:(s.tfontsize?s.tfontsize:""),group:"文本字体",editor:"numberbox"},{name:"字体颜色",col:"tfontcolor",value:(s.tfontcolor?s.tfontcolor:""),group:"文本字体",editor:{type:"combobox",options:{data:colorJson,formatter:function(b){return'<div style="background-color:'+b.value+'">'+b.text+"</div>"}}}},{name:"是否粗体",col:"tfontweight",value:(s.tfontweight?s.tfontweight:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否斜体",col:"titalic",value:(s.titalic?s.titalic:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}},{name:"是否下划线",col:"tunderscore",value:(s.tunderscore?s.tunderscore:""),group:"文本字体",editor:{type:"checkbox",options:{on:true,off:false}}}]})}function tableView(c,b){if(c.tableJson==undefined||c.kpiJson==undefined){return}if(c.kpiJson.length==0&&c.tableJson.cols.length==0&&c.tableJson.rows.length==0){$("#T"+b+" div.ctx").html('<div align="center" class="tipinfo">(点击编辑按钮配置表格的列)</div>');return}var a=JSON.stringify(c.tableJson);var e="[]";if(pageInfo.params&&pageInfo.params.length>0){e=JSON.stringify(pageInfo.params)}var d=JSON.stringify(c.kpiJson);var f=c.ttype;showloading();$.ajax({type:"POST",url:"TableView.action",dataType:"html",data:{tableJson:a,kpiJson:d,kpiType:f,compId:b,params:e},success:function(g){hideLoading();$("#c_"+b+" div.cctx").html(g)},error:function(g){hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function dimsort(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId;var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.tableJson.cols}else{f=a.tableJson.rows}for(var d=0;d<f.length;d++){if(f[d].id==b){f[d].dimord=g;break}}for(d=0;d<a.kpiJson.length;d++){a.kpiJson[d].sort=""}curTmpInfo.isupdate=true;tableView(a,e)}function kpisort(d){var c=curTmpInfo.ckid;var b=curTmpInfo.compId;var a=findCompById(b);for(i=0;i<a.kpiJson.length;i++){if(a.kpiJson[i].kpi_id==c){a.kpiJson[i].sort=d}else{a.kpiJson[i].sort=""}}curTmpInfo.isupdate=true;tableView(a,b)}function aggreDim(){var b=curTmpInfo.ckid;var e=curTmpInfo.compId;var g=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(g=="col"){f=a.tableJson.cols}else{f=a.tableJson.rows}for(var d=0;d<f.length;d++){if(f[d].id==b){if(f[d].issum=="y"){f[d].issum="n"}else{f[d].issum="y"}}}curTmpInfo.isupdate=true;tableView(a,e)}function filterDims(){var n=curTmpInfo.ckid;var p=curTmpInfo.compId;var l=curTmpInfo.pos;var b=curTmpInfo.dimname;var g=findCompById(p);var o=null;if(l=="col"){o=g.tableJson.cols}else{o=g.tableJson.rows}$("#pdailog").dialog({title:b+" - 维度筛选",width:280,height:300,closed:false,cache:false,modal:true,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){var A=null;for(var w=0;w<o.length;w++){if(o[w].id==n){A=o[w];break}}var x=$("#dimfiltertab").tabs("getSelected");var v=$("#dimfiltertab").tabs("getTabIndex",x);if("day"==A.type&&v==0){var u=$("#dimfiltertab #dft2").val();var t=$("#dimfiltertab #dft1").val();if(Number(u.replace(/-/g,""))>Number(t.replace(/-/g,""))){msginfo("您选择的开始日期不能大于结束日期。");return}A.startdt=u;A.enddt=t;A.filtertype=1;delete A.vals}else{if("month"==A.type&&v==0){var u=$("#dimfiltertab #dfm2").val();var t=$("#dimfiltertab #dfm1").val();if(Number(u)>Number(t)){msginfo("您选择的开始月份不能大于结束月份。");return}A.startmt=u;A.endmt=t;A.filtertype=1;delete A.vals}else{var y="";var z=$("#pdailog input[name='dimval']:checkbox:checked");z.each(function(C,B){y=y+$(this).val();if(C!=z.size()-1){y=y+","}});A.vals=y;A.filtertype=2;delete A.startmt;delete A.endmt;delete A.startdt;delete A.enddt}}curTmpInfo.isupdate=true;tableView(g,p);$("#pdailog").dialog("close")}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});var m="";var d="";var h="";var r=null;for(var e=0;e<o.length;e++){if(o[e].id==n){m=o[e].vals;d=o[e].type;h=o[e].filtertype==undefined?"":o[e].filtertype;r=o[e];break}}var c=$("#c_"+p+" #datemodbtn");var q=c.attr("st");var f=c.attr("ed");var a="../bireport/DimFilter.action?dimType="+d+"&filtertype="+h+"&min="+q+"&max="+f+"&dimId="+n+"&vals="+m;if(d=="month"){a=a+"&dfm2="+(r.startmt==undefined?"":r.startmt);a=a+"&dfm1="+(r.endmt==undefined?"":r.endmt)}if(d=="day"){a=a+"&dft2="+(r.startdt==undefined?"":r.startdt);a=a+"&dft1="+(r.enddt==undefined?"":r.enddt)}$("#pdailog").dialog("refresh",a)}function dimkpimove(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId;var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.tableJson.cols}else{if(h=="row"){f=a.tableJson.rows}else{if(h=="kpi"){f=a.kpiJson}}}if(f.length<=1){msginfo("无效移动。");return}for(var d=0;d<f.length;d++){if((h=="kpi"?f[d].kpi_id:f[d].id)==b){if(g=="left"){if(d<=0){msginfo("无效移动。");return}else{var g=f[d-1];f[d-1]=f[d];f[d]=g;$("#tableData #"+(h=="kpi"?"k":"d")+"_"+b).prev().before($("#tableData #"+(h=="kpi"?"k":"d")+"_"+b));curTmpInfo.isupdate=true;tableView(a,e);return}}else{if(g=="right"){if(d>=f.length-1){msginfo("无效移动。");return}else{var g=f[d+1];f[d+1]=f[d];f[d]=g;$("#tableData #"+(h=="kpi"?"k":"d")+"_"+b).next().after($("#tableData #"+(h=="kpi"?"k":"d")+"_"+b));curTmpInfo.isupdate=true;tableView(a,e);return}}}break}}}function dimexchange(){var h=curTmpInfo.ckid;var n=curTmpInfo.compId;var g=curTmpInfo.pos;var a=curTmpInfo.dimname;var e=findCompById(n);if(g=="col"){var m=0;var d=null;var l=e.tableJson.cols;for(var c=0;c<l.length;c++){if(l[c].id==h){m=c;d=l[c];break}}e.tableJson.cols.splice(m,1);e.tableJson.rows.push(d);$("#tableData #d_"+h).remove();var b='<span id="d_'+d.id+'" class="dimcol"><span class="text">'+d.dimdesc+'</span><a style="opacity: 0.6;" href="javascript:;" onclick="setRdimInfo(this, '+d.id+", '"+d.dimdesc+"','"+n+"')\"> &nbsp; </a></span>";if($("#tableData #tabRows span.dimcol").size()>0){$("#tableData #tabRows span.dimcol").last().after(b)}else{$("#tableData #tabRows b").after(b)}if(e.tableJson.cols.length==0){$("#tableData #tabCols").remove()}}if(g=="row"){var m=0;var d=null;var l=e.tableJson.rows;for(var c=0;c<l.length;c++){if(l[c].id==h){m=c;d=l[c];break}}e.tableJson.rows.splice(m,1);e.tableJson.cols.push(d);$("#tableData #d_"+h).remove();var f=e.tableJson.cols;if(f.length==1){$("#tableData").append('<span id="tabCols"> &nbsp; &nbsp; <b>列字段：</b></span>')}$("#tableData #tabCols").append('<span id="d_'+d.id+'" class="dimcol"><span class="text">'+d.dimdesc+'</span><a style="opacity: 0.6;" href="javascript:;" onclick="setCdimInfo(this, '+d.id+", '"+d.dimdesc+"','"+n+"')\"> &nbsp; </a></span>")}curTmpInfo.isupdate=true;tableView(e,n)}function kpiproperty(){var d=curTmpInfo.ckid;var c=curTmpInfo.compId;var b=findCompById(c);var e=findKpiById(d,b.kpiJson);var a="<div style='line-height:25px; margin:5px;'>指标名称："+e.kpi_name+"<br>所 属 表： "+b.tname+"<br>指标单位：<select id=\"kpiunit\" name=\"kpiunit\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+e.unit+'<br>格 式 化：<select id="fmt" name="fmt"><option value="###,##0">整数</option><option value="###,##0.0">小数</option><option value="0.00%">百分比</option></select> <br> 聚合方式：<select id="aggreType" name="aggreType" ><option value="sum">求和</option><option value="avg">求平均</option><option value="max">最大值</option><option value="min">最小值</option></select><br/><font color=\'#CCCCCC\'>(只有在维度上添加聚合项后，该内容才起效果。)</font></div>';$("#pdailog").dialog({title:"指标属性",width:280,height:260,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",iconCls:"icon-ok",handler:function(){e.fmt=$("#pdailog #fmt").val();e.aggre=$("#pdailog #aggreType").val();e.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;tableView(b,c)}},{text:"取消",iconCls:"icon-cancel",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+e.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+e.rate+"']").attr("selected",true);$("#pdailog #aggreType").find("option[value='"+e.aggre+"']").attr("selected",true)}function setKpiInfo(c,f,b){var e=$(c).offset();curTmpInfo.ckid=f;curTmpInfo.compId=b;curTmpInfo.pos="kpi";var a=findCompById(b);var d=findKpiById(f,a.kpiJson);if(d.sort=="asc"){$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-ok"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{if(d.sort=="desc"){$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-ok"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#kpioptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-ok"})}}$("#kpioptmenu").menu("show",{left:e.left,top:e.top-5})}function setCdimInfo(h,b,a,m){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=m;curTmpInfo.pos="col";curTmpInfo.dimname=a;var f=false;var g=findCompById(m);var l=g.tableJson.cols;for(var e=0;e<l.length;e++){if(l[e].id==b){if(l[e].issum=="y"){f=true;break}}}if(f){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合..."})}var c=$("#dimoptmenu").menu("getItem",$("#m_moveto"));$("#dimoptmenu").menu("setText",{target:c.target,text:"移至行字段"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top-5})}function setRdimInfo(h,b,a,m){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=m;curTmpInfo.pos="row";curTmpInfo.dimname=a;var f=false;var g=findCompById(m);var l=g.tableJson.rows;for(var e=0;e<l.length;e++){if(l[e].id==b){if(l[e].issum=="y"){f=true;break}}}if(f){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合"})}$("#dimoptmenu").menu("setText",{target:$("#m_moveto"),text:"移至列字段"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top-5})}function isExistDateDim(a,d){var b=false;if(d=="table"){if(!a.tableJson||!a.tableJson.cols){return b}for(var c=0;c<a.tableJson.cols.length;c++){if(a.tableJson.cols[c].grouptype=="date"){b=true;break}}if(!a.tableJson||!a.tableJson.rows){return b}for(var c=0;c<a.tableJson.rows.length;c++){if(a.tableJson.rows[c].grouptype=="date"){b=true;break}}}if(d=="chart"){if(!a.chartJson||!a.chartJson.params){return b}for(var c=0;c<a.chartJson.params.length;c++){if(a.chartJson.params[c].grouptype=="date"){b=true;break}}if(!a.chartJson||!a.chartJson.xcol){return b}if(a.chartJson.xcol.grouptype=="date"){b=true}}return b}function kpiExist(d,c){var a=false;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=true;break}}return a}function dimExist(c,d){var a=false;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=true;break}}return a}function deletecomp(b,e){var f=findLayoutById(b);var c=-1;for(var d=0;d<f.children.length;d++){if(f.children[d].id==e){c=d;break}}f.children.splice(c,1);var a=findCompById(e,true);curTmpInfo.comps.splice(a,1);$("#c_"+e).remove();$("#Jlayout").layout("remove","south");$("#Jlayout").layout("remove","east");curTmpInfo.isupdate=true}function findCompById(e,b){var a=-1;var c=null;for(var d=0;curTmpInfo.comps&&d<curTmpInfo.comps.length;d++){if(curTmpInfo.comps[d].id==e){c=curTmpInfo.comps[d];a=d;break}}if(b&&b==true){return a}else{return c}}function findParamById(a){var b=null;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var c=pageInfo.params[i];if(c.id==a){b=c;break}}return b}function findKpiById(d,c){var a=null;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=c[b];break}}return a}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a};